import{s as q}from"./useAppearance-DRazjLJ1.js";import{r as n,x as Be,G as De,aI as v,J as Re,l as x}from"./vendor-H8yUxHVJ.js";import{r as he}from"./useWordBalance-C1hXK7OD.js";const Ne={userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100};class He{scrollContainer=null;isUserScrolling=!1;userScrollTimeout=null;isEnabled=!0;isDestroyed=!1;config;wasAtBottom=!0;rafId=null;handleWheel;handleTouchStart;handleTouchMove;handleScroll;handleKeydown;constructor(o={}){this.config={...Ne,...o},this.handleWheel=this.onUserScroll.bind(this),this.handleTouchStart=this.onUserScroll.bind(this),this.handleTouchMove=this.onUserScroll.bind(this),this.handleScroll=this.onScroll.bind(this),this.handleKeydown=this.onKeydown.bind(this)}attach(o){this.isDestroyed||(this.detach(),this.scrollContainer=o,this.setupEventListeners(),this.wasAtBottom=this.isAtBottom())}detach(){this.scrollContainer&&(this.scrollContainer.removeEventListener("wheel",this.handleWheel),this.scrollContainer.removeEventListener("touchstart",this.handleTouchStart),this.scrollContainer.removeEventListener("touchmove",this.handleTouchMove),this.scrollContainer.removeEventListener("scroll",this.handleScroll),this.scrollContainer.removeEventListener("keydown",this.handleKeydown)),this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.scrollContainer=null}setupEventListeners(){this.scrollContainer&&(this.scrollContainer.addEventListener("wheel",this.handleWheel,{passive:!0}),this.scrollContainer.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.scrollContainer.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.scrollContainer.addEventListener("scroll",this.handleScroll,{passive:!0}),this.scrollContainer.addEventListener("keydown",this.handleKeydown))}onUserScroll(){this.isEnabled&&(this.isUserScrolling=!0,this.userScrollTimeout&&clearTimeout(this.userScrollTimeout),this.userScrollTimeout=setTimeout(()=>{this.isUserScrolling=!1,this.isAtBottom()&&(this.wasAtBottom=!0)},this.config.userScrollTimeout))}onScroll(){this.wasAtBottom=this.isAtBottom()}onKeydown(o){["ArrowUp","ArrowDown","PageUp","PageDown","Home","End"].includes(o.key)&&this.onUserScroll()}isAtBottom(){if(!this.scrollContainer)return!0;const{scrollTop:o,scrollHeight:y,clientHeight:C}=this.scrollContainer;return y-o-C<=this.config.bottomThreshold}scrollToBottom(){!this.scrollContainer||!this.isEnabled||this.isDestroyed||this.isUserScrolling||!this.wasAtBottom||(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{if(this.rafId=null,!this.scrollContainer||this.isDestroyed)return;const o=this.scrollContainer.scrollHeight-this.scrollContainer.clientHeight;this.config.scrollBehavior==="instant"?this.scrollContainer.scrollTop=o:this.scrollContainer.scrollTo({top:o,behavior:"smooth"}),this.wasAtBottom=!0}))}forceScrollToBottom(){!this.scrollContainer||this.isDestroyed||(this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.scrollToBottom())}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isAutoScrollActive(){return this.isEnabled&&!this.isUserScrolling&&this.wasAtBottom}isUserScrollingNow(){return this.isUserScrolling}reset(){this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null)}destroy(){this.isDestroyed=!0,this.detach()}}function Oe(s={}){const o=new He(s),y=n(!0),C=n(!1);let E=null;function T(l){l?(o.attach(l),w()):(o.detach(),G())}function B(l){De(l,i=>{T(i)},{immediate:!0})}function w(){G(),E=setInterval(()=>{y.value=o.isAutoScrollActive(),C.value=o.isUserScrollingNow()},100)}function G(){E&&(clearInterval(E),E=null)}function L(){o.scrollToBottom()}function O(){o.forceScrollToBottom()}function W(){o.enable()}function ee(){o.disable()}function h(){o.reset(),y.value=!0,C.value=!1}return Be(()=>{G(),o.destroy()}),{attach:T,attachRef:B,scrollToBottom:L,forceScrollToBottom:O,enable:W,disable:ee,reset:h,isAutoScrollActive:y,isUserScrolling:C}}function rt({props:s,chapterContent:o,targetWordCount:y,estimates:C,ensureBalance:E,save:T,triggerAutoSave:B,calculateWritingStats:w,countWords:G,selectedText:L,richTextEditor:O,richTextEditorFullscreen:W,isNativeFullscreen:ee}){const h=n(!1),l=n(""),i=n(0),d=n(""),$=n(0),g=n(0),S=n(""),U=n(0),te=n(""),oe=n([]),K=n(!1),se=n(!1),z=n(!1),F=n(!1),D=n(!1),X=n(!1),re=n(0),r=n([]),R=10,I=n(!1),j=n(null),N=n(!1),J=n(""),Y=n(""),me=n(0),we=n(0),Se=n(null),ye=n([]),Ce=n([]),Te=n(null),H=n(null),_=n(0),ie=3,ce=n(2e3),Q=n(!1),ae=n(null),Ie=n("progressive"),u=n(null),be=n(),A=n(null),{attach:Ee,scrollToBottom:Me,forceScrollToBottom:Ge,reset:Ae,isAutoScrollActive:Ue,isUserScrolling:Fe}=Oe({userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100}),xe=()=>{const t=document.querySelector("[data-editor-scroll-container]");if(t){const a=t.querySelector("[data-radix-scroll-area-viewport]");if(a)return console.log("ðŸ“œ Found Radix viewport inside marked container"),a;if(t.classList.contains("overflow-y-auto")||getComputedStyle(t).overflowY==="auto"||getComputedStyle(t).overflowY==="scroll")return console.log("ðŸ“œ Using marked container directly (has overflow)"),t}const e=document.querySelector("main");if(e){const a=e.querySelector("[data-radix-scroll-area-viewport]");if(a)return console.log("ðŸ“œ Found Radix viewport in main"),a}if(ee.value){const a=be.value;if(a){const f=a.$el||a,k=f?.querySelector("[data-radix-scroll-area-viewport]")||f?.querySelector("[data-viewport]")||f?.querySelector('[role="region"]');if(k)return console.log("ðŸ“œ Found viewport in fullscreen ref"),k}const c=document.querySelector("[data-editor-scroll-container].overflow-y-auto");if(c)return console.log("ðŸ“œ Found fullscreen scroll container"),c}const p=[".custom-scrollbar.overflow-y-auto","main .overflow-y-auto"];for(const a of p){const c=document.querySelector(a);if(c&&c.scrollHeight>c.clientHeight)return console.log("ðŸ“œ Found container via selector:",a),c}if(e){const a=e.querySelectorAll("div");for(const c of a)if(c.scrollHeight>c.clientHeight&&c.classList.contains("overflow-y-auto"))return console.log("ðŸ“œ Found fallback scrollable div"),c}return null},ke=()=>{Re(()=>{A.value=xe(),A.value?(Ee(A.value),console.log("ðŸ“œ Auto-scroll initialized on container:",A.value.className||A.value.tagName)):console.warn("ðŸ“œ No scroll container found for auto-scroll")})},ue=()=>{!h.value&&!F.value||Re(()=>{(!A.value||!A.value.isConnected)&&(A.value=xe()),requestAnimationFrame(()=>{A.value&&A.value.isConnected&&(A.value.scrollTop=A.value.scrollHeight)})})},$e=async()=>{if(!navigator.onLine)return v.error("No Internet Connection",{description:"Please check your internet connection and try again."}),!1;const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(t){const e=t.effectiveType;(e==="slow-2g"||e==="2g")&&v.warning("Slow Connection Detected",{description:"Your connection is slow. Content will be auto-saved during generation.",duration:4e3})}try{const e=new AbortController,p=setTimeout(()=>e.abort(),5e3),a=performance.now();await fetch(q("api.ping"),{method:"HEAD",cache:"no-cache",signal:e.signal}),clearTimeout(p);const c=performance.now()-a;console.log("ðŸ“¡ Server latency:",c.toFixed(0),"ms"),c>2e3&&v.info("Connection is slow",{description:"Content will be auto-saved during generation to prevent data loss.",duration:3e3})}catch(e){console.warn("Connection check ping failed:",e),v.info("Connection check skipped",{description:"Content will be auto-saved during generation.",duration:2e3})}return!0},fe=t=>{const e=o.value;e&&(r.value.length>0&&r.value[r.value.length-1].content===e||(r.value.push({content:e,action:t,timestamp:Date.now()}),r.value.length>R&&r.value.shift(),I.value=r.value.length>0))},Le=()=>{if(r.value.length===0)return v.error("Nothing to undo"),!1;const t=r.value.pop();return t?(j.value=o.value,o.value=t.content,I.value=r.value.length>0,v.success("Undone",{description:`Reverted "${t.action}" action`,action:{label:"Redo",onClick:()=>{j.value&&(fe("Redo"),o.value=j.value,j.value=null)}}}),!0):!1},je=()=>{r.value=[],I.value=!1,j.value=null},qe=async()=>new Promise(t=>{let e=0;const p=120,a=async()=>{try{const f=await(await fetch(q("api.projects.paper-collection.status",{project:s.project.slug}))).json();if(f.success&&f.data){Te.value=f.data;const k=f.data.status,b=f.data.papers_count||f.data.count||0,m=f.data.message,Z=f.data.percentage||0,P=f.data.current_source,M=f.data.sources_completed||[],ne=f.data.papers_preview||[];if(me.value=b,we.value=Z,Se.value=P,ye.value=M,Ce.value=ne,k==="completed"){Y.value="Complete",J.value=`âœ“ Collected ${b} verified sources from ${M.length} databases`,i.value=50,N.value=!1,H.value&&clearInterval(H.value),t(!0);return}else if(["collecting_papers","initializing","processing","storing"].includes(k)){let de="";P&&(de={semantic_scholar:"Semantic Scholar",openalex:"OpenAlex",arxiv:"arXiv",crossref:"CrossRef",pubmed:"PubMed"}[P]||P),Y.value=de||"Collecting Sources",J.value=m||"Collecting sources from academic databases...",i.value=Math.min(5+Z*.4,45)}else if(k==="collection_failed"){Y.value="Error",J.value=m||"âŒ Source collection failed",N.value=!1,H.value&&clearInterval(H.value),t(!1);return}}e++,e>=p&&(Y.value="Timeout",J.value="â±ï¸ Source collection timed out",N.value=!1,H.value&&clearInterval(H.value),t(!1))}catch(c){console.error("Error checking paper collection status:",c),e++}};a(),H.value=setInterval(a,5e3)}),_e=async()=>{N.value=!0,Y.value="Starting",J.value="Initializing source collection...",i.value=5;try{const t=document.querySelector('meta[name="csrf-token"]')?.content;if(!t)throw new Error("CSRF token not found - please refresh the page");const e=await fetch(q("api.projects.paper-collection.start",{project:s.project.slug}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!e.ok){const p=await e.text();if(console.error("API Error:",e.status,p),e.status===409)try{const a=JSON.parse(p);throw new Error(a.message||"Source collection is already in progress")}catch{throw new Error("Source collection is already in progress for this project")}throw new Error(`Failed to start source collection: ${e.status}`)}return await qe()}catch(t){return console.error("Paper collection failed:",t),Y.value="Error",J.value="âŒ Source collection failed",N.value=!1,!1}},ve=async t=>{const e=t==="improve"?300:C.chapter(y.value||0);if(!E(e,t==="improve"?"improve this chapter":"generate this chapter with AI")||!await $e())return;if(h.value=!0,S.value="",g.value=0,i.value=5,d.value="Papers",l.value="Checking for verified sources...",F.value=!0,Ae(),$.value=y.value||0,z.value=!0,!await _e()){v.error("Paper Collection Failed",{description:"Unable to collect verified papers. Please try again."}),h.value=!1,z.value=!1;return}d.value="Initializing",l.value="Starting AI generation with verified sources...",i.value=51;const f=setInterval(()=>{i.value<52&&h.value?i.value+=.2:clearInterval(f)},100),k=q("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number});u.value=new EventSource(`${k}?generation_type=${t}`),u.value.onmessage=b=>{const m=JSON.parse(b.data);switch(m.type){case"start":d.value="Connecting",i.value=52,l.value="Connecting to AI service...",ke();break;case"content":d.value="Generating",S.value+=m.content,g.value=m.word_count||S.value.split(/\s+/).filter(M=>M.length>0).length;const Z=Date.now();if(Z-U.value>200){o.value=S.value,U.value=Z;const M=Math.min(g.value/Math.max($.value,1)*43,43);i.value=Math.max(52,52+M),l.value=`Generating chapter content... (${g.value} / ${$.value} words)`,ue()}break;case"heartbeat":i.value<95&&(i.value+=.5);break;case"complete":d.value="Complete",i.value=100,h.value=!1,F.value=!1,A.value=null,o.value=S.value;const P=m.final_word_count||g.value;l.value=`âœ“ Generated ${P} words successfully`,w(),he(P,`Chapter generation (${s.chapter.chapter_number})`,"chapter",s.chapter.id).catch(M=>console.error("Failed to record word usage (chapter generation):",M)),setTimeout(()=>{B()},500),u.value?.close(),u.value=null;break;case"error":d.value="Error",i.value=50,F.value=!1,A.value=null,m.partial_saved&&(X.value=!0,re.value=m.saved_word_count||0),m.code==="OFFLINE_MODE"?(l.value="ðŸ“¡ AI services offline",h.value=!1,v.error("AI Services Offline",{description:"Please check your internet connection and try again."})):m.can_resume?(l.value=`âš ï¸ Generation interrupted (${m.saved_word_count} words saved)`,h.value=!1,D.value=!0,v.warning("Generation Interrupted",{description:`${m.saved_word_count} words were saved. You can resume generation.`,duration:8e3})):(l.value="âŒ Generation failed",h.value=!1,v.error("Generation Error",{description:m.message||"Please try again."})),u.value?.close(),u.value=null;break;case"autosave":m.word_count&&m.generation_id&&(ae.value=m.generation_id);break}},u.value.onerror=()=>{if(_.value<ie){_.value++,Q.value=!0,d.value="Reconnecting",l.value=`ðŸ”„ Connection lost. Reconnecting... (${_.value}/${ie})`,u.value?.close(),u.value=null;const b=ce.value*Math.pow(2,_.value-1);setTimeout(()=>ge(t),b)}else d.value="Error",i.value=50,h.value=!1,Q.value=!1,l.value="âŒ Connection failed after multiple attempts",g.value>100?(X.value=!0,re.value=g.value,D.value=!0,v.warning("Connection Lost",{description:`${g.value} words may have been saved. Check and resume if needed.`,duration:8e3})):v.error("Connection Error",{description:"Please check your internet connection and try again."}),u.value?.close(),u.value=null,_.value=0,ce.value=2e3}},ge=t=>{u.value&&(u.value.close(),u.value=null);const e=q("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number}),p=new URLSearchParams({generation_type:t,resume_from:g.value.toString()});ae.value&&p.set("generation_id",ae.value),u.value=new EventSource(`${e}?${p}`),u.value.onmessage=a=>{const c=JSON.parse(a.data);switch(["content","start"].includes(c.type)&&(Q.value=!1,_.value=0,d.value="Generating"),c.type){case"start":l.value="âœ… Reconnected! Continuing generation...",ke(),v.success("Reconnected",{description:"Generation resumed successfully.",duration:3e3});break;case"content":d.value="Generating",S.value+=c.content,g.value=c.word_count||S.value.split(/\s+/).filter(b=>b.length>0).length;const f=Date.now();if(f-U.value>150){o.value=S.value,U.value=f;const b=Math.min(g.value/Math.max($.value,1)*43,43);i.value=Math.max(52,52+b),l.value=`Generating chapter content... (${g.value} / ${$.value} words)`,ue()}break;case"complete":d.value="Complete",i.value=100,h.value=!1,Q.value=!1,A.value=null,o.value=S.value;const k=c.final_word_count||g.value;l.value=`âœ“ Generated ${k} words successfully`,he(k,`Chapter generation (${s.chapter.chapter_number})`,"chapter",s.chapter.id).catch(b=>console.error("Failed to record word usage:",b)),setTimeout(()=>{B()},500),u.value?.close(),u.value=null;break;case"error":d.value="Error",h.value=!1,Q.value=!1,A.value=null,l.value="âŒ Generation failed",v.error("Generation Error",{description:c.message||"Please try again."}),u.value?.close(),u.value=null;break;case"autosave":c.generation_id&&(ae.value=c.generation_id);break}},u.value.onerror=()=>{if(_.value<ie){_.value++;const a=ce.value*Math.pow(2,_.value-1);l.value=`ðŸ”„ Reconnecting... (${_.value}/${ie})`,u.value?.close(),setTimeout(()=>ge(t),a)}else d.value="Error",h.value=!1,Q.value=!1,l.value="âŒ Connection failed",g.value>100?(D.value=!0,v.warning("Connection Lost",{description:`${g.value} words may be saved. Refresh to recover.`})):v.error("Connection Error",{description:"Please check your connection and try again."}),u.value?.close(),u.value=null,_.value=0}},Pe=async t=>{h.value=!0,S.value="",g.value=0,i.value=5,d.value="Papers",l.value="Checking for verified sources...",$.value=600,te.value=o.value||s.chapter.content||"",z.value=!0;try{i.value=50,d.value="Papers",l.value="Using existing verified sources...",await new Promise(p=>setTimeout(p,500)),d.value="Section",l.value=`Generating ${t} section with verified sources...`,i.value=51;const e=q("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number});u.value=new EventSource(`${e}?generation_type=section&section_type=${t}`),u.value.onmessage=p=>{const a=JSON.parse(p.data);switch(a.type){case"start":d.value="Generating Section",i.value=52,l.value=`Starting ${t} section generation...`;break;case"content":S.value+=a.content,g.value=a.word_count||G(S.value);const c=Date.now();if(c-U.value>150){o.value=te.value+`

`+S.value,U.value=c;const f=Math.min(g.value/$.value*43,43);i.value=Math.max(52,52+f),l.value=`Generating ${t} section... (${g.value} / ${$.value} words)`,w(),ue()}break;case"complete":i.value=100,d.value="Complete",l.value=`âœ“ Generated ${t} section (${g.value} words)`,o.value=te.value+`

`+S.value,T(!0),v.success("âœ… Section Generated Successfully",{description:`Added ${t} section with ${g.value} words and verified citations.`,duration:5e3}),h.value=!1,u.value?.close();break;case"error":throw new Error(a.message||"Section generation failed");case"heartbeat":i.value<95&&(i.value+=.5);break}},u.value.onerror=()=>{h.value=!1,d.value="Error",l.value="âŒ Section generation failed",v.error("âŒ Generation Failed",{description:"Unable to generate section. Please check your connection and try again."}),u.value?.close()}}catch(e){console.error("Section generation failed:",e),h.value=!1,d.value="Error",l.value="âŒ Section generation error",v.error("âŒ Generation Failed",{description:"Section generation encountered an error."})}},pe=async(t,e,p)=>{const a=t.split(/\s+/).length;if(!E(300,`${e} selected text`))return;h.value=!0,S.value="",g.value=0,i.value=10,d.value=e==="rephrase"?"Rephrasing":"Expanding",l.value=`${e==="rephrase"?"Rephrasing":"Expanding"} selected text...`,$.value=Math.max(a*(e==="expand"?2:1),100);const f=W.value||O.value,k=f?.getSelectionRange(),b={originalText:t,range:k,wordCount:a,style:p||"Academic Formal",startTime:Date.now()};z.value=!0;try{const m=document.querySelector('meta[name="csrf-token"]')?.content;if(!m)throw new Error("CSRF token not found - please refresh the page");const Z=e==="rephrase"?q("chapters.quick-actions.rephrase",{project:s.project.slug,chapter:s.chapter.chapter_number}):q("chapters.quick-actions.expand",{project:s.project.slug,chapter:s.chapter.chapter_number});i.value=35;const P=await fetch(Z,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":m,"X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify({text:t,...e==="rephrase"?{style:b.style}:{}})});if(!P.ok){let V=`Request failed (${P.status})`;try{const le=await P.json();V=le?.message||le?.error||le?.data?.message||V}catch{}throw new Error(V)}const M=await P.json(),ne=String(M?.text||"").trim();if(!ne)throw new Error("Empty response from AI service");i.value=100,d.value="Complete",l.value=`âœ“ Text ${e==="rephrase"?"rephrased":"expanded"} successfully`,b.range&&(f?.replaceSelection(ne,b.range)?setTimeout(()=>{const le=f?.getHTML()||o.value;o.value=le},50):v.warning("Please manually replace the selected text",{description:"The generated text is ready but could not be automatically inserted."})),T(!0),v.success(`âœ… Text ${e==="rephrase"?"Rephrased":"Expanded"} Successfully`,{description:`${e==="rephrase"?"Rephrased":"Expanded"} selection (${a} words).`});const de=Number(M?.word_count)||G(ne)||(e==="expand"?a*2:a);he(de,e==="rephrase"?`Rephrase (${b.style})`:"Expand text","chapter",s.chapter.id).catch(V=>console.error(`Failed to record word usage (${e}):`,V)),h.value=!1}catch(m){console.error("Selection generation failed:",m),h.value=!1,d.value="Error",l.value=`âŒ Text ${e==="rephrase"?"rephrasing":"expansion"} error`,v.error(`âŒ ${e==="rephrase"?"Rephrasing":"Expansion"} Failed`,{description:m instanceof Error?m.message:"Text generation encountered an error."})}};return{isGenerating:h,generationProgress:l,generationPercentage:i,generationPhase:d,estimatedTotalWords:$,streamWordCount:g,streamBuffer:S,lastStreamUpdate:U,originalContentForAppend:te,aiSuggestions:oe,isLoadingSuggestions:K,showCitationHelper:se,showPresentationMode:z,isStreamingMode:F,showRecoveryDialog:D,partialContentSaved:X,savedWordCountOnError:re,isCollectingPapers:N,paperCollectionProgress:J,paperCollectionPhase:Y,collectedPapersCount:me,paperCollectionPercentage:we,currentSource:Se,sourcesCompleted:ye,papersPreview:Ce,paperCollectionData:Te,paperCollectionInterval:H,reconnectAttempts:_,reconnectDelay:ce,isReconnecting:Q,currentGenerationId:ae,currentGenerationType:Ie,eventSource:u,editorScrollRef:be,attachScroller:Ee,smoothScrollToBottom:Me,forceScrollToBottom:Ge,resetScroller:Ae,isAutoScrollActive:Ue,isUserScrollingScroller:Fe,scrollToBottom:ue,checkConnectionQuality:$e,startPaperCollection:_e,startStreamingGeneration:ve,attemptReconnection:ge,startSectionGeneration:Pe,handleSelectionGeneration:pe,handleAIGeneration:(t,e)=>{t==="section"&&e?.section?Pe(e.section):t==="rephrase"&&e?.selectedText?pe(e.selectedText,"rephrase",e.style):t==="expand"&&e?.selectedText?pe(e.selectedText,"expand"):ve(t)},handleRegenerateChapter:async(t=!1)=>{if(!t)return!1;const e=C.chapter(y.value||0);return E(e,"regenerate this chapter")?(o.value&&o.value.trim().length>0&&(fe("Before regenerate"),v.info("Previous content saved",{description:"You can undo to restore it if needed.",duration:3e3})),o.value="",await ve("progressive"),!0):!1},getAISuggestions:async()=>{if(!L.value)return;const t=C.suggestion();if(E(t,"get AI suggestions")){K.value=!0;try{const p=await(await fetch(q("chapters.suggestions",{project:s.project.slug,chapter:s.chapter.chapter_number}),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({selected_text:L.value,context:o.value})})).json();oe.value=p.suggestions||[],oe.value.length&&he(C.suggestion(),"AI suggestions","chapter",s.chapter.id).catch(a=>console.error("Failed to record word usage (suggestions):",a))}catch{v.error("Error getting suggestions",{description:"Please try again."})}finally{K.value=!1}}},checkCitations:()=>{se.value=!0,v.success("Citation Manager opened!",{description:"Review and verify your citations in the panel below."})},insertCitation:t=>{try{const e=W.value?.editor||O.value?.editor;if(!e){v.error("Editor not found");return}const{from:p}=e.state.selection;e.chain().focus().insertContentAt(p,` ${t} `).run(),v.success("Citation inserted successfully")}catch(e){console.error("Failed to insert citation:",e),v.error("Failed to insert citation")}},resumeGeneration:()=>{D.value=!1,X.value=!1,window.location.reload()},dismissRecovery:()=>{D.value=!1,X.value=!1,re.value=0},checkForAutoGeneration:()=>{const t=new URLSearchParams(window.location.search),e=t.get("ai_generate")==="true",p=t.get("generation_type");!e||!p||setTimeout(()=>{ve("progressive");const a=new URL(window.location.href);a.searchParams.delete("ai_generate"),a.searchParams.delete("generation_type"),window.history.replaceState({},"",a.toString()),v.success("ðŸš€ AI Generation Started",{description:`Generating ${s.chapter.title} with AI assistance...`})},1e3)},contentHistory:r,canUndo:I,pushToHistory:fe,undoLastAction:Le,clearHistory:je}}function ot(s){const{delay:o=1e4,onSave:y}=s,C=n(!1),E=n(!1),T=n(null),B=()=>{C.value=!0,T.value&&clearTimeout(T.value),T.value=setTimeout(()=>{w(!0)},o)},w=async(L=!1)=>{if(!E.value){E.value=!0;try{await y(L),C.value=!1,T.value&&(clearTimeout(T.value),T.value=null)}finally{E.value=!1}}};return{hasUnsavedChanges:C,isSaving:E,triggerAutoSave:B,save:w,clearAutoSave:()=>{T.value&&(clearTimeout(T.value),T.value=null)}}}function at(s,o=n(3e3),y=.8){const C=r=>{if(!r)return 0;const I=r.replace(/<[^>]*>/g,"").trim().replace(/\s+/g," ");if(!I)return 0;const j=I.match(/\b\w+\b/g);return j?j.length:0},E=r=>r?r.replace(/<[^>]*>/g,"").replace(/\r\n|\r/g,`
`).trim().split(/\n\s*\n/).filter(N=>N.trim().length>0).length:0,T=r=>{if(!r)return 0;const I=r.replace(/<[^>]*>/g,"").match(/[.!?]+/g);return I?I.length:0},B=r=>Math.round(r/200*10)/10,w=x(()=>C(s.value)),G=x(()=>s.value.length),L=x(()=>s.value.replace(/\s/g,"").length),O=x(()=>E(s.value)),W=x(()=>T(s.value)),ee=x(()=>B(w.value)),h=x(()=>{const r=o.value;return!r||r<=0?0:Math.min(w.value/r*100,100)}),l=x(()=>w.value>=o.value*y),i=x(()=>{const r=o.value-w.value;return Math.max(r,0)}),d=x(()=>{const r=o.value*y-w.value;return Math.max(r,0)}),$=x(()=>({wordCount:w.value,characterCount:G.value,characterCountNoSpaces:L.value,paragraphCount:O.value,sentenceCount:W.value,readingTimeMinutes:ee.value})),g=x(()=>({current:w.value,target:o.value,percentage:h.value,isComplete:l.value,completionThreshold:y})),S=r=>r>=1e3?`${Math.round(r/100)/10}k`:r.toString(),U=(r=0)=>`${Math.round(h.value*Math.pow(10,r))/Math.pow(10,r)}%`,te=()=>`${w.value} / ${o.value} words (${U()}%)`,oe=()=>{if(l.value)return`âœ… Complete (${S(w.value)} words)`;const r=d.value;return`${S(r)} more words to complete`},K=()=>{const r=w.value,R=o.value;return r===0?"empty":r<R*.25?"started":r<R*.75?"progressing":r<R*y?"near_complete":r<R?"complete":"exceeded"},se=()=>{const r=K();return{empty:"text-gray-500",started:"text-blue-500",progressing:"text-yellow-500",near_complete:"text-orange-500",complete:"text-green-500",exceeded:"text-emerald-600"}[r]},z=()=>{const r=K();return{empty:"bg-gray-200",started:"bg-blue-200",progressing:"bg-yellow-200",near_complete:"bg-orange-200",complete:"bg-green-200",exceeded:"bg-emerald-200"}[r]},F=800,D=x(()=>w.value>=F),X=x(()=>Math.max(F-w.value,0)),re=x(()=>Math.min(w.value/F*100,100));return{currentWordCount:w,characterCount:G,characterCountNoSpaces:L,paragraphCount:O,sentenceCount:W,readingTimeMinutes:ee,progressPercentage:h,isComplete:l,wordsRemaining:i,wordsToComplete:d,wordCountStats:$,wordCountProgress:g,meetsDefenseThreshold:D,defenseWordsRemaining:X,defenseProgressPercentage:re,DEFENSE_THRESHOLD:F,formatWordCount:S,formatProgress:U,getProgressDisplay:te,getCompletionDisplay:oe,getWordCountStatus:K,getStatusColor:se,getProgressBarColor:z,countWords:C}}export{ot as a,rt as b,at as u};
