import{bs as i,ch as F,ck as l,bA as P,cR as S,cl as w}from"./vendor-BwJgEX4g.js";const p=i(null);let d=!1,h=0,b=null;function M(e){if(h++,console.log(`[WordBalance] Init listener called, subscriber count: ${h}, already subscribed: ${d}`),d){console.log("[WordBalance] Already subscribed, skipping");return}if(!window.Echo){console.warn("[WordBalance] window.Echo not available");return}try{console.log(`[WordBalance] Subscribing to private channel: user.${e}`);const r=window.Echo.private(`user.${e}`);r.listen(".balance.updated",n=>{console.log("ðŸ’° [WordBalance] Event received:",n),console.log(`ðŸ’° [WordBalance] New balance: ${n.balance.formatted_balance} (reason: ${n.reason})`),p.value=n.balance}),r.subscribed(()=>{console.log(`âœ… [WordBalance] Successfully subscribed to user.${e} channel`)}),r.error(n=>{console.error("[WordBalance] Channel error:",n)}),d=!0,b=e,console.log(`âœ… [WordBalance] Listener registered for user.${e}`)}catch(r){console.error("[WordBalance] Failed to subscribe to balance channel:",r)}}function k(){if(h--,!(h>0||!d||!window.Echo||!b))try{window.Echo.leave(`user.${b}`),d=!1,b=null,console.log("ðŸ”Œ Unsubscribed from balance updates channel")}catch(e){console.error("Failed to unsubscribe from balance channel:",e)}}function L(){const e=F(),r=i(!1),n=i(!1),s=i(0),t=i(""),g=l(()=>e.props.auth?.user?.id??null),u=l(()=>p.value?p.value:e.props.auth?.user?.word_balance_data??null),f=l(()=>u.value?.balance??0),B=l(()=>u.value?.formatted_balance??"0"),m=l(()=>f.value>0),y=l(()=>u.value?u.value.percentage_remaining<20:!1),v=a=>{const o=f.value,c=o>=a;return{canProceed:c,balance:o,required:a,shortage:c?0:a-o}},W=(a,o="continue")=>v(a).canProceed?!0:(s.value=a,t.value=o,n.value=!0,!1),_=async()=>{r.value=!0;try{const o=await(await fetch(w("api.balance"))).json();if(o.balance){const c=e.props.auth;c?.user&&(c.user.word_balance_data=o.balance)}return o.balance}catch(a){return console.error("Failed to fetch balance:",a),null}finally{r.value=!1}},$={chapter:a=>Math.ceil(a*1.1),suggestion:()=>200,chat:()=>500,defense:()=>1e3,expand:()=>300,rephrase:()=>150},E=()=>{n.value=!1,s.value=0,t.value=""};return P(()=>{g.value&&M(g.value)}),S(()=>{k()}),{wordBalance:u,balance:f,formattedBalance:B,hasWords:m,isLowBalance:y,isLoading:r,showPurchaseModal:n,requiredWordsForModal:s,actionDescriptionForModal:t,checkBalance:v,checkAndPrompt:W,refreshBalance:_,closePurchaseModal:E,estimates:$}}async function A(e,r,n,s){try{await fetch(w("api.words.record-usage"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({words:e,description:r,reference_type:n,reference_id:s})})}catch(t){console.error("Failed to record word usage:",t)}}export{A as r,L as u};
