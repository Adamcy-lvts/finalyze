const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AISidebar-Cxiw_Knk.js","assets/app-CvqzSedG.js","assets/app-Cgl-ZKxF.css","assets/index-B2Jp-AbD.js","assets/CardContent.vue_vue_type_script_setup_true_lang-BU1G6cs-.js","assets/CardTitle.vue_vue_type_script_setup_true_lang-B6ojriqM.js","assets/CollapsibleTrigger.vue_vue_type_script_setup_true_lang-CG69rFjv.js","assets/VisuallyHidden-DB_fmpkP.js","assets/useForwardExpose-wU1_jECe.js","assets/Separator.vue_vue_type_script_setup_true_lang-BDxbsbiC.js","assets/Separator-w_CRNjwk.js","assets/Progress.vue_vue_type_script_setup_true_lang-Def6NCmv.js","assets/nullish-CHIgUVhi.js","assets/Sonner.vue_vue_type_script_setup_true_lang-C3qX8evA.js","assets/DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-BISjo1U_.js","assets/triangle-alert-895uXHmW.js","assets/circle-check-C6hWbJjC.js","assets/CitationHelper.vue_vue_type_script_setup_true_lang-DqQIl64Y.js","assets/index-Ci289g20.js","assets/Input.vue_vue_type_script_setup_true_lang-V7CUwJBK.js","assets/ScrollArea.vue_vue_type_script_setup_true_lang-B_LK5Yf7.js","assets/useNonce-BIszhcxR.js","assets/AlertDialogTitle.vue_vue_type_script_setup_true_lang-DZ07psKU.js","assets/RichTextEditor-BbILrHI8.js","assets/_plugin-vue_export-helper-DlAUqK2U.js","assets/SafeHtmlText.vue_vue_type_script_setup_true_lang-5KGWwieD.js","assets/index-BWEDi_FC.js","assets/step-DrZ9DcYd.js","assets/DialogTitle.vue_vue_type_script_setup_true_lang-CFDaVwlw.js","assets/DialogFooter.vue_vue_type_script_setup_true_lang-BdhAhxCn.js","assets/Label.vue_vue_type_script_setup_true_lang-B3G1qrOi.js","assets/type-DDl5gjgp.js","assets/minus-uGYVm6s0.js","assets/plus-B-lH923P.js","assets/list-Ce3ZmywA.js","assets/RichTextEditor-BDJ8Kfyb.css","assets/chevron-down-Dx-f3oY2.js","assets/wand-sparkles-v2llM_wJ.js","assets/search-BFJ0f4jL.js","assets/history-LVTxztye.js","assets/trash-2-e3qXBUYw.js","assets/copy-cIHoyUsV.js","assets/brain-Ca1O-FqX.js","assets/zap-xyHuapzY.js","assets/pen-tool-CoLYuvUp.js","assets/refresh-cw-B6SLoIEx.js","assets/sparkles-C6YJtMHk.js","assets/AISidebar-Ymbz_oju.css","assets/ChapterNavigation-B7EIOe9-.js","assets/ChapterNavigation.vue_vue_type_script_setup_true_lang-B_w8cEbP.js","assets/DialogTrigger-VLXEUGqf.js","assets/chevron-right-C3Pvosu_.js","assets/circle-check-big-D2NTCx1j.js","assets/lock-B6FgWG-Z.js","assets/target-DYQmKZZV.js","assets/MobileNavOverlay-DBBhup2u.js","assets/index-DIu0Hhkf.js","assets/DefensePreparationPanel.vue_vue_type_script_setup_true_lang-DIs-cM3z.js","assets/Switch.vue_vue_type_script_setup_true_lang-CDwPB5MA.js","assets/VisuallyHiddenInput-C7KK0QYX.js","assets/thumbs-up-DiZAVvX9.js","assets/lightbulb-CDl2Mk75.js","assets/download-CCm3v19k.js","assets/circle-alert-C8lbAMUp.js","assets/DataCollectionPanel.vue_vue_type_script_setup_true_lang-BPf6vBs-.js","assets/MobileNavOverlay-CN-XSdXy.css","assets/ChatModeLayout-B9MUAZZM.js","assets/ChatModeLayout.vue_vue_type_script_setup_true_lang-n5KVCHrZ.js","assets/square-BN0JvArm.js","assets/useTextHistory-CPsDgHzq.js","assets/Checkbox.vue_vue_type_script_setup_true_lang-C0d9c34p.js","assets/ohash.D__AXeF1-C-E83dC9.js","assets/RovingFocusItem-aDfMhCq7.js","assets/check-8sNs_Wsb.js","assets/file-text-0_JBq4ld.js","assets/useTextHistory-BWcwai4o.css","assets/loader-BDpF-rm2.js","assets/message-square-BglB1b2G.js","assets/chevron-left-Bhyiotks.js","assets/clock-D2Hf_3Df.js","assets/rotate-ccw-y8yaa97l.js","assets/chart-column-CPWMWZ7L.js","assets/user-ChqkIF4P.js","assets/eye-C7sRCAkj.js","assets/save-BycLTHo8.js","assets/ChatModeLayout-wjQGykpm.css","assets/CitationVerificationLayout-BzcJqVrS.js","assets/DefensePreparationPanel-C0-ZO1oi.js","assets/DataCollectionPanel-6ziez9Iv.js"])))=>i.map(i=>d[i]);
import{ak as Ea,ab as Ta,d as Dr,g as P,c as B,q as pe,o as C,u as t,w as o,k as s,e as r,s as D,n as ve,t as m,a as z,F as Lt,A as Ot,X as Xe,z as c,Q as Ne,C as ye,y as Y,h as gt,p as ht,j as Aa,al as Me,x as Be,T as br,am as ft,b as Qe,f as Ke,an as Fe}from"./app-CvqzSedG.js";import{_ as Te}from"./index-Ci289g20.js";import{_ as G}from"./index-B2Jp-AbD.js";import{_ as bt,a as xt}from"./CardContent.vue_vue_type_script_setup_true_lang-BU1G6cs-.js";import{_ as yt,a as Wt}from"./CardTitle.vue_vue_type_script_setup_true_lang-B6ojriqM.js";import{_ as xr}from"./Input.vue_vue_type_script_setup_true_lang-V7CUwJBK.js";import{_ as Dt}from"./Label.vue_vue_type_script_setup_true_lang-B3G1qrOi.js";import{_ as Mr}from"./Progress.vue_vue_type_script_setup_true_lang-Def6NCmv.js";import{_ as yr}from"./ScrollArea.vue_vue_type_script_setup_true_lang-B_LK5Yf7.js";import{_ as se,a as ne,b as oe}from"./UserInfo.vue_vue_type_script_setup_true_lang-B47enV7B.js";import{u as $a,r as Je,_ as Ra,a as Pa}from"./AppLayout.vue_vue_type_script_setup_true_lang-D5SjC1wt.js";import{_ as _r}from"./SafeHtmlText.vue_vue_type_script_setup_true_lang-5KGWwieD.js";import{t as x,M as Cr,S as kr}from"./Sonner.vue_vue_type_script_setup_true_lang-C3qX8evA.js";import{_ as ja}from"./PurchaseModal.vue_vue_type_script_setup_true_lang-C9msETf7.js";import{B as ot,u as qa,M as Sr,_ as Mt,R as Er,a as Da,P as Ma,b as Fa}from"./useTextHistory-CPsDgHzq.js";import{T as Na}from"./trending-up-DHu9ZOYI.js";import{C as La}from"./circle-alert-C8lbAMUp.js";import{ao as Tr}from"./RichTextEditor-BbILrHI8.js";import{t as Ar}from"./toNumber-BYcnPYWP.js";import{A as $r}from"./arrow-left-2EDZmXv0.js";import{B as mt}from"./brain-Ca1O-FqX.js";import{T as Rr}from"./target-DYQmKZZV.js";import{E as Ft}from"./eye-C7sRCAkj.js";import{S as Pr}from"./save-BycLTHo8.js";import{C as jr}from"./circle-check-big-D2NTCx1j.js";import{M as Oa}from"./message-square-BglB1b2G.js";import{P as Wa,a as Ia}from"./panel-left-open-w9y8Pp35.js";import{P as Ga}from"./pen-tool-CoLYuvUp.js";import"./useForwardExpose-wU1_jECe.js";import"./VisuallyHidden-DB_fmpkP.js";import"./nullish-CHIgUVhi.js";import"./useNonce-BIszhcxR.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-BISjo1U_.js";import"./coins-l6S-RDY5.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-BD3t69mL.js";import"./plus-B-lH923P.js";import"./chevron-right-C3Pvosu_.js";import"./triangle-alert-895uXHmW.js";import"./circle-check-C6hWbJjC.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-CFDaVwlw.js";import"./DialogFooter.vue_vue_type_script_setup_true_lang-BdhAhxCn.js";import"./sparkles-C6YJtMHk.js";import"./arrow-right-T24b0Pah.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Checkbox.vue_vue_type_script_setup_true_lang-C0d9c34p.js";import"./ohash.D__AXeF1-C-E83dC9.js";import"./VisuallyHiddenInput-C7KK0QYX.js";import"./RovingFocusItem-aDfMhCq7.js";import"./minus-uGYVm6s0.js";import"./check-8sNs_Wsb.js";import"./Separator.vue_vue_type_script_setup_true_lang-BDxbsbiC.js";import"./Separator-w_CRNjwk.js";import"./download-CCm3v19k.js";import"./chevron-down-Dx-f3oY2.js";import"./file-text-0_JBq4ld.js";import"./index-BWEDi_FC.js";import"./step-DrZ9DcYd.js";import"./type-DDl5gjgp.js";import"./list-Ce3ZmywA.js";var Nt=function(){return Ea.Date.now()},za="Expected a function",Ha=Math.max,Ua=Math.min;function Va(N,T,j){var L,f,p,y,v,l,k=0,w=!1,O=!1,R=!0;if(typeof N!="function")throw new TypeError(za);T=Ar(T)||0,Ta(j)&&(w=!!j.leading,O="maxWait"in j,p=O?Ha(Ar(j.maxWait)||0,T):p,R="trailing"in j?!!j.trailing:R);function g(W){var A=L,Q=f;return L=f=void 0,k=W,y=N.apply(Q,A),y}function M(W){return k=W,v=setTimeout(Z,T),w?g(W):y}function V(W){var A=W-l,Q=W-k,ee=T-A;return O?Ua(ee,p-Q):ee}function K(W){var A=W-l,Q=W-k;return l===void 0||A>=T||A<0||O&&Q>=p}function Z(){var W=Nt();if(K(W))return me(W);v=setTimeout(Z,V(W))}function me(W){return v=void 0,R&&L?g(W):(L=f=void 0,y)}function _e(){v!==void 0&&clearTimeout(v),k=0,L=l=f=v=void 0}function we(){return v===void 0?y:me(Nt())}function he(){var W=Nt(),A=K(W);if(L=arguments,f=this,l=W,A){if(v===void 0)return M(l);if(O)return clearTimeout(v),v=setTimeout(Z,T),g(l)}return v===void 0&&(v=setTimeout(Z,T)),y}return he.cancel=_e,he.flush=we,he}const Ba={class:"flex items-center justify-between mb-3"},Qa={class:"flex items-center gap-3"},Ka={class:"p-2 rounded-lg bg-blue-500/10"},Ja={class:"text-right"},Xa={class:"space-y-2"},Ya={class:"flex justify-between items-center text-xs"},Za={class:"relative"},es={key:0},ts={class:"space-y-3"},rs={class:"flex-1"},as={class:"text-sm font-medium"},ss={class:"text-xs text-muted-foreground"},ns={class:"w-20 h-2 bg-muted rounded-full overflow-hidden ml-3"},os={key:1},ls={class:"space-y-2"},is={class:"flex-1"},us={class:"text-sm font-medium"},cs={class:"text-xs text-muted-foreground"},ds={key:2,class:"flex items-center justify-center gap-3 p-4 rounded-lg bg-blue-50/50 border border-blue-200/50"},ps={key:3,class:"text-center p-4 rounded-lg bg-muted/30"},qr=Dr({__name:"WritingStatistics",props:{showStatistics:{type:Boolean},currentWordCount:{},writingStats:{},qualityAnalysis:{},isAnalyzing:{type:Boolean}},setup(N){const T=N;P(()=>{if(!T.qualityAnalysis?.quality_level)return"text-muted-foreground";switch(T.qualityAnalysis.quality_level){case"Excellent":return"text-green-600";case"Good":return"text-blue-600";case"Satisfactory":return"text-yellow-600";case"Needs Improvement":return"text-orange-600";case"Poor":return"text-red-600";default:return"text-muted-foreground"}});const j=P(()=>T.qualityAnalysis?.scores?Object.entries(T.qualityAnalysis.scores).filter(([,f])=>f.max>0).filter(([,f])=>f.percentage<75).sort(([,f],[,p])=>f.percentage-p.percentage).map(([f,p])=>({category:f.replace(" & "," & "),percentage:Math.round(p.percentage),score:p.score,max:p.max,status:p.percentage<40?"poor":p.percentage<60?"needs-work":"fair"})):[]),L=P(()=>{const f=T.qualityAnalysis?.total_score||0;return f>=80?{text:"Excellent",color:"text-green-600",bgColor:"bg-green-50"}:f>=70?{text:"Satisfactory",color:"text-yellow-600",bgColor:"bg-yellow-50"}:f>=60?{text:"Needs Work",color:"text-orange-600",bgColor:"bg-orange-50"}:{text:"Poor",color:"text-red-600",bgColor:"bg-red-50"}});return(f,p)=>f.showStatistics?(C(),B(t(bt),{key:0,class:"border border-border/50 bg-gradient-to-br from-card/80 to-card/60 backdrop-blur-sm shadow-lg"},{default:o(()=>[f.qualityAnalysis?(C(),B(t(yt),{key:0,class:"pb-4 border-b border-border/50"},{default:o(()=>[r("div",Ba,[r("div",Qa,[r("div",Ka,[s(t(ot),{class:"h-4 w-4 text-blue-600"})]),r("div",null,[s(t(Wt),{class:"text-sm font-semibold"},{default:o(()=>[...p[0]||(p[0]=[D("Academic Quality",-1)])]),_:1}),p[1]||(p[1]=r("p",{class:"text-xs text-muted-foreground"},"AI-powered analysis",-1))])]),r("div",Ja,[r("div",{class:ve(["text-2xl font-bold",L.value.color])},[D(m(f.qualityAnalysis.total_score),1),p[2]||(p[2]=r("span",{class:"text-sm text-muted-foreground"},"/100",-1))],2),s(t(Te),{class:ve([[L.value.color,L.value.bgColor],"text-xs font-medium"]),variant:"outline"},{default:o(()=>[D(m(L.value.text),1)]),_:1},8,["class"])])]),r("div",Xa,[r("div",Ya,[p[3]||(p[3]=r("span",{class:"text-muted-foreground"},"Overall Score",-1)),r("span",{class:ve(["font-medium",f.qualityAnalysis.meets_threshold?"text-green-600":"text-orange-600"])},m(f.qualityAnalysis.meets_threshold?"Meets threshold ‚úì":"Below 80% threshold"),3)]),r("div",Za,[s(t(Mr),{"model-value":Math.round(f.qualityAnalysis.total_score||0),class:ve(["h-2",{"[&>[data-slot=progress-indicator]]:bg-green-500":(f.qualityAnalysis.total_score||0)>=80,"[&>[data-slot=progress-indicator]]:bg-yellow-500":(f.qualityAnalysis.total_score||0)>=70&&(f.qualityAnalysis.total_score||0)<80,"[&>[data-slot=progress-indicator]]:bg-orange-500":(f.qualityAnalysis.total_score||0)>=60&&(f.qualityAnalysis.total_score||0)<70,"[&>[data-slot=progress-indicator]]:bg-red-500":(f.qualityAnalysis.total_score||0)<60}])},null,8,["model-value","class"]),p[4]||(p[4]=r("div",{class:"absolute inset-0 flex items-center justify-center"},[r("div",{class:"w-0.5 h-4 bg-orange-400/60 rounded-full",style:{"margin-left":"80%"}})],-1))])])]),_:1})):pe("",!0),s(t(xt),{class:"p-4 space-y-4"},{default:o(()=>[f.qualityAnalysis?.scores?(C(),z("div",es,[p[5]||(p[5]=r("h4",{class:"text-xs font-semibold text-muted-foreground mb-3 flex items-center gap-2"},[r("div",{class:"w-1 h-4 bg-green-500 rounded-full"}),D(" Analysis Results ")],-1)),r("div",ts,[(C(!0),z(Lt,null,Ot(Object.entries(f.qualityAnalysis.scores).filter(([,y])=>y.max>0),([y,v])=>(C(),z("div",{key:y,class:"flex items-center justify-between p-3 rounded-lg bg-muted/30 hover:bg-muted/40 transition-colors"},[r("div",rs,[r("div",as,m(y),1),r("div",ss,[D(m(v.score)+"/"+m(v.max)+" points ",1),r("span",{class:ve(["ml-1",{"text-red-500":v.percentage<50,"text-orange-500":v.percentage>=50&&v.percentage<75,"text-blue-500":v.percentage>=75&&v.percentage<90,"text-green-500":v.percentage>=90}])}," ("+m(Math.round(v.percentage))+"%) ",3)])]),r("div",ns,[r("div",{class:ve(["h-full transition-all duration-500 rounded-full",{"bg-red-500":v.percentage<50,"bg-orange-500":v.percentage>=50&&v.percentage<75,"bg-blue-500":v.percentage>=75&&v.percentage<90,"bg-green-500":v.percentage>=90}]),style:Xe({width:`${v.percentage}%`})},null,6)])]))),128))])])):pe("",!0),j.value.length>0?(C(),z("div",os,[p[6]||(p[6]=r("h4",{class:"text-xs font-semibold text-muted-foreground mb-3 flex items-center gap-2"},[r("div",{class:"w-1 h-4 bg-orange-500 rounded-full"}),D(" Focus Areas ")],-1)),r("div",ls,[(C(!0),z(Lt,null,Ot(j.value,y=>(C(),z("div",{key:y.category,class:"flex items-center gap-3 p-3 rounded-lg border border-orange-200/50 bg-orange-50/30"},[s(t(La),{class:"h-4 w-4 text-orange-500 flex-shrink-0"}),r("div",is,[r("div",us,m(y.category),1),r("div",cs,[D(m(y.score)+"/"+m(y.max)+" points - ",1),r("span",{class:ve({"text-red-600":y.status==="poor","text-orange-600":y.status==="needs-work","text-yellow-600":y.status==="fair"})},m(y.status==="poor"?"needs significant improvement":y.status==="needs-work"?"needs improvement":"fair, could be better"),3)])])]))),128))])])):pe("",!0),f.isAnalyzing?(C(),z("div",ds,[s(t(Na),{class:"h-4 w-4 text-blue-500 animate-pulse"}),p[7]||(p[7]=r("span",{class:"text-sm text-blue-700 font-medium"},"Analyzing academic quality with AI...",-1))])):pe("",!0),!f.qualityAnalysis&&!f.isAnalyzing?(C(),z("div",ps,[s(t(ot),{class:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),p[8]||(p[8]=r("p",{class:"text-sm text-muted-foreground"},'Click "Analyze" to get AI-powered quality insights',-1))])):pe("",!0)]),_:1})]),_:1})):pe("",!0)}});function vs(N){const{delay:T=1e4,onSave:j}=N,L=c(!1),f=c(!1),p=c(null),y=()=>{L.value=!0,p.value&&clearTimeout(p.value),p.value=setTimeout(()=>{v(!0)},T)},v=async(k=!1)=>{if(!f.value){f.value=!0;try{await j(k),L.value=!1,p.value&&(clearTimeout(p.value),p.value=null)}finally{f.value=!1}}};return{hasUnsavedChanges:L,isSaving:f,triggerAutoSave:y,save:v,clearAutoSave:()=>{p.value&&(clearTimeout(p.value),p.value=null)}}}function gs(N){const T=c({sentences:0,paragraphs:0,readingTime:0,avgWordLength:0,uniqueWords:0,commonWords:[]}),j=P(()=>N.value?N.value.split(/\s+/).filter(p=>p.length>0).length:0),L=()=>{if(!N.value){T.value={sentences:0,paragraphs:0,readingTime:0,avgWordLength:0,uniqueWords:0,commonWords:[]};return}const p=N.value,y=p.split(/\s+/).filter(R=>R.length>0),v=p.split(/[.!?]+/).filter(R=>R.trim().length>0),l=p.split(`

`).filter(R=>R.trim().length>0),k=new Map;y.forEach(R=>{const g=R.toLowerCase().replace(/[^a-z0-9]/g,"");g&&k.set(g,(k.get(g)||0)+1)});const w=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","is","was","are","were"]),O=Array.from(k.entries()).filter(([R])=>!w.has(R)).sort((R,g)=>g[1]-R[1]).slice(0,5).map(([R])=>R);T.value={sentences:v.length,paragraphs:l.length,readingTime:Math.ceil(y.length/200),avgWordLength:y.reduce((R,g)=>R+g.length,0)/y.length,uniqueWords:k.size,commonWords:O}},f=P(()=>{if(!N.value)return 0;let p=0;const y=N.value;y.includes("##")&&(p+=20),y.length>1e3&&(p+=20),y.match(/\[.*?\]/g)&&(p+=15),(y.includes("**")||y.includes("*"))&&(p+=10);const v=y.split(/[.!?]+/).filter(k=>k.trim().length>0);if(v.length>0){const k=v.reduce((w,O)=>w+O.split(/\s+/).length,0)/v.length;k>10&&k<25&&(p+=20)}return y.split(`

`).filter(k=>k.trim().length>0).length>3&&(p+=15),Math.min(p,100)});return{writingStats:T,currentWordCount:j,writingQualityScore:f,calculateWritingStats:L}}function hs(N,T=c(3e3),j=.8){const L=u=>{if(!u)return 0;const U=u.replace(/<[^>]*>/g,"").trim().replace(/\s+/g," ");if(!U)return 0;const E=U.match(/\b\w+\b/g);return E?E.length:0},f=u=>u?u.replace(/<[^>]*>/g,"").replace(/\r\n|\r/g,`
`).trim().split(/\n\s*\n/).filter($=>$.trim().length>0).length:0,p=u=>{if(!u)return 0;const U=u.replace(/<[^>]*>/g,"").match(/[.!?]+/g);return U?U.length:0},y=u=>Math.round(u/200*10)/10,v=P(()=>L(N.value)),l=P(()=>N.value.length),k=P(()=>N.value.replace(/\s/g,"").length),w=P(()=>f(N.value)),O=P(()=>p(N.value)),R=P(()=>y(v.value)),g=P(()=>{const u=T.value;return!u||u<=0?0:Math.min(v.value/u*100,100)}),M=P(()=>v.value>=T.value*j),V=P(()=>{const u=T.value-v.value;return Math.max(u,0)}),K=P(()=>{const u=T.value*j-v.value;return Math.max(u,0)}),Z=P(()=>({wordCount:v.value,characterCount:l.value,characterCountNoSpaces:k.value,paragraphCount:w.value,sentenceCount:O.value,readingTimeMinutes:R.value})),me=P(()=>({current:v.value,target:T.value,percentage:g.value,isComplete:M.value,completionThreshold:j})),_e=u=>u>=1e3?`${Math.round(u/100)/10}k`:u.toString(),we=(u=0)=>`${Math.round(g.value*Math.pow(10,u))/Math.pow(10,u)}%`,he=()=>`${v.value} / ${T.value} words (${we()}%)`,W=()=>{if(M.value)return`‚úÖ Complete (${_e(v.value)} words)`;const u=K.value;return`${_e(u)} more words to complete`},A=()=>{const u=v.value,b=T.value;return u===0?"empty":u<b*.25?"started":u<b*.75?"progressing":u<b*j?"near_complete":u<b?"complete":"exceeded"},Q=()=>{const u=A();return{empty:"text-gray-500",started:"text-blue-500",progressing:"text-yellow-500",near_complete:"text-orange-500",complete:"text-green-500",exceeded:"text-emerald-600"}[u]},ee=()=>{const u=A();return{empty:"bg-gray-200",started:"bg-blue-200",progressing:"bg-yellow-200",near_complete:"bg-orange-200",complete:"bg-green-200",exceeded:"bg-emerald-200"}[u]},ie=800,Ae=P(()=>v.value>=ie),q=P(()=>Math.max(ie-v.value,0)),S=P(()=>Math.min(v.value/ie*100,100));return{currentWordCount:v,characterCount:l,characterCountNoSpaces:k,paragraphCount:w,sentenceCount:O,readingTimeMinutes:R,progressPercentage:g,isComplete:M,wordsRemaining:V,wordsToComplete:K,wordCountStats:Z,wordCountProgress:me,meetsDefenseThreshold:Ae,defenseWordsRemaining:q,defenseProgressPercentage:S,DEFENSE_THRESHOLD:ie,formatWordCount:_e,formatProgress:we,getProgressDisplay:he,getCompletionDisplay:W,getWordCountStatus:A,getStatusColor:Q,getProgressBarColor:ee,countWords:L}}function fs(N,T,j,L){const p=c(!1),y=c(0),v=c(!1),l=A=>{if(!A)return 0;const ee=A.replace(/<[^>]*>/g,"").trim().replace(/\s+/g," ");if(!ee)return 0;const ie=ee.match(/\b\w+\b/g);return ie?ie.length:0},k=P(()=>l(j.value)),w=P(()=>k.value>=800),O=()=>`defense_generation_triggered_${N.id}_ch_${T.chapter_number}`,R=()=>{const A=O();return localStorage.getItem(A)==="true"},g=()=>{const A=O();localStorage.setItem(A,"true"),p.value=!0},M=()=>{const A=O();localStorage.removeItem(A),p.value=!1,console.log(`üîÑ DEFENSE WATCHER: Reset generation trigger for Chapter ${T.chapter_number}`)},V=Va(async()=>{if(!v.value)return;const A=k.value;console.log(`üìä DEFENSE WATCHER: Word count check - Chapter ${T.chapter_number}: ${A} words`),A<800*.8&&p.value&&(console.log("‚¨áÔ∏è DEFENSE WATCHER: Content dropped below 80% of threshold, resetting trigger"),M()),y.value=A},2e3),K=()=>v.value?void 0:(v.value=!0,p.value=R(),y.value=k.value,console.log(`üëÄ DEFENSE WATCHER: Started watching Chapter ${T.chapter_number}`),console.log(`   Initial word count: ${y.value}`),console.log(`   Generation already triggered: ${p.value}`),console.log("   Threshold: 800 words"),Ne(j,(Q,ee)=>{Q!==ee&&V()},{immediate:!1})),Z=()=>{v.value=!1,V.cancel(),console.log(`üõë DEFENSE WATCHER: Stopped watching Chapter ${T.chapter_number}`)},me=async()=>{console.log(`üîç DEFENSE WATCHER: Force checking Chapter ${T.chapter_number}`),await V(),V.flush()},_e=P(()=>{const A=k.value;return A>0&&A<800&&!p.value}),we=P(()=>{const A=k.value/800*100;return Math.min(A,100)}),he=P(()=>{const A=800-k.value;return Math.max(A,0)});return{isWatching:v,hasTriggeredGeneration:p,currentWordCount:k,lastWordCount:y,meetsThreshold:w,shouldShowProgressIndicator:_e,progressPercentage:we,wordsRemaining:he,startWatching:K,stopWatching:Z,forceCheck:me,resetGenerationTrigger:M,markGenerationTriggered:g,getStatusMessage:()=>{const A=k.value;return p.value?`Defense questions available (${A} words)`:A>=800?`Ready for defense questions (${A} words)`:A>0?`${800-A} more words needed for defense questions`:"Start writing to enable defense questions (800 words needed)"},countWords:l,DEFENSE_WORD_COUNT_THRESHOLD:800}}function ms(N){const T=c(!1),j=c(null),L=c([]),f=c(null),p=P(()=>{if(!j.value?.quality_level)return"text-muted-foreground";switch(j.value.quality_level){case"Excellent":return"text-green-600";case"Good":return"text-blue-600";case"Satisfactory":return"text-yellow-600";case"Needs Improvement":return"text-orange-600";case"Poor":return"text-red-600";default:return"text-muted-foreground"}}),y=P(()=>j.value?.scores?Object.entries(j.value.scores).sort(([,g],[,M])=>g.percentage-M.percentage).slice(0,3).map(([g,M])=>({category:g.replace(" & "," & "),percentage:Math.round(M.percentage),score:M.score,max:M.max})):[]),v=async()=>{try{T.value=!0,f.value=null,await ye.get("/sanctum/csrf-cookie");const g=await ye.post(Y("api.chapters.analysis.analyze",{chapter:N}));if(g.data.success)return j.value=g.data.analysis,g.data.analysis;throw new Error(g.data.error||"Analysis failed")}catch(g){return f.value=g.response?.data?.error||g.message||"Analysis failed",console.error("Chapter analysis failed:",g),null}finally{T.value=!1}};return{isAnalyzing:T,latestAnalysis:j,analysisHistory:L,error:f,qualityLevelColor:p,topImprovementAreas:y,analyzeChapter:v,getLatestAnalysis:async()=>{try{await ye.get("/sanctum/csrf-cookie");const g=await ye.get(Y("api.chapters.analysis.latest",{chapter:N}));return g.data.success?(j.value=g.data.analysis,g.data.analysis):(j.value=null,null)}catch(g){return g.response?.status!==404&&(f.value=g.response?.data?.error||g.message||"Failed to get analysis",console.error("Failed to get latest analysis:",g)),null}},getAnalysisHistory:async()=>{try{await ye.get("/sanctum/csrf-cookie");const g=await ye.get(Y("api.chapters.analysis.history",{chapter:N}));if(g.data.success)return L.value=g.data.analyses,g.data.analyses;throw new Error(g.data.error||"Failed to get history")}catch(g){return f.value=g.response?.data?.error||g.message||"Failed to get analysis history",console.error("Failed to get analysis history:",g),[]}},autoAnalyze:async(g,M=500)=>{g>=M&&await v()},getScoreColor:(g,M)=>{const V=g/M*100;return V>=80?"text-green-600":V>=70?"text-blue-600":V>=60?"text-yellow-600":V>=40?"text-orange-600":"text-red-600"},getProgressVariant:g=>g>=80?"success":g>=60?"default":"destructive"}}const ws={key:2,class:"flex h-screen flex-col overflow-hidden bg-zinc-50 dark:bg-zinc-950 font-sans selection:bg-primary/20"},bs={class:"relative z-20 flex flex-shrink-0 items-center justify-between border-b border-border/40 bg-background/60 p-4 backdrop-blur-xl supports-[backdrop-filter]:bg-background/40 transition-all duration-300"},xs={class:"flex items-center gap-5"},ys={class:"flex flex-col"},_s={class:"flex items-center gap-3 text-xs text-muted-foreground"},Cs={class:"flex items-center gap-1.5"},ks={class:"flex items-center gap-4"},Ss={class:"flex items-center p-1 rounded-full border border-border/40 bg-background/50 backdrop-blur-sm shadow-sm"},Es={class:"flex items-center gap-2"},Ts={class:"relative z-20 h-[2px] w-full bg-border/20"},As={key:0,class:"mx-3 my-2"},$s={class:"relative overflow-hidden rounded-xl border border-blue-200 bg-gradient-to-br from-blue-50 to-purple-50 p-3 shadow-sm dark:border-blue-800 dark:from-blue-950/30 dark:to-purple-950/30"},Rs={class:"relative z-10 mb-2 flex items-center justify-between"},Ps={class:"flex items-center gap-2"},js={class:"relative"},qs={class:"flex h-6 w-6 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-purple-600"},Ds={class:"text-xs text-blue-700 dark:text-blue-300"},Ms={class:"relative z-10 mb-2"},Fs={class:"mb-1 flex items-center justify-between"},Ns={class:"text-xs text-blue-600 dark:text-blue-400"},Ls={class:"relative h-2 overflow-hidden rounded-full bg-blue-100 dark:bg-blue-900/50"},Os={class:"relative z-10 flex items-center gap-2"},Ws={class:"flex-shrink-0"},Is={key:0,class:"h-2 w-2 animate-bounce rounded-full bg-blue-500"},Gs={key:1,class:"flex gap-0.5"},zs={key:2,class:"h-2 w-2 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"},Hs={key:3,class:"h-2 w-2 rounded-full bg-green-500"},Us={key:4,class:"h-2 w-2 rounded-full bg-red-500"},Vs={class:"flex-1 text-xs text-blue-800 dark:text-blue-200"},Bs={class:"relative z-10 flex flex-1 overflow-hidden"},Qs={key:0,class:"w-[320px] flex-shrink-0 border-r border-border/50 bg-background/80 backdrop-blur-xl shadow-xl z-20"},Ks={class:"h-full overflow-y-auto custom-scrollbar"},Js={class:"p-4"},Xs={class:"mb-3"},Ys={class:"text-xs text-muted-foreground"},Zs={class:"flex min-h-0 flex-1 flex-col bg-transparent relative"},en={class:"flex-1 overflow-hidden relative"},tn={class:"absolute inset-0 overflow-y-auto custom-scrollbar flex flex-col items-center py-8 px-4 sm:px-8"},rn={class:"flex items-center justify-between"},an={class:"space-y-1"},sn={class:"flex items-center gap-2"},nn={class:"flex items-center justify-between px-6 py-2 border-b border-border/30 bg-muted/5"},on={class:"flex items-center gap-2"},ln={class:"space-y-1 relative z-10"},un={class:"text-sm font-medium text-foreground"},cn={class:"text-[10px] text-muted-foreground line-clamp-2 leading-relaxed"},dn={class:"flex-1 relative bg-background"},pn={class:"px-12 py-10 min-h-[500px]"},vn={class:"sticky bottom-0 z-10 border-t border-border/30 bg-background/80 backdrop-blur-md p-4 flex items-center justify-between"},gn={class:"text-xs text-muted-foreground"},hn={class:"flex items-center gap-2"},fn={key:0,class:"w-72 flex-shrink-0 border-l border-border/40 bg-background/40 backdrop-blur-md"},mn={class:"h-full overflow-y-auto custom-scrollbar"},wn={class:"space-y-6 p-4"},bn={class:"min-h-screen bg-gradient-to-br from-background via-background to-muted/20"},xn={class:"w-full px-4 py-6 transition-all duration-300"},yn={class:"mb-6 flex items-center justify-between"},_n={class:"flex items-center gap-4"},Cn={class:"text-sm text-muted-foreground"},kn={class:"flex items-center gap-2"},Sn={class:"hidden items-center gap-2 lg:flex"},En={class:"mb-6"},Tn={class:"mb-2 flex items-center justify-between"},An={class:"text-sm text-muted-foreground"},$n={key:0,class:"mb-6"},Rn={class:"relative overflow-hidden rounded-xl border border-blue-200 bg-gradient-to-br from-blue-50 to-purple-50 p-4 shadow-sm dark:border-blue-800 dark:from-blue-950/30 dark:to-purple-950/30"},Pn={class:"relative z-10 mb-3 flex items-center justify-between"},jn={class:"flex items-center gap-2"},qn={class:"relative"},Dn={class:"flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-purple-600"},Mn={class:"text-xs text-blue-700 dark:text-blue-300"},Fn={class:"relative z-10 mb-3"},Nn={class:"mb-1 flex items-center justify-between"},Ln={class:"text-xs text-blue-600 dark:text-blue-400"},On={class:"relative h-2 overflow-hidden rounded-full bg-blue-100 dark:bg-blue-900/50"},Wn={class:"relative z-10 flex items-center gap-2"},In={class:"flex-shrink-0"},Gn={key:0,class:"h-3 w-3 animate-bounce rounded-full bg-blue-500"},zn={key:1,class:"flex gap-1"},Hn={key:2,class:"h-3 w-3 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"},Un={key:3,class:"h-3 w-3 rounded-full bg-green-500"},Vn={key:4,class:"h-3 w-3 rounded-full bg-red-500"},Bn={class:"flex-1 text-xs text-blue-800 dark:text-blue-200"},Qn={key:0,class:"relative z-10 mt-3 border-t border-blue-200 pt-3 dark:border-blue-800"},Kn={class:"flex items-center justify-between text-xs"},Jn={class:"flex items-center gap-1"},Xn={class:"flex gap-0.5"},Yn={class:"ml-1 text-blue-600 dark:text-blue-400"},Zn={class:"grid grid-cols-1 gap-6 lg:grid-cols-12 transition-all duration-300"},eo={class:"hidden lg:block lg:col-span-2 transition-all duration-300"},to={class:"h-[calc(100vh-320px)] overflow-y-auto space-y-6 custom-scrollbar pr-1"},ro={class:"flex items-center justify-between"},ao={class:"flex items-center gap-2"},so={class:"flex items-center gap-2"},no={class:"space-y-2"},oo={class:"space-y-2"},lo={class:"flex items-center justify-between"},io={class:"flex items-center gap-2"},uo={class:"flex flex-col gap-2 pt-4 sm:flex-row"},co={class:"hidden sm:inline"},po={class:"sm:hidden"},vo={class:"hidden sm:inline"},go={class:"sm:hidden"},ho={class:"hidden lg:block lg:col-span-3 transition-all duration-300"},fo={class:"h-[calc(100vh-40px)] overflow-y-auto space-y-4 custom-scrollbar px-1"},mo={key:1,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50"},wo={class:"text-slate-600 dark:text-slate-300 mb-4"},bo={class:"font-semibold text-amber-600 dark:text-amber-400"},xo={class:"flex flex-col sm:flex-row gap-3"},wt=3,yo=1e3,Al=Dr({__name:"ChapterEditor",props:{project:{},chapter:{},allChapters:{},facultyChapters:{},mode:{}},setup(N){const T=Me(()=>Fe(()=>import("./AISidebar-Cxiw_Knk.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47]))),j=Me(()=>Fe(()=>import("./ChapterNavigation-B7EIOe9-.js"),__vite__mapDeps([48,49,3,1,2,20,7,8,21,22,14,50,18,13,15,16,33,51,52,53,54,40]))),L=Me(()=>Fe(()=>import("./MobileNavOverlay-DBBhup2u.js"),__vite__mapDeps([55,1,2,56,3,0,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,49,50,51,52,53,54,57,58,59,60,61,62,63,64,65]))),f=Me(()=>Fe(()=>import("./ChatModeLayout-B9MUAZZM.js"),__vite__mapDeps([66,67,1,2,18,3,8,4,11,7,12,20,21,23,24,25,26,27,14,28,29,19,30,31,32,33,34,35,68,69,70,71,59,72,73,9,10,13,15,16,62,36,74,75,56,76,63,40,38,77,78,51,79,80,44,81,60,54,43,42,46,41,52,82,83,84,85]))),p=Me(()=>Fe(()=>import("./CitationVerificationLayout-BzcJqVrS.js"),__vite__mapDeps([86,18,3,1,2,8,4,5,11,7,12,20,21,25,69,23,24,26,27,14,28,29,19,30,31,32,33,34,35,70,71,59,72,73,9,10,13,15,16,62,36,74,75,76,52]))),y=Me(()=>Fe(()=>import("./DefensePreparationPanel-C0-ZO1oi.js"),__vite__mapDeps([87,57,1,2,56,3,18,8,4,5,6,7,11,12,20,21,9,10,58,59,36,60,61,37,45,62,14,63]))),v=Me(()=>Fe(()=>import("./DataCollectionPanel-6ziez9Iv.js"),__vite__mapDeps([88,64,1,2,13,3,14,8,7,15,16]))),l=N,k=c(l.chapter.title||""),w=c(l.chapter.content||""),O=c(!0),R=c(!1),g=c(!1);c(!1);const M=c(!1);c("write");const V=c("");c(0);const K=c(!1),Z=c(!1),me=c(!0),_e=()=>{try{return localStorage.getItem(`chatMode_${l.project.id}_${l.chapter.chapter_number}`)==="true"}catch(a){return console.warn("Failed to load chat mode from localStorage:",a),!1}},we=a=>{try{localStorage.setItem(`chatMode_${l.project.id}_${l.chapter.chapter_number}`,String(a))}catch(e){console.warn("Failed to save chat mode to localStorage:",e)}},he=c(!1),W=c(!1),A=c(!1),Q=c(!1),ee=c(!1),ie=c(!0),Ae=c(!0),q=c(!1),S=c(""),u=c(0),b=c(""),U=c(0),E=c(0),$=c(null),F=c(""),Le=c(0),_t=c(""),It=c([]),Ye=c(!1),$e=c(!1),ge=c(0),Ct=c(2e3),Oe=c(!1),lt=c(null);c("progressive");const We=c(!1),it=c(!1),ut=c(0),{balance:Fr,showPurchaseModal:Gt,requiredWordsForModal:Nr,actionDescriptionForModal:Lr,checkAndPrompt:Or,closePurchaseModal:Wr,estimates:Se}=$a(),Ie=(a,e)=>Or(Math.max(1,Math.round(a)),e),Ze=c(!1),Ge=c(""),ze=c(""),Ir=c(0),Re=c(null),Gr=c(0),zr=c(null),Hr=c([]),Ur=c([]),Vr=c(null);c(null),c(null);const Br=c(),zt=c(),Qr=c(),Ht=c();c(null),c(null);const re=c(!1),{hasUnsavedChanges:Kr,isSaving:Ee,triggerAutoSave:Pe,save:Ce,clearAutoSave:Jr}=vs({delay:1e4,onSave:Qt});let Ut=0;const Xr=()=>{const a=Date.now();a-Ut>yo&&(Ut=a,x.success("Saved",{duration:2e3}))},{contentHistory:Yr,historyIndex:Zr,addToHistory:ea,undo:ta,redo:ra}=qa(l.chapter.content||""),{writingStats:kt,writingQualityScore:ke,calculateWritingStats:ct}=gs(w),{isAnalyzing:Vt,latestAnalysis:J,getLatestAnalysis:aa}=ms(l.chapter.id),ue=P(()=>{if(l.facultyChapters&&l.facultyChapters.length>0){const e=l.facultyChapters.find(n=>n.number===l.chapter.chapter_number);if(e?.word_count)return e.word_count}if(l.project?.outlines&&l.project.outlines.length>0){const e=l.project.outlines.find(n=>n.chapter_number===l.chapter.chapter_number);if(e?.target_word_count)return e.target_word_count}const a=l.project.type==="undergraduate"?2500:3500;return l.chapter.chapter_number===1||l.chapter.chapter_number===5?Math.round(a*.8):a}),{currentWordCount:te,progressPercentage:sa,meetsDefenseThreshold:na,defenseWordsRemaining:oa,defenseProgressPercentage:la,DEFENSE_THRESHOLD:dt,countWords:Bt}=hs(w,ue),et=sa,St=P(()=>{const a=k.value?.trim(),e=w.value?.trim();return a&&a.length>0&&e&&e.length>50}),be=P(()=>l.project),xe=P(()=>l.chapter),je=P(()=>l.allChapters);async function Qt(a=!1){try{const e=await fetch(Y("chapters.save",{project:l.project.id}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({project_id:l.project.id,chapter_number:l.chapter.chapter_number,title:k.value,content:w.value,auto_save:a,statistics:kt.value,quality_score:ke.value})});console.log("Response status:",e.status,e.statusText),console.log("Response headers:",e.headers);const n=await e.text();console.log("Raw response:",n);let i;try{i=JSON.parse(n)}catch(d){throw console.error("JSON parse error:",d),console.error("Response was:",n),new Error(`Server returned non-JSON response: ${e.status} ${e.statusText}`)}e.ok}catch(e){throw a||x.error("‚ùå Save Failed",{description:"Please try again or check your connection."}),e}}const Kt=()=>{const a=ta();a!==null&&(w.value=a,Pe())},Jt=()=>{const a=ra();a!==null&&(w.value=a,Pe())},tt=a=>{Kr.value&&confirm("You have unsaved changes. Save before switching chapters?")&&Ce();const e=l.allChapters.find(d=>d.chapter_number===a),i=e?.content&&e.content.trim()!==""?"chapters.edit":"chapters.write";Be.visit(Y(i,{project:l.project.slug,chapter:a}),{only:["chapter","mode","allChapters"],preserveState:!0,preserveScroll:!1})},Et=async()=>{const a=Se.chapter(ue.value||0);if(!Ie(a,"generate the next chapter with AI"))return;await Ce();const e=l.allChapters.map(d=>d.chapter_number).sort((d,h)=>d-h),n=e.indexOf(l.chapter.chapter_number);let i;if(n===-1||n===e.length-1)i=Math.max(...e)+1;else{const d=e[n+1];d===l.chapter.chapter_number+1?i=d:i=l.chapter.chapter_number+1}console.log("üìù Generating next chapter:",{currentChapter:l.chapter.chapter_number,existingChapters:e,nextChapterNumber:i});try{const d=Y("chapters.write",{project:l.project.slug,chapter:i});console.log("üîó Generated URL for next chapter:",d);const h=new URL(d,window.location.origin);h.searchParams.set("ai_generate","true"),h.searchParams.set("generation_type","progressive"),console.log("üöÄ Navigating to:",h.toString()),Be.visit(h.toString())}catch(d){console.error("‚ùå Error generating next chapter:",d),x.error("Navigation Error",{description:"Failed to navigate to next chapter. Please try again."})}},Tt=(a,e)=>{a==="section"&&e?.section?ia(e.section):a==="rephrase"&&e?.selectedText?ua(e.selectedText,e.style||"Academic Formal"):a==="expand"&&e?.selectedText?ca(e.selectedText):At(a)},ia=async a=>{q.value=!0,F.value="",E.value=0,u.value=5,b.value="Papers",S.value="Checking for verified sources...",U.value=600,_t.value=w.value||l.chapter.content||"",re.value=!0;try{u.value=50,b.value="Papers",S.value="Using existing verified sources...",await new Promise(n=>setTimeout(n,500)),b.value="Section",S.value=`Generating ${a} section with verified sources...`,u.value=51;const e=Y("chapters.stream",{project:l.project.slug,chapter:l.chapter.chapter_number});$.value=new EventSource(`${e}?generation_type=section&section_type=${a}`),$.value.onmessage=n=>{const i=JSON.parse(n.data);switch(i.type){case"start":b.value="Generating Section",u.value=52,S.value=`Starting ${a} section generation...`;break;case"content":F.value+=i.content,E.value=i.word_count||Bt(F.value);const d=Date.now();if(d-Le.value>150){const _=F.value;w.value=_t.value+`

`+_,Le.value=d;const I=Math.min(E.value/U.value*43,43);u.value=Math.max(52,52+I),S.value=`Generating ${a} section... (${E.value} / ${U.value} words)`,ct(),Pt()}break;case"complete":u.value=100,b.value="Complete",S.value=`‚úì Generated ${a} section (${E.value} words)`;const h=F.value;w.value=_t.value+`

`+h,Ce(!0),x.success("‚úÖ Section Generated Successfully",{description:`Added ${a} section with ${E.value} words and verified citations.`,duration:5e3}),q.value=!1,$.value?.close();break;case"error":throw new Error(i.message||"Section generation failed");case"heartbeat":u.value<95&&(u.value+=.5);break}},$.value.onerror=()=>{q.value=!1,b.value="Error",S.value="‚ùå Section generation failed",x.error("‚ùå Generation Failed",{description:"Unable to generate section. Please check your connection and try again."}),$.value?.close()}}catch(e){console.error("Section generation failed:",e),q.value=!1,b.value="Error",S.value="‚ùå Section generation error",x.error("‚ùå Generation Failed",{description:"Section generation encountered an error."})}},ua=async(a,e)=>{const n=a.split(/\s+/).length,i=Math.max(n,Se.rephrase());if(!Ie(i,`rephrase about ${n} words`))return;console.log("üöÄ ChapterEditor - Starting rephrase generation:",{selectedTextLength:a.length,selectedTextPreview:a.substring(0,100)+(a.length>100?"...":""),style:e,timestamp:new Date().toISOString()}),q.value=!0,F.value="",E.value=0,u.value=10,b.value="Rephrasing",S.value="Preparing to rephrase selected text...",U.value=Math.max(n,50);const d=rt.value||pt.value,h=d?.getSelectionRange();console.log("üìç ChapterEditor - Editor and selection info:",{hasActiveEditor:!!d,selectionRange:h,selectedWordCount:n,estimatedWords:U.value});const _={originalText:a,range:h,wordCount:n,style:e,startTime:Date.now()};console.log("üíæ ChapterEditor - Stored rephrase context:",_),re.value=!0;try{u.value=20,S.value=`Rephrasing ${n} words in ${e} style...`;const ae=`${Y("chapters.stream",{project:l.project.slug,chapter:l.chapter.chapter_number})}?generation_type=rephrase&selected_text=${encodeURIComponent(a)}&style=${encodeURIComponent(e)}`;console.log("üåê ChapterEditor - Creating EventSource:",{url:ae,encodedTextLength:encodeURIComponent(a).length}),$.value=new EventSource(ae),$.value.onmessage=H=>{const X=JSON.parse(H.data);switch(console.log("üì® ChapterEditor - EventSource message received:",{type:X.type,hasContent:!!X.content,contentLength:X.content?.length||0,wordCount:X.word_count}),X.type){case"start":console.log("‚ñ∂Ô∏è ChapterEditor - Rephrase generation started"),b.value="Rephrasing Text",u.value=30,S.value=`Rephrasing text in ${e} style...`;break;case"content":F.value+=X.content,E.value=X.word_count||Bt(F.value),console.log("üìù ChapterEditor - Content chunk received:",{chunkLength:X.content?.length||0,totalBufferLength:F.value.length,totalWords:E.value});const de=Math.min(E.value/U.value*60,60);u.value=Math.max(30,30+de),S.value=`Rephrasing... (${E.value} words)`;break;case"complete":if(console.log("üèÅ ChapterEditor - Rephrase generation complete"),u.value=100,b.value="Complete",S.value=`‚úì Text rephrased successfully (${E.value} words)`,console.log("üîÑ ChapterEditor - Starting text replacement:",{hasRange:!!_.range,hasContent:!!F.value.trim(),range:_.range,newContentLength:F.value.trim().length,newContentPreview:F.value.trim().substring(0,100)+"..."}),_.range&&F.value.trim()){console.log("üéØ ChapterEditor - Attempting text replacement with activeEditor:",{editorType:d===rt.value?"fullscreen":"normal",hasActiveEditor:!!d});const fe=d?.replaceSelection(F.value.trim(),_.range);console.log("üìä ChapterEditor - Text replacement result:",{success:fe}),fe?(console.log("‚úÖ ChapterEditor - Text replacement successful, updating chapter content"),setTimeout(()=>{const De=d?.getHTML()||w.value;console.log("üìÑ ChapterEditor - Updated chapter content length:",De.length),w.value=De},100)):(console.warn("‚ùå ChapterEditor - Failed to replace selected text, falling back to manual update"),x.warning("Please manually replace the selected text",{description:"The rephrased text is ready but couldn't be automatically replaced."}))}else console.error("‚ùå ChapterEditor - Cannot replace text:",{missingRange:!_.range,missingContent:!F.value.trim()});Ce(!0),x.success("‚úÖ Text Rephrased Successfully",{description:`Rephrased ${n} words in ${e} style.`,duration:5e3}),Je(E.value||n,`Rephrase (${e})`,"chapter",l.chapter.id).catch(fe=>console.error("Failed to record word usage (rephrase):",fe)),q.value=!1,$.value?.close();break;case"error":throw new Error(X.message||"Text rephrasing failed");case"heartbeat":u.value<95&&(u.value+=.5);break}},$.value.onerror=()=>{q.value=!1,b.value="Error",S.value="‚ùå Text rephrasing failed",x.error("‚ùå Rephrasing Failed",{description:"Unable to rephrase text. Please check your connection and try again."}),$.value?.close()}}catch(I){console.error("Text rephrasing failed:",I),q.value=!1,b.value="Error",S.value="‚ùå Rephrasing error",x.error("‚ùå Rephrasing Failed",{description:"Text rephrasing encountered an error."})}},ca=async a=>{const e=a.split(/\s+/).length,n=Math.max(e*2,Se.expand());if(!Ie(n,`expand about ${e} words`))return;console.log("üìà ChapterEditor - Starting expand generation:",{selectedTextLength:a.length,selectedTextPreview:a.substring(0,100)+(a.length>100?"...":""),timestamp:new Date().toISOString()}),q.value=!0,F.value="",E.value=0,u.value=10,b.value="Expanding",S.value="Preparing to expand selected text...",U.value=Math.max(e*2,100);const i=rt.value||pt.value,d=i?.getSelectionRange();console.log("üìç ChapterEditor - Editor and selection info for expand:",{hasActiveEditor:!!i,selectionRange:d,selectedWordCount:e,estimatedWords:U.value});const h={originalText:a,range:d,wordCount:e,startTime:Date.now()};console.log("üíæ ChapterEditor - Stored expand context:",h);try{const I=`${Y("chapters.stream",{project:l.project.slug,chapter:l.chapter.chapter_number})}?generation_type=expand&selected_text=${encodeURIComponent(a)}`;console.log("üåê ChapterEditor - Creating EventSource for expand:",{url:I,encodedTextLength:encodeURIComponent(a).length}),$.value=new EventSource(I),$.value.onmessage=ae=>{const H=JSON.parse(ae.data);switch(console.log("üì® ChapterEditor - EventSource message received:",{type:H.type,hasContent:!!H.content,contentLength:H.content?.length||0,wordCount:H.word_count}),H.type){case"start":console.log("‚ñ∂Ô∏è ChapterEditor - Expand generation started"),b.value="Expanding Text",u.value=20,S.value="Starting text expansion...";break;case"content":F.value+=H.content,E.value=H.word_count||F.value.split(/\s+/).filter(de=>de.length>0).length;const X=Math.min(E.value/U.value*90,90);u.value=Math.max(X,25),S.value=`Expanding text... ${E.value}/${U.value} words`,console.log("üìù ChapterEditor - Expand content received:",{chunkLength:H.content?.length||0,totalWords:E.value,progress:u.value});break;case"complete":if(console.log("‚úÖ ChapterEditor - Expand generation complete"),b.value="Complete",S.value="‚úÖ Text expansion completed",u.value=100,h.range&&F.value.trim()){console.log("üéØ ChapterEditor - Attempting text replacement for expand");const de=i?.replaceSelection(F.value.trim(),h.range);console.log("üìä ChapterEditor - Expand text replacement result:",{success:de}),de?(console.log("‚úÖ ChapterEditor - Expand text replacement successful"),setTimeout(()=>{const fe=i?.getHTML()||w.value;console.log("üìÑ ChapterEditor - Updated chapter content length after expand:",fe.length),w.value=fe},100)):(console.warn("‚ùå ChapterEditor - Failed to replace expanded text"),x.warning("Please manually replace the selected text",{description:"The expanded text is ready but couldn't be automatically replaced."}))}else console.error("‚ùå ChapterEditor - Cannot replace expanded text:",{missingRange:!h.range,missingContent:!F.value.trim()});Ce(!0),x.success("‚úÖ Text Expanded Successfully",{description:`Expanded ${h.wordCount} words into ${E.value} words`}),Je(E.value||h.wordCount*2,"Expand text","chapter",l.chapter.id).catch(de=>console.error("Failed to record word usage (expand):",de)),q.value=!1,$.value?.close();break;case"error":console.error("‚ùå ChapterEditor - Expand generation error:",H.message),q.value=!1,b.value="Error",S.value="‚ùå Text expansion failed",x.error("‚ùå Expansion Failed",{description:H.message||"Text expansion encountered an error."}),$.value?.close();break}},$.value.onerror=()=>{console.error("‚ùå ChapterEditor - Expand stream error occurred"),q.value=!1,b.value="Error",S.value="‚ùå Text expansion failed",x.error("‚ùå Expansion Failed",{description:"Unable to expand text. Please check your connection and try again."}),$.value?.close()}}catch(_){console.error("Text expansion failed:",_),q.value=!1,b.value="Error",S.value="‚ùå Expansion error",x.error("‚ùå Expansion Failed",{description:"Text expansion encountered an error."})}},da=async()=>{Ze.value=!0,ze.value="Starting",Ge.value="Initializing source collection...",u.value=5;try{const a=document.querySelector('meta[name="csrf-token"]')?.content;if(!a)throw new Error("CSRF token not found - please refresh the page");const e=await fetch(Y("api.projects.paper-collection.start",{project:l.project.slug}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":a,"X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!e.ok){const n=await e.text();if(console.error("API Error:",e.status,n),e.status===409)try{const i=JSON.parse(n);throw new Error(i.message||"Source collection is already in progress")}catch{throw new Error("Source collection is already in progress for this project")}throw new Error(`Failed to start source collection: ${e.status}`)}return await pa()}catch(a){return console.error("Paper collection failed:",a),ze.value="Error",Ge.value="‚ùå Source collection failed",Ze.value=!1,!1}},pa=async()=>new Promise(a=>{let e=0;const n=120,i=async()=>{try{const h=await(await fetch(Y("api.projects.paper-collection.status",{project:l.project.slug}))).json();if(h.success&&h.data){Vr.value=h.data;const _=h.data.status,I=h.data.papers_count||h.data.count||0,ae=h.data.message,H=h.data.percentage||0,X=h.data.current_source,de=h.data.sources_completed||[],fe=h.data.papers_preview||[];if(Ir.value=I,Gr.value=H,zr.value=X,Hr.value=de,Ur.value=fe,_==="completed"){ze.value="Complete",Ge.value=`‚úì Collected ${I} verified sources from ${de.length} databases`,u.value=50,Ze.value=!1,Re.value&&clearInterval(Re.value),a(!0);return}else if(_==="collecting_papers"||_==="initializing"||_==="processing"||_==="storing"){let De="";X&&(De={semantic_scholar:"Semantic Scholar",openalex:"OpenAlex",crossref:"CrossRef",pubmed:"PubMed"}[X]||X),ze.value=De||"Collecting Sources",Ge.value=ae||"Collecting sources from academic databases...",u.value=Math.min(5+H*.4,45)}else if(_==="collection_failed"){ze.value="Error",Ge.value=ae||"‚ùå Source collection failed",Ze.value=!1,Re.value&&clearInterval(Re.value),a(!1);return}}e++,e>=n&&(ze.value="Timeout",Ge.value="‚è±Ô∏è Source collection timed out",Ze.value=!1,Re.value&&clearInterval(Re.value),a(!1))}catch(d){console.error("Error checking paper collection status:",d),e++}};i(),Re.value=setInterval(i,5e3)}),At=async a=>{const e=Se.chapter(ue.value||0);if(!Ie(e,"generate this chapter with AI"))return;if(q.value=!0,F.value="",E.value=0,u.value=5,b.value="Papers",S.value="Checking for verified sources...",U.value=ue.value,re.value=!0,!await da()){x.error("Paper Collection Failed",{description:"Unable to collect verified papers. Please try again."}),q.value=!1,re.value=!1;return}b.value="Initializing",S.value="Starting AI generation with verified sources...",u.value=51;const i=setInterval(()=>{u.value<52&&q.value?u.value+=.2:clearInterval(i)},100),d=Y("chapters.stream",{project:l.project.slug,chapter:l.chapter.chapter_number});$.value=new EventSource(`${d}?generation_type=${a}`),$.value.onmessage=h=>{const _=JSON.parse(h.data);switch(_.type){case"start":b.value="Connecting",u.value=52,S.value="Connecting to AI service...";break;case"content":b.value="Generating",F.value+=_.content,E.value=_.word_count||F.value.split(/\s+/).filter(H=>H.length>0).length;const I=Date.now();if(I-Le.value>150){w.value=F.value,Le.value=I;const H=Math.min(E.value/U.value*43,43);u.value=Math.max(52,52+H),S.value=`Generating chapter content... (${E.value} / ${U.value} words)`,ct(),Pt()}break;case"heartbeat":u.value<95&&(u.value+=.5);break;case"complete":b.value="Complete",u.value=100,q.value=!1,w.value=F.value;const ae=_.final_word_count||E.value;S.value=`‚úì Generated ${ae} words successfully`,Je(ae,`Chapter generation (${l.chapter.chapter_number})`,"chapter",l.chapter.id).catch(H=>console.error("Failed to record word usage (chapter generation):",H)),setTimeout(()=>{Pe()},500),$.value?.close(),$.value=null;break;case"error":b.value="Error",u.value=50,_.partial_saved&&(it.value=!0,ut.value=_.saved_word_count||0),_.code==="OFFLINE_MODE"?(S.value="üì° AI services offline",q.value=!1,x.error("AI Services Offline",{description:"Please check your internet connection and try again."})):_.can_resume?(S.value=`‚ö†Ô∏è Generation interrupted (${_.saved_word_count} words saved)`,q.value=!1,We.value=!0,x.warning("Generation Interrupted",{description:`${_.saved_word_count} words were saved. You can resume generation.`,duration:8e3})):(S.value="‚ùå Generation failed",q.value=!1,x.error("Generation Error",{description:_.message||"Please try again."})),$.value?.close(),$.value=null;break;case"autosave":_.word_count&&(console.log(`üíæ Auto-saved: ${_.word_count} words`),_.generation_id&&(lt.value=_.generation_id));break}},$.value.onerror=()=>{if(ge.value<wt){ge.value++,Oe.value=!0,b.value="Reconnecting",S.value=`üîÑ Connection lost. Reconnecting... (${ge.value}/${wt})`,$.value?.close(),$.value=null;const h=Ct.value*Math.pow(2,ge.value-1);console.log(`üîå Attempting reconnection in ${h}ms (attempt ${ge.value})`),setTimeout(()=>{Xt(a)},h)}else b.value="Error",u.value=50,q.value=!1,Oe.value=!1,S.value="‚ùå Connection failed after multiple attempts",E.value>100?(it.value=!0,ut.value=E.value,We.value=!0,x.warning("Connection Lost",{description:`${E.value} words may have been saved. Check and resume if needed.`,duration:8e3})):x.error("Connection Error",{description:"Please check your internet connection and try again."}),$.value?.close(),$.value=null,ge.value=0,Ct.value=2e3}},Xt=a=>{const e=Y("chapters.stream",{project:l.project.slug,chapter:l.chapter.chapter_number}),n=new URLSearchParams({generation_type:a,resume_from:E.value.toString()});lt.value&&n.set("generation_id",lt.value),console.log(`üîå Reconnecting to stream from ${E.value} words...`),$.value=new EventSource(`${e}?${n}`),$.value.onmessage=i=>{const d=JSON.parse(i.data);switch((d.type==="content"||d.type==="start")&&(Oe.value=!1,ge.value=0,b.value="Generating"),d.type){case"start":S.value="‚úÖ Reconnected! Continuing generation...",x.success("Reconnected",{description:"Generation resumed successfully.",duration:3e3});break;case"content":b.value="Generating",F.value+=d.content,E.value=d.word_count||F.value.split(/\s+/).filter(I=>I.length>0).length;const h=Date.now();if(h-Le.value>150){w.value=F.value,Le.value=h;const I=Math.min(E.value/U.value*43,43);u.value=Math.max(52,52+I),S.value=`Generating chapter content... (${E.value} / ${U.value} words)`,Pt()}break;case"complete":b.value="Complete",u.value=100,q.value=!1,Oe.value=!1,w.value=F.value;const _=d.final_word_count||E.value;S.value=`‚úì Generated ${_} words successfully`,Je(_,`Chapter generation (${l.chapter.chapter_number})`,"chapter",l.chapter.id).catch(I=>console.error("Failed to record word usage:",I)),setTimeout(()=>{Pe()},500),$.value?.close(),$.value=null;break;case"error":b.value="Error",q.value=!1,Oe.value=!1,S.value="‚ùå Generation failed",x.error("Generation Error",{description:d.message||"Please try again."}),$.value?.close(),$.value=null;break;case"autosave":d.generation_id&&(lt.value=d.generation_id);break}},$.value.onerror=()=>{if(ge.value<wt){ge.value++;const i=Ct.value*Math.pow(2,ge.value-1);S.value=`üîÑ Reconnecting... (${ge.value}/${wt})`,$.value?.close(),setTimeout(()=>{Xt(a)},i)}else b.value="Error",q.value=!1,Oe.value=!1,S.value="‚ùå Connection failed",E.value>100?(We.value=!0,x.warning("Connection Lost",{description:`${E.value} words may be saved. Refresh to recover.`})):x.error("Connection Error",{description:"Please check your connection and try again."}),$.value?.close(),$.value=null,ge.value=0}},va=()=>{We.value=!1,it.value=!1,window.location.reload()},ga=()=>{We.value=!1,it.value=!1,ut.value=0},$t=async()=>{if(!V.value)return;const a=Se.suggestion();if(Ie(a,"get AI suggestions")){Ye.value=!0;try{const n=await(await fetch(Y("chapters.suggestions",{project:l.project.slug,chapter:l.chapter.chapter_number}),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({selected_text:V.value,context:w.value})})).json();It.value=n.suggestions||[],It.value.length&&Je(Se.suggestion(),"AI suggestions","chapter",l.chapter.id).catch(i=>console.error("Failed to record word usage (suggestions):",i))}catch{x.error("Error getting suggestions",{description:"Please try again."})}finally{Ye.value=!1}}},Rt=()=>{$e.value=!0,x.success("Citation Manager opened!",{description:"Review and verify your citations in the panel below."})},Yt=a=>{try{const e=rt.value?.editor||pt.value?.editor;if(!e){x.error("Editor not found");return}const{from:n}=e.state.selection;e.chain().focus().insertContentAt(n,` ${a} `).run(),x.success("Citation inserted successfully")}catch(e){console.error("Failed to insert citation:",e),x.error("Failed to insert citation")}},pt=c(null),rt=c(null),ha=async()=>{try{const a=document.documentElement;a.requestFullscreen?await a.requestFullscreen():a.webkitRequestFullscreen?await a.webkitRequestFullscreen():a.msRequestFullscreen&&await a.msRequestFullscreen()}catch(a){console.error("Error entering fullscreen:",a),x.error("Fullscreen Error",{description:"Unable to enter fullscreen mode"})}},fa=async()=>{try{document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen()}catch(a){console.error("Error exiting fullscreen:",a),x.error("Fullscreen Error",{description:"Unable to exit fullscreen mode"})}},Zt=async()=>{g.value?await fa():await ha()},He=()=>{const a=document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;g.value=!!a},er=()=>{R.value=!R.value,document.documentElement.classList.toggle("dark",R.value),localStorage.setItem("darkMode",R.value.toString())},ma=()=>{K.value=!K.value,K.value&&(Z.value=!1),we(K.value)},wa=()=>{K.value=!1,we(!1)},ba=()=>{Z.value=!Z.value,Z.value&&(K.value=!1,we(!1))},xa=()=>{Z.value=!1},tr=()=>{re.value=!re.value},rr=()=>{Be.visit(Y("projects.analysis",{project:l.project.slug}))},ar=async()=>{try{await Ce(!1),Be.post(Y("chapters.mark-complete",{project:l.project.slug,chapter:l.chapter.chapter_number}),{},{onSuccess:()=>{x.success("Chapter marked as complete")},onError:a=>{console.error("Mark complete failed:",a),x.error("Failed to mark chapter as complete")}})}catch(a){console.error("Error marking chapter complete:",a),x.error("Failed to save chapter before marking complete")}},sr=()=>{ea(w.value),Pe(),ct()},nr=a=>{(a.ctrlKey||a.metaKey)&&a.key==="s"&&(a.preventDefault(),Ce(),Xr()),(a.ctrlKey||a.metaKey)&&!a.shiftKey&&a.key==="z"&&(a.preventDefault(),Kt()),(a.ctrlKey||a.metaKey)&&a.shiftKey&&a.key==="z"&&(a.preventDefault(),Jt()),a.key==="F11"&&(a.preventDefault(),Zt())};gt(()=>{const a=()=>{A.value=window.innerWidth<1024};a(),window.addEventListener("resize",a);const e=localStorage.getItem("darkMode")==="true";R.value=e,document.documentElement.classList.toggle("dark",e),K.value=_e(),document.addEventListener("keydown",or),document.addEventListener("keydown",nr),document.addEventListener("fullscreenchange",He),document.addEventListener("webkitfullscreenchange",He),document.addEventListener("msfullscreenchange",He),ct(),ya()});const Pt=()=>{ht(()=>{if(q.value){const a=re.value?g.value?Ht.value:Qr.value:g.value?zt.value:Br.value;if(a)try{const e=a;if(!e)return;const n=e.$el||e;if(!n)return;let i=n.querySelector("[data-radix-scroll-area-viewport]");if(i||(i=n.querySelector("[data-viewport]")),i||(i=n.querySelector('[role="region"]')),i||(i=n.querySelector('div[style*="overflow"]')),i||(i=n.querySelector("[data-scrollable]")),!i){const d=n.querySelectorAll("div");for(const h of d){const _=window.getComputedStyle(h);if(_.overflow==="auto"||_.overflow==="scroll"||_.overflowY==="auto"||_.overflowY==="scroll"||h.scrollHeight>h.clientHeight){i=h;break}}}if(!i){const d=n.querySelector('.ProseMirror, [contenteditable="true"]');d&&(i=d.closest('div[style*="overflow"]')||d.closest("[data-radix-scroll-area-viewport]")||d.parentElement)}if(i){const d=i.scrollHeight-i.clientHeight;i.scrollTop=d,requestAnimationFrame(()=>{i.scrollTop=i.scrollHeight,i.scrollTo&&i.scrollTo({top:i.scrollHeight,behavior:"instant"})})}else console.warn("Could not find scrollable viewport in ScrollArea",{scrollAreaEl:n,children:n.children,mode:re.value?"preview":"editor",fullscreen:g.value})}catch(e){console.warn("Auto-scroll failed:",e)}else{const e=document.querySelector(".ProseMirror");e&&e.scrollIntoView({behavior:"instant",block:"end"})}}})},ya=()=>{const a=new URLSearchParams(window.location.search),e=a.get("ai_generate")==="true",n=a.get("generation_type");e&&n&&setTimeout(()=>{if(n==="progressive"){At("progressive");const i=new URL(window.location.href);i.searchParams.delete("ai_generate"),i.searchParams.delete("generation_type"),window.history.replaceState({},"",i.toString()),x.success("üöÄ AI Generation Started",{description:`Generating ${l.chapter.title} with AI assistance...`})}else if(n==="single"){At("progressive");const i=new URL(window.location.href);i.searchParams.delete("ai_generate"),i.searchParams.delete("generation_type"),window.history.replaceState({},"",i.toString()),x.success("üöÄ AI Generation Started",{description:`Generating ${l.chapter.title} with AI assistance...`})}},1e3)},or=a=>{if((a.ctrlKey||a.metaKey)&&!["INPUT","TEXTAREA","SELECT"].includes(a.target?.tagName))switch(a.key){case"ArrowLeft":a.preventDefault();const e=l.chapter.chapter_number-1;l.allChapters.find(h=>h.chapter_number===e)&&tt(e);break;case"ArrowRight":a.preventDefault();const i=l.chapter.chapter_number+1;l.allChapters.find(h=>h.chapter_number===i)&&tt(i);break}};gt(()=>{const a=e=>{const n=i=>{const{scrollTop:d,scrollHeight:h,clientHeight:_}=e,I=i.deltaY,ae=d<=0,H=d+_>=h;I<0&&ae||I>0&&H||i.stopPropagation()};return e.addEventListener("wheel",n,{passive:!0}),()=>e.removeEventListener("wheel",n)};ht(()=>{const e=document.querySelectorAll('[class*="overflow-y-auto"]'),n=[];e.forEach(i=>{if(i instanceof HTMLElement){const d=a(i);n.push(d)}}),window.__scrollChainCleanup=n})}),Aa(()=>{Jr(),$.value&&$.value.close(),document.removeEventListener("keydown",nr),document.removeEventListener("keydown",or);const a=window.__scrollChainCleanup;a&&Array.isArray(a)&&(a.forEach(e=>e()),delete window.__scrollChainCleanup),document.removeEventListener("fullscreenchange",He),document.removeEventListener("webkitfullscreenchange",He),document.removeEventListener("msfullscreenchange",He)}),Ne(()=>l.chapter,async a=>{k.value=a.title||"",w.value=a.content||"",ce.value=[],ka(),dr(),qe.value=ir(),await st(!1,{skipGeneration:!0}),await ht(()=>{pr(),vt()})},{immediate:!1});const ce=c([]),Ue=c(!1),Ve=c(!1),at=c(null),qe=c(!1),lr=(a,e)=>`defense_auto_generate_${a}_ch_${e}`,ir=()=>{try{return localStorage.getItem(lr(l.project.id,l.chapter.chapter_number))==="true"}catch(a){return console.warn("Failed to load defense auto-generation preference:",a),!1}},_a=a=>{try{localStorage.setItem(lr(l.project.id,l.chapter.chapter_number),String(a))}catch(e){console.warn("Failed to save defense auto-generation preference:",e)}};qe.value=ir(),Ne(w,sr),Ne(k,Pe);const le=P(()=>l.chapter),ur=async a=>{me.value=a,a&&Ca()&&await st(!1,{skipGeneration:!0})},Ca=()=>{if(!ce.value.length||!at.value)return!0;const a=new Date(Date.now()-360*60*1e3);return at.value<a},st=async(a=!1,e={})=>{if(Ue.value)return;const n=e.skipGeneration??!0;Ue.value=!0;try{console.log("Loading defense questions with params:",{project_id:l.project.id,chapter_number:le.value?.chapter_number,limit:5,force_refresh:a,skip_generation:n});const i=await ye.get(`/api/projects/${l.project.id}/defense/questions`,{params:{chapter_number:le.value?.chapter_number||null,limit:5,force_refresh:a?1:0,skip_generation:n?1:0},headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(console.log("Defense questions loaded:",i.data),console.log("Questions array:",i.data.questions),console.log("Questions count:",i.data.questions?i.data.questions.length:0),ce.value=i.data.questions||[],at.value=new Date,i.data.questions&&i.data.questions.length>0){const d=`defense_questions_${l.project.id}_chapter_${le.value?.chapter_number}`;localStorage.setItem(d,JSON.stringify({questions:i.data.questions,chapter_number:le.value?.chapter_number,loaded_at:new Date().toISOString()}))}else a||(console.log("No existing questions found for this chapter"),console.log(`Current word count: ${te.value}/${dt}`),console.log('User must click "Generate Questions" button to create defense questions'))}catch(i){if(console.error("Failed to load defense questions:",i),i.response)if(console.error("Response status:",i.response.status),console.error("Response data:",i.response.data),i.response.status===422){console.error("Validation errors:",i.response.data.errors);const d=Object.values(i.response.data.errors||{})[0];d&&Array.isArray(d)?x.error(`Validation Error: ${d[0]}`):x.error("Invalid request parameters. Please refresh the page.")}else i.response.status===500?x.error("Server error. Please try again later."):x.error("Failed to load defense questions");else i.request?(console.error("No response received:",i.request),x.error("Network error. Please check your connection.")):(console.error("Error setting up request:",i.message),x.error("An unexpected error occurred"));ce.value=[]}finally{Ue.value=!1}},vt=async()=>{!qe.value||Ve.value||Ue.value||nt.value||!qt.value||ce.value.length>0||await jt({autoTriggered:!0})},cr=a=>{qe.value=a,_a(a),a&&vt()};Ne(w,sr),Ne(k,Pe),Ne([te,qe],()=>{vt()});const jt=async(a={})=>{if(Ve.value)return;const e=a.autoTriggered??!1,n=Se.defense();if(Ie(n,"generate defense questions")){Ve.value=!0;try{const i=h=>h?h.replace(/<[^>]*>/g," ").trim().split(/\s+/).filter(_=>_.length>0).length:0,d=await ye.post(`/api/projects/${l.project.id}/defense/questions/generate`,{chapter_number:le.value.chapter_number},{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}});if(d.data&&d.data.questions){ce.value=d.data.questions,at.value=new Date;const h=d.data.questions.reduce((I,ae)=>{const H=i(ae.question),X=i(ae.suggested_answer),de=(ae.key_points||[]).reduce((fe,De)=>fe+i(De),0);return I+H+X+de},0),_=`defense_questions_${l.project.id}_chapter_${le.value?.chapter_number}`;localStorage.setItem(_,JSON.stringify({questions:d.data.questions,chapter_number:le.value?.chapter_number,loaded_at:new Date().toISOString()})),x.success(`Generated ${d.data.questions.length} new questions`),Je(h||Se.defense(),"Defense questions","chapter",l.chapter.id).catch(I=>console.error("Failed to record word usage (defense):",I)),nt.value=!0,Sa(),e&&console.log("Auto-generated defense questions after meeting threshold.")}}catch(i){console.error("Failed to generate defense questions:",i),x.error("Failed to generate defense questions")}finally{Ve.value=!1}}},{hasTriggeredGeneration:nt,startWatching:dr,stopWatching:ka,forceCheck:pr,getStatusMessage:vr,markGenerationTriggered:Sa}=fs(l.project,l.chapter,w),qt=na,gr=P(()=>{const a=te.value;return a>0&&a<dt&&!nt.value}),hr=la,fr=oa,mr=async(a,e)=>{try{await ye.patch(`/api/projects/${l.project.id}/defense/questions/${a}`,{user_marked_helpful:e},{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}});const n=ce.value.find(i=>i.id===a);n&&(n.user_marked_helpful=e),x.success(e?"Question marked as helpful":"Removed helpful mark")}catch(n){console.error("Failed to mark question:",n),x.error("Failed to update question")}},wr=async a=>{try{await ye.delete(`/api/projects/${l.project.id}/defense/questions/${a}`,{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),Accept:"application/json"}}),ce.value=ce.value.filter(e=>e.id!==a),localStorage.setItem(`defense_questions_${l.project.id}`,JSON.stringify({questions:ce.value,loaded_at:new Date().toISOString()})),x.success("Question hidden")}catch(e){console.error("Failed to hide question:",e),x.error("Failed to hide question")}};return gt(async()=>{const a=`defense_questions_${l.project.id}_chapter_${le.value?.chapter_number}`,e=localStorage.getItem(a);let n=!0;if(e){const i=JSON.parse(e),d=new Date(i.loaded_at),h=new Date(Date.now()-360*60*1e3);d>h&&i.chapter_number===le.value?.chapter_number&&(ce.value=i.questions,at.value=d,n=!1)}n&&await st(!1,{skipGeneration:!0}),dr(),await ht(()=>{pr(),vt()})}),gt(async()=>{await aa()}),(a,e)=>(C(),B(t(Pa),null,{default:o(()=>[K.value?(C(),B(t(f),{key:0,project:be.value,chapter:xe.value,"chapter-title":k.value,"chapter-content":w.value,"current-word-count":t(te),"target-word-count":ue.value,"progress-percentage":t(et),"writing-quality-score":t(ke),"is-valid":St.value,"is-saving":t(Ee),"show-preview":O.value,"is-generating":q.value,"generation-progress":S.value,"history-index":t(Zr),"content-history-length":t(Yr).length,"selected-text":V.value,"onUpdate:chapterTitle":e[0]||(e[0]=n=>k.value=n),"onUpdate:chapterContent":e[1]||(e[1]=n=>w.value=n),"onUpdate:selectedText":e[2]||(e[2]=n=>V.value=n),"onUpdate:showPreview":e[3]||(e[3]=n=>O.value=n),onSave:e[4]||(e[4]=n=>Qt(n)),onUndo:Kt,onRedo:Jt,onExitChatMode:wa},null,8,["project","chapter","chapter-title","chapter-content","current-word-count","target-word-count","progress-percentage","writing-quality-score","is-valid","is-saving","show-preview","is-generating","generation-progress","history-index","content-history-length","selected-text"])):Z.value?(C(),B(t(p),{key:1,project:be.value,chapter:xe.value,"chapter-title":k.value,"chapter-content":w.value,"current-word-count":t(te),"target-word-count":ue.value,"progress-percentage":t(et),onExitCitationMode:xa},null,8,["project","chapter","chapter-title","chapter-content","current-word-count","target-word-count","progress-percentage"])):g.value?(C(),z("div",ws,[e[54]||(e[54]=r("div",{class:"absolute inset-0 z-0 overflow-hidden pointer-events-none"},[r("div",{class:"absolute top-[-20%] left-[-10%] w-[50%] h-[50%] rounded-full bg-blue-500/5 blur-[120px]"}),r("div",{class:"absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] rounded-full bg-purple-500/5 blur-[120px]"})],-1)),r("div",bs,[r("div",xs,[s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[5]||(e[5]=n=>t(Be).visit(t(Y)("projects.show",l.project.slug))),variant:"ghost",size:"icon",class:"h-10 w-10 rounded-full hover:bg-primary/10 hover:text-primary transition-all duration-300"},{default:o(()=>[s(t($r),{class:"h-5 w-5"})]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[...e[32]||(e[32]=[r("p",null,"Back to Project",-1)])]),_:1})]),_:1}),r("div",ys,[s(_r,{as:"h1",class:"text-lg font-bold tracking-tight text-foreground/90 font-display",content:l.project.title},null,8,["content"]),r("div",_s,[s(t(Te),{variant:"outline",class:"h-5 px-2 rounded-full border-primary/20 bg-primary/5 text-primary font-medium"},{default:o(()=>[D(" Chapter "+m(l.chapter.chapter_number),1)]),_:1}),r("span",Cs,[e[33]||(e[33]=r("span",{class:"h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"},null,-1)),D(" "+m(t(te))+" words ",1)])])])]),r("div",ks,[r("div",Ss,[s(t(G),{onClick:e[6]||(e[6]=n=>ie.value=!ie.value),variant:ie.value?"secondary":"ghost",size:"sm",class:ve(["h-8 px-4 rounded-full text-xs font-medium transition-all duration-300",ie.value?"bg-primary/10 text-primary hover:bg-primary/15":"hover:bg-muted"])},{default:o(()=>[s(t(Sr),{class:"mr-2 h-3.5 w-3.5"}),e[34]||(e[34]=D(" Outline ",-1))]),_:1},8,["variant","class"]),e[36]||(e[36]=r("div",{class:"w-px h-4 bg-border/50 mx-1"},null,-1)),s(t(G),{onClick:e[7]||(e[7]=n=>Ae.value=!Ae.value),variant:Ae.value?"secondary":"ghost",size:"sm",class:ve(["h-8 px-4 rounded-full text-xs font-medium transition-all duration-300",Ae.value?"bg-primary/10 text-primary hover:bg-primary/15":"hover:bg-muted"])},{default:o(()=>[s(t(mt),{class:"mr-2 h-3.5 w-3.5"}),e[35]||(e[35]=D(" Assistant ",-1))]),_:1},8,["variant","class"])]),r("div",Es,[s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[8]||(e[8]=n=>M.value=!M.value),variant:M.value?"secondary":"ghost",size:"icon",class:"h-9 w-9 rounded-full transition-all hover:bg-muted"},{default:o(()=>[s(t(Rr),{class:"h-4.5 w-4.5 text-muted-foreground"})]),_:1},8,["variant"])]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,m(M.value?"Hide":"Show")+" Statistics",1)]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:er,variant:"ghost",size:"icon",class:"h-9 w-9 rounded-full transition-all hover:bg-muted"},{default:o(()=>[R.value?(C(),B(t(kr),{key:1,class:"h-4.5 w-4.5 text-muted-foreground"})):(C(),B(t(Cr),{key:0,class:"h-4.5 w-4.5 text-muted-foreground"}))]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[...e[37]||(e[37]=[r("p",null,"Toggle Theme",-1)])]),_:1})]),_:1}),s(Mt,{project:be.value,"current-chapter":xe.value,"all-chapters":je.value,size:"icon",variant:"ghost",class:"h-9 w-9 rounded-full hover:bg-muted"},null,8,["project","current-chapter","all-chapters"])])])]),r("div",Ts,[r("div",{class:"absolute top-0 left-0 h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(59,130,246,0.5)]",style:Xe({width:`${Math.min(t(et),100)}%`})},null,4)]),q.value?(C(),z("div",As,[r("div",$s,[e[43]||(e[43]=r("div",{class:"absolute inset-0 -skew-x-12 animate-pulse bg-gradient-to-r from-transparent via-white/10 to-transparent"},null,-1)),r("div",Rs,[r("div",Ps,[r("div",js,[r("div",qs,[s(t(mt),{class:"h-3 w-3 text-white"})]),e[38]||(e[38]=r("div",{class:"absolute inset-0 h-6 w-6 animate-ping rounded-full bg-gradient-to-br from-blue-500 to-purple-600 opacity-20"},null,-1))]),r("div",null,[e[39]||(e[39]=r("h4",{class:"text-xs font-semibold text-blue-900 dark:text-blue-100"},"AI Generator",-1)),r("p",Ds,m(b.value),1)])]),s(t(Te),{variant:"outline",class:"border-blue-300 text-xs text-blue-700 dark:border-blue-700 dark:text-blue-300"},{default:o(()=>[D(m(Math.round(u.value))+"% ",1)]),_:1})]),r("div",Ms,[r("div",Fs,[e[40]||(e[40]=r("span",{class:"text-xs text-blue-800 dark:text-blue-200"},"Generation Progress",-1)),r("span",Ns,m(E.value)+" / "+m(U.value)+" words",1)]),r("div",Ls,[r("div",{class:"absolute top-0 left-0 h-full rounded-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500 ease-out",style:Xe({width:`${u.value}%`})},[...e[41]||(e[41]=[r("div",{class:"absolute inset-0 animate-pulse bg-gradient-to-r from-transparent via-white/30 to-transparent"},null,-1)])],4),r("div",{class:"absolute top-0 left-0 h-full rounded-full bg-gradient-to-r from-blue-400 to-purple-400 opacity-50 blur-sm transition-all duration-500",style:Xe({width:`${u.value}%`})},null,4)])]),r("div",Os,[r("div",Ws,[b.value==="Initializing"?(C(),z("div",Is)):b.value==="Connecting"?(C(),z("div",Gs,[...e[42]||(e[42]=[r("div",{class:"h-2 w-0.5 animate-pulse rounded-full bg-blue-500"},null,-1),r("div",{class:"h-2 w-0.5 animate-pulse rounded-full bg-purple-500",style:{"animation-delay":"0.2s"}},null,-1),r("div",{class:"h-2 w-0.5 animate-pulse rounded-full bg-blue-500",style:{"animation-delay":"0.4s"}},null,-1)])])):b.value==="Generating"?(C(),z("div",zs)):b.value==="Complete"?(C(),z("div",Hs)):(C(),z("div",Us))]),r("p",Vs,m(S.value),1)])])])):pe("",!0),M.value?(C(),B(qr,{key:1,"show-statistics":M.value,"current-word-count":t(te),"writing-stats":t(kt),"quality-analysis":t(J),"is-analyzing":t(Vt),class:"relative z-20 mx-4 mt-2 rounded-lg border border-border/40 bg-background/60 backdrop-blur-md"},null,8,["show-statistics","current-word-count","writing-stats","quality-analysis","is-analyzing"])):pe("",!0),r("div",Bs,[s(br,{"enter-active-class":"transition-all duration-300 ease-in-out","enter-from-class":"-ml-72 opacity-0","enter-to-class":"ml-0 opacity-100","leave-active-class":"transition-all duration-300 ease-in-out","leave-from-class":"ml-0 opacity-100","leave-to-class":"-ml-72 opacity-0"},{default:o(()=>[ie.value?(C(),z("div",Qs,[r("div",Ks,[r("div",Js,[r("div",Xs,[e[44]||(e[44]=r("h2",{class:"text-sm font-semibold text-foreground mb-1"},"Table of Contents",-1)),r("p",Ys,m(je.value.length)+" Chapters ",1)]),(C(),B(ft,null,{fallback:o(()=>[...e[45]||(e[45]=[r("div",{class:"flex items-center justify-center p-8"},[r("div",{class:"h-6 w-6 animate-spin rounded-full border-2 border-primary border-t-transparent"})],-1)])]),default:o(()=>[s(t(j),{"all-chapters":je.value,"current-chapter":xe.value,project:be.value,outlines:a.project.outlines||[],"faculty-chapters":a.facultyChapters||[],"current-word-count":t(te),"target-word-count":ue.value,"writing-quality-score":t(ke),"chapter-content-length":w.value.length,onGoToChapter:tt,onGenerateNextChapter:Et},null,8,["all-chapters","current-chapter","project","outlines","faculty-chapters","current-word-count","target-word-count","writing-quality-score","chapter-content-length"])]),_:1}))])])])):pe("",!0)]),_:1}),r("div",Zs,[r("div",en,[r("div",tn,[s(t(bt),{class:"w-full max-w-[850px] min-h-[calc(100vh-180px)] flex flex-col bg-background shadow-xl shadow-black/5 ring-1 ring-black/5 dark:ring-white/10 rounded-xl overflow-hidden transition-all duration-300"},{default:o(()=>[s(t(yt),{class:"flex-shrink-0 border-b border-border/30 px-8 py-6 bg-background/50 backdrop-blur-sm sticky top-0 z-10"},{default:o(()=>[r("div",rn,[r("div",an,[s(t(Dt),{for:"chapter-title-fs",class:"text-xs font-medium text-muted-foreground uppercase tracking-wider"},{default:o(()=>[...e[46]||(e[46]=[D("Chapter Title",-1)])]),_:1}),s(t(xr),{id:"chapter-title-fs",modelValue:k.value,"onUpdate:modelValue":e[9]||(e[9]=n=>k.value=n),placeholder:"Enter chapter title...",class:"h-auto p-0 border-0 bg-transparent text-2xl font-bold placeholder:text-muted-foreground/40 focus-visible:ring-0 px-0"},null,8,["modelValue"])]),r("div",sn,[s(t(Te),{variant:a.chapter.status==="approved"?"default":"secondary",class:"rounded-full px-3"},{default:o(()=>[D(m(a.chapter.status.replace("_"," ")),1)]),_:1},8,["variant"]),s(t(Te),{variant:"outline",class:ve(["rounded-full px-3 transition-colors",{"text-green-600 border-green-200 bg-green-50 dark:bg-green-900/20 dark:border-green-800":(t(J)?.total_score||0)>=80,"text-yellow-600 border-yellow-200 bg-yellow-50 dark:bg-yellow-900/20 dark:border-yellow-800":(t(J)?.total_score||0)>=70&&(t(J)?.total_score||0)<80,"text-orange-600 border-orange-200 bg-orange-50 dark:bg-orange-900/20 dark:border-orange-800":(t(J)?.total_score||0)>=60&&(t(J)?.total_score||0)<70,"text-red-600 border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800":(t(J)?.total_score||0)<60}])},{default:o(()=>[D(m(t(J)?.total_score?Math.round(t(J).total_score):t(ke))+"% Quality ",1)]),_:1},8,["class"])])])]),_:1}),s(t(xt),{class:"flex min-h-0 flex-1 flex-col p-0"},{default:o(()=>[r("div",nn,[r("div",on,[s(t(G),{onClick:tr,variant:re.value?"default":"ghost",size:"sm",class:"h-7 text-xs rounded-full"},{default:o(()=>[s(t(Ft),{class:"mr-1.5 h-3.5 w-3.5"}),D(" "+m(re.value?"Edit":"Preview"),1)]),_:1},8,["variant"])]),r("div",ln,[r("div",un,m(a.aiChapterAnalysis?.section.name||a.getSectionInfo(a.nextSection).name),1),r("div",cn,m(a.aiChapterAnalysis?.section.description||a.getSectionInfo(a.nextSection).description),1)])]),r("div",dn,[Qe(s(Tr,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=n=>w.value=n),placeholder:"Start writing your chapter...","min-height":"500px",class:"min-h-[500px] px-8 py-6",ref_key:"richTextEditor",ref:pt,"show-toolbar":!0,"onUpdate:selectedText":e[11]||(e[11]=n=>{V.value=n})},null,8,["modelValue"]),[[Ke,!re.value]]),Qe(r("div",pn,[s(Er,{content:w.value,"show-font-controls":!1,class:"prose-lg mx-auto",style:{"font-family":"'Times New Roman', serif","line-height":"1.8"}},null,8,["content"])],512),[[Ke,re.value]])])]),_:1}),r("div",vn,[r("div",gn,m(t(Ee)?"Saving...":"All changes saved"),1),r("div",hn,[s(t(G),{onClick:e[12]||(e[12]=n=>t(Ce)(!1)),disabled:!St.value||t(Ee),size:"sm",variant:"ghost",class:"h-8 rounded-full"},{default:o(()=>[s(t(Pr),{class:"mr-2 h-3.5 w-3.5"}),e[47]||(e[47]=D(" Save Draft ",-1))]),_:1},8,["disabled"]),s(t(G),{onClick:rr,variant:"outline",size:"sm",class:"h-8 rounded-full"},{default:o(()=>[s(t(ot),{class:"mr-2 h-3.5 w-3.5"}),e[48]||(e[48]=D(" Run Bulk Analysis ",-1))]),_:1}),s(t(G),{onClick:ar,disabled:t(Ee),size:"sm",class:"h-8 rounded-full bg-gradient-to-r from-primary to-primary/90 shadow-sm hover:shadow-md transition-all"},{default:o(()=>[s(t(jr),{class:"mr-2 h-3.5 w-3.5"}),e[49]||(e[49]=D(" Complete ",-1))]),_:1},8,["disabled"])])])]),_:1}),e[50]||(e[50]=r("div",{class:"h-12"},null,-1))])])]),s(br,{"enter-active-class":"transition-all duration-300 ease-in-out","enter-from-class":"-mr-72 opacity-0","enter-to-class":"mr-0 opacity-100","leave-active-class":"transition-all duration-300 ease-in-out","leave-from-class":"mr-0 opacity-100","leave-to-class":"-mr-72 opacity-0"},{default:o(()=>[Ae.value?(C(),z("div",fn,[r("div",mn,[r("div",wn,[(C(),B(ft,null,{fallback:o(()=>[...e[51]||(e[51]=[r("div",{class:"flex items-center justify-center p-8"},[r("div",{class:"h-6 w-6 animate-spin rounded-full border-2 border-primary border-t-transparent"})],-1)])]),default:o(()=>[s(t(T),{project:be.value,chapter:xe.value,"is-generating":q.value,"selected-text":V.value,"is-loading-suggestions":Ye.value,"show-citation-helper":$e.value,"chapter-content":w.value,"current-word-count":t(te),"target-word-count":ue.value,onStartStreamingGeneration:Tt,onGetAiSuggestions:$t,"onUpdate:showCitationHelper":e[13]||(e[13]=n=>$e.value=n),onInsertCitation:Yt,onCheckCitations:Rt},null,8,["project","chapter","is-generating","selected-text","is-loading-suggestions","show-citation-helper","chapter-content","current-word-count","target-word-count"])]),_:1})),(C(),B(ft,null,{fallback:o(()=>[...e[52]||(e[52]=[r("div",{class:"flex items-center justify-center p-4"},[r("div",{class:"h-4 w-4 animate-spin rounded-full border-2 border-muted border-t-transparent"})],-1)])]),default:o(()=>[s(t(y),{"show-defense-prep":me.value,questions:ce.value,"is-loading":Ue.value,"is-generating":Ve.value,"chapter-context":{chapter_number:le.value.chapter_number,chapter_title:le.value.title,word_count:t(te)},"defense-watcher":{meetsThreshold:t(qt),shouldShowProgress:gr.value,progressPercentage:t(hr),wordsRemaining:t(fr),hasTriggeredGeneration:t(nt),threshold:t(dt),statusMessage:t(vr)()},"auto-generate-enabled":qe.value,"onUpdate:showDefensePrep":ur,onGenerateMore:jt,onToggleAutoGenerate:cr,onRefresh:e[14]||(e[14]=()=>st(!0,{skipGeneration:!0})),onMarkHelpful:mr,onHideQuestion:wr},null,8,["show-defense-prep","questions","is-loading","is-generating","chapter-context","defense-watcher","auto-generate-enabled"])]),_:1})),(C(),B(ft,null,{fallback:o(()=>[...e[53]||(e[53]=[r("div",{class:"flex items-center justify-center p-4"},[r("div",{class:"h-4 w-4 animate-spin rounded-full border-2 border-muted border-t-transparent"})],-1)])]),default:o(()=>[s(t(v),{"chapter-id":le.value.id,content:w.value},null,8,["chapter-id","content"])]),_:1}))])])])):pe("",!0)]),_:1})])])):(C(),B(Ra,{key:3,class:"h-screen overflow-hidden"},{default:o(()=>[r("div",bn,[r("div",xn,[r("div",yn,[r("div",_n,[s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[15]||(e[15]=n=>t(Be).visit(t(Y)("projects.show",l.project.slug))),variant:"ghost",size:"icon",class:"hidden sm:flex"},{default:o(()=>[s(t($r),{class:"h-4 w-4"})]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[...e[55]||(e[55]=[r("p",null,"Back to Project",-1)])]),_:1})]),_:1}),r("div",null,[s(_r,{as:"h1",class:"text-xl font-bold sm:text-2xl",content:l.project.title},null,8,["content"]),r("p",Cn," Chapter "+m(l.chapter.chapter_number)+" ‚Ä¢ "+m(t(te))+" / "+m(ue.value)+" words ",1)])]),r("div",kn,[s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[16]||(e[16]=n=>he.value=!0),variant:"outline",size:"icon",class:"lg:hidden"},{default:o(()=>[s(t(Sr),{class:"h-4 w-4"})]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[...e[56]||(e[56]=[r("p",null,"Chapter Navigation",-1)])]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[17]||(e[17]=n=>W.value=!0),variant:"outline",size:"icon",class:"lg:hidden"},{default:o(()=>[s(t(mt),{class:"h-4 w-4"})]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[...e[57]||(e[57]=[r("p",null,"AI Tools & Defense Prep",-1)])]),_:1})]),_:1}),r("div",Sn,[s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:ma,variant:K.value?"default":"outline",size:"sm"},{default:o(()=>[s(t(Oa),{class:"h-4 w-4"})]),_:1},8,["variant"])]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,m(K.value?"Exit":"Open")+" AI Chat Assistant",1)]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:ba,variant:Z.value?"default":"outline",size:"sm"},{default:o(()=>[s(t(ot),{class:"h-4 w-4"})]),_:1},8,["variant"])]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,m(Z.value?"Exit":"Open")+" Citation Verification",1)]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[18]||(e[18]=n=>M.value=!M.value),variant:M.value?"default":"outline",size:"sm"},{default:o(()=>[s(t(Rr),{class:"h-4 w-4"})]),_:1},8,["variant"])]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,m(M.value?"Hide":"Show")+" Writing Statistics",1)]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:er,variant:"outline",size:"sm"},{default:o(()=>[R.value?(C(),B(t(kr),{key:1,class:"h-4 w-4"})):(C(),B(t(Cr),{key:0,class:"h-4 w-4"}))]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,"Switch to "+m(R.value?"Light":"Dark")+" Mode",1)]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:Zt,variant:g.value?"default":"outline",size:"sm"},{default:o(()=>[s(t(Da),{class:"h-4 w-4"})]),_:1},8,["variant"])]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,m(g.value?"Exit":"Enter")+" Fullscreen Mode (F11)",1)]),_:1})]),_:1}),s(Mt,{project:be.value,"current-chapter":xe.value,"all-chapters":je.value,size:"sm"},null,8,["project","current-chapter","all-chapters"])])])]),r("div",En,[r("div",Tn,[e[58]||(e[58]=r("span",{class:"text-sm font-medium"},"Writing Progress",-1)),r("span",An,m(t(te))+" / "+m(ue.value)+" words ("+m(Math.round(t(et)))+"%)",1)]),s(t(Mr),{"model-value":Number(t(et)),class:"h-2"},null,8,["model-value"])]),q.value?(C(),z("div",$n,[r("div",Rn,[e[65]||(e[65]=r("div",{class:"absolute inset-0 -skew-x-12 animate-pulse bg-gradient-to-r from-transparent via-white/10 to-transparent"},null,-1)),r("div",Pn,[r("div",jn,[r("div",qn,[r("div",Dn,[s(t(mt),{class:"h-4 w-4 text-white"})]),e[59]||(e[59]=r("div",{class:"absolute inset-0 h-8 w-8 animate-ping rounded-full bg-gradient-to-br from-blue-500 to-purple-600 opacity-20"},null,-1))]),r("div",null,[e[60]||(e[60]=r("h4",{class:"text-sm font-semibold text-blue-900 dark:text-blue-100"},"AI Chapter Generator ",-1)),r("p",Mn,m(b.value),1)])]),s(t(Te),{variant:"outline",class:"border-blue-300 text-xs text-blue-700 dark:border-blue-700 dark:text-blue-300"},{default:o(()=>[D(m(Math.round(u.value))+"% ",1)]),_:1})]),r("div",Fn,[r("div",Nn,[e[61]||(e[61]=r("span",{class:"text-xs text-blue-800 dark:text-blue-200"},"Generation Progress",-1)),r("span",Ln,m(E.value)+" / "+m(U.value)+" words",1)]),r("div",On,[r("div",{class:"absolute top-0 left-0 h-full rounded-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500 ease-out",style:Xe({width:`${u.value}%`})},[...e[62]||(e[62]=[r("div",{class:"absolute inset-0 animate-pulse bg-gradient-to-r from-transparent via-white/30 to-transparent"},null,-1)])],4),r("div",{class:"absolute top-0 left-0 h-full rounded-full bg-gradient-to-r from-blue-400 to-purple-400 opacity-50 blur-sm transition-all duration-500",style:Xe({width:`${u.value}%`})},null,4)])]),r("div",Wn,[r("div",In,[b.value==="Initializing"?(C(),z("div",Gn)):b.value==="Connecting"?(C(),z("div",zn,[...e[63]||(e[63]=[r("div",{class:"h-3 w-1 animate-pulse rounded-full bg-blue-500"},null,-1),r("div",{class:"h-3 w-1 animate-pulse rounded-full bg-purple-500",style:{"animation-delay":"0.2s"}},null,-1),r("div",{class:"h-3 w-1 animate-pulse rounded-full bg-blue-500",style:{"animation-delay":"0.4s"}},null,-1)])])):b.value==="Generating"?(C(),z("div",Hn)):b.value==="Complete"?(C(),z("div",Un)):(C(),z("div",Vn))]),r("p",Bn,m(S.value),1)]),b.value==="Generating"&&E.value>50?(C(),z("div",Qn,[r("div",Kn,[e[64]||(e[64]=r("span",{class:"text-blue-700 dark:text-blue-300"},"Writing Quality",-1)),r("div",Jn,[r("div",Xn,[(C(),z(Lt,null,Ot(5,n=>r("div",{key:n,class:ve(["h-2 w-2 rounded-full",n<=Math.ceil(t(ke)/20)?"bg-yellow-400":"bg-blue-200 dark:bg-blue-800"])},null,2)),64))]),r("span",Yn,m(t(ke))+"%",1)])])])):pe("",!0)])])):pe("",!0),s(qr,{"show-statistics":M.value,"current-word-count":t(te),"writing-stats":t(kt),"quality-analysis":t(J),"is-analyzing":t(Vt)},null,8,["show-statistics","current-word-count","writing-stats","quality-analysis","is-analyzing"]),r("div",Zn,[Qe(r("div",eo,[r("div",to,[s(t(j),{"all-chapters":je.value,"current-chapter":xe.value,project:be.value,outlines:a.project.outlines||[],"faculty-chapters":a.facultyChapters||[],"current-word-count":t(te),"target-word-count":ue.value,"writing-quality-score":t(ke),"chapter-content-length":w.value.length,onGoToChapter:tt,onGenerateNextChapter:Et},null,8,["all-chapters","current-chapter","project","outlines","faculty-chapters","current-word-count","target-word-count","writing-quality-score","chapter-content-length"])])],512),[[Ke,!Q.value]]),r("div",{class:ve(["transition-all duration-300",Q.value&&ee.value?"lg:col-span-12":Q.value?"lg:col-span-9":ee.value?"lg:col-span-10":"lg:col-span-7"])},[s(t(bt),{class:"border-[0.5px] border-border/50 transition-all duration-300"},{default:o(()=>[s(t(yt),{class:"pb-4"},{default:o(()=>[r("div",ro,[r("div",ao,[s(t(G),{variant:"ghost",size:"icon",class:"h-6 w-6 hidden lg:flex mr-1 text-muted-foreground hover:text-foreground",onClick:e[19]||(e[19]=n=>Q.value=!Q.value),title:Q.value?"Expand Sidebar":"Collapse Sidebar"},{default:o(()=>[Q.value?(C(),B(t(Ia),{key:1,class:"h-4 w-4"})):(C(),B(t(Wa),{key:0,class:"h-4 w-4"}))]),_:1},8,["title"]),s(t(Wt),{class:"text-lg"},{default:o(()=>[D("Chapter "+m(a.chapter.chapter_number),1)]),_:1})]),r("div",so,[s(t(Te),{variant:a.chapter.status==="approved"?"default":"secondary"},{default:o(()=>[D(m(a.chapter.status.replace("_"," ")),1)]),_:1},8,["variant"]),s(t(Te),{variant:"outline",class:ve(["text-xs",{"text-green-600 border-green-200 bg-green-50":(t(J)?.total_score||0)>=80,"text-yellow-600 border-yellow-200 bg-yellow-50":(t(J)?.total_score||0)>=70&&(t(J)?.total_score||0)<80,"text-orange-600 border-orange-200 bg-orange-50":(t(J)?.total_score||0)>=60&&(t(J)?.total_score||0)<70,"text-red-600 border-red-200 bg-red-50":(t(J)?.total_score||0)<60}])},{default:o(()=>[D(m(t(J)?.total_score?Math.round(t(J).total_score):t(ke))+"% Quality ",1)]),_:1},8,["class"]),s(t(G),{variant:"ghost",size:"icon",class:"h-6 w-6 hidden lg:flex ml-1 text-muted-foreground hover:text-foreground",onClick:e[20]||(e[20]=n=>ee.value=!ee.value),title:ee.value?"Expand Tools":"Collapse Tools"},{default:o(()=>[ee.value?(C(),B(t(Fa),{key:1,class:"h-4 w-4"})):(C(),B(t(Ma),{key:0,class:"h-4 w-4"}))]),_:1},8,["title"])])])]),_:1}),s(t(xt),{class:"space-y-4"},{default:o(()=>[r("div",no,[s(t(Dt),{for:"chapter-title"},{default:o(()=>[...e[66]||(e[66]=[D("Chapter Title",-1)])]),_:1}),s(t(xr),{id:"chapter-title",modelValue:k.value,"onUpdate:modelValue":e[21]||(e[21]=n=>k.value=n),placeholder:"Enter chapter title...",class:"text-lg font-medium"},null,8,["modelValue"])]),r("div",oo,[r("div",lo,[s(t(Dt),{for:"chapter-content"},{default:o(()=>[...e[67]||(e[67]=[D("Content",-1)])]),_:1}),r("div",io,[s(t(G),{onClick:tr,variant:re.value?"default":"outline",size:"sm"},{default:o(()=>[s(t(Ft),{class:"mr-1 h-4 w-4"}),D(" "+m(re.value?"Edit Mode":"Preview Mode"),1)]),_:1},8,["variant"])])]),Qe(s(t(yr),{ref_key:"editorFullscreenScrollRef",ref:zt,class:"h-[calc(100vh-320px)] w-full"},{default:o(()=>[s(Tr,{modelValue:w.value,"onUpdate:modelValue":e[22]||(e[22]=n=>w.value=n),placeholder:"Start writing your chapter...","min-height":"600px",class:"text-base leading-relaxed",ref_key:"richTextEditorFullscreen",ref:rt,"onUpdate:selectedText":e[23]||(e[23]=n=>{V.value=n,console.log("üìã ChapterEditor Fullscreen - Selected text updated:",{length:n.length,preview:n.substring(0,50)+(n.length>50?"...":"")})})},null,8,["modelValue"])]),_:1},512),[[Ke,!re.value]]),Qe(s(t(yr),{ref_key:"previewFullscreenScrollRef",ref:Ht,class:"h-[calc(100vh-320px)] w-full"},{default:o(()=>[s(Er,{content:w.value,"show-font-controls":!1,class:"min-h-[600px] rounded-md border border-border/50 bg-background p-6",style:{"font-family":"'Times New Roman', serif","line-height":"1.8"}},null,8,["content"])]),_:1},512),[[Ke,re.value]])]),r("div",uo,[s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[24]||(e[24]=n=>t(Ce)(!1)),disabled:!St.value||t(Ee),size:"sm",class:"flex-1 sm:flex-none"},{default:o(()=>[s(t(Pr),{class:"mr-1 h-3 w-3 sm:mr-2 sm:h-4 sm:w-4"}),r("span",co,m(t(Ee)?"Saving...":`Save
                                                        Draft`),1),r("span",po,m(t(Ee)?"Saving...":"Save"),1)]),_:1},8,["disabled"])]),_:1}),s(t(oe),null,{default:o(()=>[...e[68]||(e[68]=[r("p",null,"Save chapter as draft (Ctrl+S)",-1)])]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:rr,variant:"outline",size:"sm",class:"flex-1 sm:flex-none"},{default:o(()=>[s(t(ot),{class:"mr-1 h-3 w-3 sm:mr-2 sm:h-4 sm:w-4"}),e[69]||(e[69]=r("span",{class:"hidden sm:inline"},"Bulk Analysis",-1)),e[70]||(e[70]=r("span",{class:"sm:hidden"},"Analyze",-1))]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[...e[71]||(e[71]=[r("p",null,"Open bulk chapter analysis to score this project.",-1)])]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:e[25]||(e[25]=n=>O.value=!O.value),variant:"outline",size:"sm",class:"flex-1 sm:flex-none"},{default:o(()=>[O.value?(C(),B(t(Ga),{key:1,class:"mr-1 h-3 w-3 sm:mr-2 sm:h-4 sm:w-4"})):(C(),B(t(Ft),{key:0,class:"mr-1 h-3 w-3 sm:mr-2 sm:h-4 sm:w-4"})),r("span",vo,m(O.value?"Edit":"Preview"),1),r("span",go,m(O.value?"Edit":"Preview"),1)]),_:1})]),_:1}),s(t(oe),null,{default:o(()=>[r("p",null,m(O.value?"Switch to edit mode":"Switch to preview mode"),1)]),_:1})]),_:1}),s(t(se),null,{default:o(()=>[s(t(ne),{asChild:""},{default:o(()=>[s(t(G),{onClick:ar,disabled:t(Ee),size:"sm",class:"flex-1 sm:flex-none"},{default:o(()=>[s(t(jr),{class:"mr-1 h-3 w-3 sm:mr-2 sm:h-4 sm:w-4"}),e[72]||(e[72]=r("span",{class:"hidden sm:inline"},"Save & Mark Complete",-1)),e[73]||(e[73]=r("span",{class:"sm:hidden"},"Complete",-1))]),_:1},8,["disabled"])]),_:1}),s(t(oe),null,{default:o(()=>[...e[74]||(e[74]=[r("p",null,"Mark chapter as complete (requires 80% of target word count)",-1)])]),_:1})]),_:1}),s(Mt,{project:be.value,"current-chapter":xe.value,"all-chapters":je.value,size:"sm",variant:"outline",class:"flex-1 sm:flex-none"},null,8,["project","current-chapter","all-chapters"])])]),_:1})]),_:1})],2),Qe(r("div",ho,[r("div",fo,[s(t(T),{project:be.value,chapter:xe.value,"is-generating":q.value,"selected-text":V.value,"is-loading-suggestions":Ye.value,"show-citation-helper":$e.value,"chapter-content":w.value,"current-word-count":t(te),"target-word-count":ue.value,onStartStreamingGeneration:Tt,onGetAiSuggestions:$t,"onUpdate:showCitationHelper":e[26]||(e[26]=n=>$e.value=n),onInsertCitation:Yt,onCheckCitations:Rt},null,8,["project","chapter","is-generating","selected-text","is-loading-suggestions","show-citation-helper","chapter-content","current-word-count","target-word-count"]),s(t(y),{"show-defense-prep":me.value,questions:ce.value,"is-loading":Ue.value,"is-generating":Ve.value,"chapter-context":{chapter_number:le.value.chapter_number,chapter_title:le.value.title,word_count:t(te)},"defense-watcher":{meetsThreshold:t(qt),shouldShowProgress:gr.value,progressPercentage:t(hr),wordsRemaining:t(fr),hasTriggeredGeneration:t(nt),threshold:t(dt),statusMessage:t(vr)()},"auto-generate-enabled":qe.value,"onUpdate:showDefensePrep":ur,onGenerateMore:jt,onToggleAutoGenerate:cr,onRefresh:e[27]||(e[27]=()=>st(!0,{skipGeneration:!0})),onMarkHelpful:mr,onHideQuestion:wr},null,8,["show-defense-prep","questions","is-loading","is-generating","chapter-context","defense-watcher","auto-generate-enabled"])])],512),[[Ke,!ee.value]])]),s(t(L),{"show-left-sidebar":he.value,"show-right-sidebar":W.value,"is-mobile":A.value,"all-chapters":je.value,"current-chapter":xe.value,project:be.value,"current-word-count":t(te),"target-word-count":ue.value,"writing-quality-score":t(ke),"chapter-content-length":w.value.length,"is-generating":q.value,"selected-text":V.value,"is-loading-suggestions":Ye.value,"show-citation-helper":$e.value,"chapter-content":w.value,"onUpdate:showLeftSidebar":e[28]||(e[28]=n=>he.value=n),"onUpdate:showRightSidebar":e[29]||(e[29]=n=>W.value=n),onGoToChapter:tt,onGenerateNextChapter:Et,onStartStreamingGeneration:Tt,onGetAiSuggestions:$t,"onUpdate:showCitationHelper":e[30]||(e[30]=n=>$e.value=n),onCheckCitations:Rt},null,8,["show-left-sidebar","show-right-sidebar","is-mobile","all-chapters","current-chapter","project","current-word-count","target-word-count","writing-quality-score","chapter-content-length","is-generating","selected-text","is-loading-suggestions","show-citation-helper","chapter-content"]),s(ja,{open:t(Gt),"current-balance":t(Fr),"required-words":t(Nr),action:t(Lr),"onUpdate:open":e[31]||(e[31]=n=>Gt.value=n),onClose:t(Wr)},null,8,["open","current-balance","required-words","action","onClose"]),We.value?(C(),z("div",mo,[s(t(bt),{class:"w-full max-w-md mx-4 bg-white dark:bg-slate-900 border-amber-500/50"},{default:o(()=>[s(t(yt),null,{default:o(()=>[s(t(Wt),{class:"flex items-center gap-2 text-amber-600 dark:text-amber-400"},{default:o(()=>[...e[75]||(e[75]=[r("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1),D(" Generation Interrupted ",-1)])]),_:1})]),_:1}),s(t(xt),null,{default:o(()=>[r("p",wo,[e[76]||(e[76]=D(" The connection was lost during generation, but ",-1)),r("span",bo,m(ut.value)+" words",1),e[77]||(e[77]=D(" may have been saved to the server. ",-1))]),e[80]||(e[80]=r("p",{class:"text-sm text-slate-500 dark:text-slate-400 mb-6"}," Reload the page to recover your content, or dismiss this dialog to continue with what's currently displayed. ",-1)),r("div",xo,[s(t(G),{onClick:va,class:"flex-1 bg-amber-600 hover:bg-amber-700 text-white"},{default:o(()=>[...e[78]||(e[78]=[r("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),D(" Reload & Recover ",-1)])]),_:1}),s(t(G),{onClick:ga,variant:"outline",class:"flex-1"},{default:o(()=>[...e[79]||(e[79]=[D(" Dismiss ",-1)])]),_:1})])]),_:1})]),_:1})])):pe("",!0)])])]),_:1}))]),_:1}))}});export{Al as default};
