import{a as ie}from"./AppLayout.vue_vue_type_script_setup_true_lang-2vqHzDZO.js";import{_ as ce}from"./index-DCGYk7ZE.js";import{_ as k}from"./index-D4mJyiz8.js";import{_ as S,a as A}from"./CardContent.vue_vue_type_script_setup_true_lang-CtTakpSW.js";import{_ as $,a as I}from"./CardTitle.vue_vue_type_script_setup_true_lang-XJ5or5ZK.js";import{_ as ue}from"./Checkbox.vue_vue_type_script_setup_true_lang-jW0orlWc.js";import{_ as U}from"./Progress.vue_vue_type_script_setup_true_lang-DwlWDfQ5.js";import{_ as de}from"./ScrollArea.vue_vue_type_script_setup_true_lang-DltzEvp9.js";import{_ as me}from"./WordBalanceDisplay.vue_vue_type_script_setup_true_lang-DBc7hWuL.js";import{bu as pe,bt as f,ck as L,bC as fe,bB as _e,cn as h,co as c,cp as r,cq as l,bF as a,cr as o,cI as M,ce as ve,cl as C,cV as ye,cs as _,cE as he,dW as ge,gB as be,ct as u,cD as m,cT as W,di as R,gM as xe,gN as we,cM as ke,cb as P,cj as y}from"./vendor-B5jlBrgV.js";import{_ as z}from"./SafeHtmlText.vue_vue_type_script_setup_true_lang-tt96GLrc.js";import{_ as Ce}from"./PurchaseModal.vue_vue_type_script_setup_true_lang-DMxFPDrF.js";import{u as Be,r as Ne}from"./useWordBalance-D_NxFp97.js";import"./UserInfo.vue_vue_type_script_setup_true_lang-w4YHLOMg.js";import"./TooltipTrigger.vue_vue_type_script_setup_true_lang-C5iiu9qR.js";import"./Sonner.vue_vue_type_script_setup_true_lang-sxjlERgN.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-BodEwO0Z.js";import"./useAppearance-D3We0oPJ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./PWAInstallPrompt.vue_vue_type_script_setup_true_lang-D12IZ_KU.js";import"./DialogContent.vue_vue_type_script_setup_true_lang-DATQht2f.js";import"./DialogDescription.vue_vue_type_script_setup_true_lang-DsP71UmP.js";import"./DialogFooter.vue_vue_type_script_setup_true_lang-B5lGGt-M.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-Cb9j7AhV.js";const je={class:"max-w-6xl mx-auto py-6 px-4 space-y-6"},Se={class:"flex items-center justify-between"},Ae={class:"flex items-center gap-3"},$e={class:"flex flex-wrap items-center gap-2"},Ie={class:"divide-y divide-border"},Me={class:"flex-1"},Pe={class:"flex items-center gap-2 text-sm font-medium"},ze={class:"text-muted-foreground"},Fe={class:"text-xs text-muted-foreground flex items-center gap-3"},Ve={key:0},qe={key:1,class:"text-amber-500 flex items-center gap-1"},Ue={class:"flex items-center justify-between text-sm"},Le={class:"font-medium"},We={class:"text-xs text-muted-foreground"},Re={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},De={class:"flex items-center justify-between text-sm font-medium mb-1"},Te={key:0},Ee={class:"text-xs text-muted-foreground line-clamp-2"},Je={key:0,class:"mt-2"},Oe={class:"text-[11px] text-muted-foreground mt-1"},Ge={key:1,class:"text-xs text-muted-foreground mt-2"},ht=pe({__name:"BulkAnalysis",props:{project:{}},setup(D){const p=D,B=t=>{const s=t.latest_analysis||t.latestAnalysis||null;return{id:Number(t.id),chapter_number:Number(t.chapter_number),title:t.title,word_count:Number(t.word_count||0),latest_analysis:s?{...s,total_score:Number(s.total_score??0),completion_percentage:Number(s.completion_percentage??0)}:null}},i=f(p.project.chapters?.map(B)||[]),n=f(i.value.map(t=>t.id)),g=f(!1),N=f(!1),b=f(null),d=f(null),x=f(null),{showPurchaseModal:T,requiredWordsForModal:E,actionDescriptionForModal:J,checkAndPrompt:O,closePurchaseModal:G,estimates:H,balance:K,refreshBalance:Q}=Be(),X=()=>{if(typeof window>"u")return[];try{return JSON.parse(localStorage.getItem("chargedAnalysisBatches")||"[]")}catch{return[]}},j=f(new Set(X())),Y=()=>{typeof window>"u"||localStorage.setItem("chargedAnalysisBatches",JSON.stringify([...j.value]))},Z=t=>{j.value.add(t),Y()},ee=t=>t?j.value.has(Number(t)):!1,F=L(()=>n.value.length),te=L(()=>{if(!d.value?.batch?.total_chapters)return 0;const t=d.value.batch.completed_chapters||0,s=d.value.batch.failed_chapters||0;return Math.round((t+s)/d.value.batch.total_chapters*100)}),V=async()=>{try{const{data:t}=await P.get(C("api.projects.analysis.results",p.project.slug));if(t.success&&t.chapters){i.value=t.chapters.map(B);const s=new Set(i.value.map(e=>e.id));n.value=n.value.filter(e=>s.has(e)),n.value.length===0&&(n.value=i.value.map(e=>e.id))}}catch(t){console.error("Failed to load analysis results",t),y.error("Could not load analysis results"),!i.value.length&&p.project.chapters?.length&&(i.value=p.project.chapters.map(B),n.value=i.value.map(s=>s.id))}},q=async()=>{if(!(!b.value||N.value)){N.value=!0;try{const{data:t}=await P.get(C("api.projects.analysis.batch",{project:p.project.slug,batch:b.value}));t.success&&(d.value=t,["completed","failed","cancelled"].includes(t.batch.status)&&(w(),y.success("Analysis finished"),t.batch.status==="completed"&&await ae(t.batch),await V()))}catch(t){console.error("Polling failed",t),y.error("Failed to poll analysis status"),w()}finally{N.value=!1}}},se=()=>{w(),q(),x.value=window.setInterval(q,3e3)},w=()=>{x.value&&(clearInterval(x.value),x.value=null)};fe(()=>w());const ae=async t=>{const s=Number(t?.id);if(!s||ee(s))return;const e=Number(t?.consumed_words??t?.required_words??0);if(!(!e||Number.isNaN(e)))try{await Ne(e,"Bulk chapter analysis","analysis_batch",s),Z(s),await Q()}catch(v){console.error("Failed to record bulk analysis usage",v)}},le=async()=>{if(n.value.length===0){y.error("Select at least one chapter to analyze");return}const t=i.value.length?Math.round(i.value.reduce((e,v)=>e+Math.max(500,v.word_count||0),0)/i.value.length):1500,s=H.chapter(t)*n.value.length;if(O(s,"run bulk analysis")){g.value=!0;try{const{data:e}=await P.post(C("api.projects.analysis.start",p.project.slug),{chapter_ids:n.value});e.success?(b.value=e.batch_id,d.value=null,se(),y.success("Analysis started")):y.error(e.error||"Unable to start analysis")}catch(e){console.error("Failed to start analysis",e),y.error(e.response?.data?.error||"Failed to start analysis")}finally{g.value=!1}}},oe=(t,s)=>{const e=Number(t);if(s===!0){n.value.includes(e)||(n.value=[...n.value,e]);return}n.value=n.value.filter(v=>v!==e)},re=()=>{n.value=i.value.map(t=>t.id)},ne=()=>{n.value=[]};return _e(async()=>{await V()}),(t,s)=>(c(),h(ie,{title:"Bulk Analysis"},{default:r(()=>[l(a(me),null,{default:r(()=>[o("div",je,[o("div",Se,[o("div",Ae,[l(a(k),{variant:"ghost",size:"icon",onClick:s[0]||(s[0]=e=>a(ve).visit(a(C)("projects.show",p.project.slug)))},{default:r(()=>[l(a(ye),{class:"h-4 w-4"})]),_:1}),o("div",null,[l(z,{as:"h1",class:"text-xl font-semibold text-foreground",content:p.project.title},null,8,["content"]),s[1]||(s[1]=o("p",{class:"text-sm text-muted-foreground"},"Run quality analysis across selected chapters",-1))])]),l(a(ce),{variant:"outline",class:"gap-2"},{default:r(()=>[l(a(he),{class:"h-4 w-4"}),s[2]||(s[2]=_(" Bulk Analysis ",-1))]),_:1})]),l(a(S),null,{default:r(()=>[l(a($),{class:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between"},{default:r(()=>[l(a(I),{class:"text-lg"},{default:r(()=>[...s[3]||(s[3]=[_("Chapters",-1)])]),_:1}),o("div",$e,[l(a(k),{size:"sm",variant:"outline",onClick:re},{default:r(()=>[...s[4]||(s[4]=[_("Select All",-1)])]),_:1}),l(a(k),{size:"sm",variant:"ghost",onClick:ne},{default:r(()=>[...s[5]||(s[5]=[_("Clear",-1)])]),_:1}),l(a(k),{disabled:g.value,size:"sm",class:"gap-2",onClick:le},{default:r(()=>[g.value?(c(),h(a(ge),{key:0,class:"h-4 w-4 animate-spin"})):(c(),h(a(be),{key:1,class:"h-4 w-4"})),_(" Start Analysis ("+u(F.value)+") ",1)]),_:1},8,["disabled"])])]),_:1}),l(a(A),null,{default:r(()=>[l(a(de),{class:"max-h-[480px]"},{default:r(()=>[o("div",Ie,[(c(!0),m(W,null,R(i.value,e=>(c(),m("div",{key:e.id,class:"flex items-center gap-3 py-3"},[l(a(ue),{"model-value":n.value.includes(e.id),"onUpdate:modelValue":v=>oe(e.id,v)},null,8,["model-value","onUpdate:modelValue"]),o("div",Me,[o("div",Pe,[o("span",ze,"Chapter "+u(e.chapter_number),1),l(z,{as:"span",content:e.title},null,8,["content"])]),o("div",Fe,[o("span",null,u(e.word_count||0)+" words",1),e.latest_analysis?(c(),m("span",Ve," Last score: "+u(e.latest_analysis.total_score)+" ("+u(e.latest_analysis.completion_percentage)+"%) ",1)):(c(),m("span",qe,[l(a(xe),{class:"h-3 w-3"}),s[6]||(s[6]=_(" Not analyzed yet ",-1))]))])])]))),128))])]),_:1})]),_:1})]),_:1}),b.value?(c(),h(a(S),{key:0},{default:r(()=>[l(a($),null,{default:r(()=>[l(a(I),{class:"flex items-center gap-2"},{default:r(()=>[l(a(we),{class:"h-4 w-4"}),s[7]||(s[7]=_(" Analysis Progress ",-1))]),_:1})]),_:1}),l(a(A),{class:"space-y-3"},{default:r(()=>[o("div",Ue,[s[8]||(s[8]=o("span",null,"Status",-1)),o("span",Le,u(d.value?.batch?.status||"running"),1)]),l(a(U),{"model-value":te.value},null,8,["model-value"]),o("div",We," Completed: "+u(d.value?.batch?.completed_chapters||0)+" / "+u(d.value?.batch?.total_chapters||F.value),1)]),_:1})]),_:1})):M("",!0),i.value.some(e=>e.latest_analysis)?(c(),h(a(S),{key:1},{default:r(()=>[l(a($),null,{default:r(()=>[l(a(I),{class:"flex items-center gap-2"},{default:r(()=>[l(a(ke),{class:"h-4 w-4 text-green-500"}),s[9]||(s[9]=_(" Latest Results ",-1))]),_:1})]),_:1}),l(a(A),{class:"space-y-2"},{default:r(()=>[o("div",Re,[(c(!0),m(W,null,R(i.value,e=>(c(),m("div",{key:`result-${e.id}`,class:"p-3 border rounded-lg"},[o("div",De,[o("span",null,"Chapter "+u(e.chapter_number),1),e.latest_analysis?(c(),m("span",Te,u(e.latest_analysis.total_score)+" pts ",1)):M("",!0)]),o("p",Ee,[l(z,{as:"span",content:e.title},null,8,["content"])]),e.latest_analysis?(c(),m("div",Je,[l(a(U),{"model-value":e.latest_analysis.completion_percentage},null,8,["model-value"]),o("div",Oe," Analyzed at "+u(new Date(e.latest_analysis.analyzed_at).toLocaleString()),1)])):(c(),m("div",Ge,"No analysis yet"))]))),128))])]),_:1})]),_:1})):M("",!0)]),l(Ce,{open:a(T),"current-balance":a(K),"required-words":a(E),action:a(J),onClose:a(G)},null,8,["open","current-balance","required-words","action","onClose"])]),_:1})]),_:1}))}});export{ht as default};
