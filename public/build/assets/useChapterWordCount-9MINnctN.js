import{bs as n,cR as He,ch as Oe,ci as v,ck as N,bD as Me,cj as x}from"./vendor-B0P7kkmx.js";import{r as fe}from"./useWordBalance-BdsKHd_Q.js";const Ke={userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100};class ze{scrollContainer=null;isUserScrolling=!1;userScrollTimeout=null;isEnabled=!0;isDestroyed=!1;config;wasAtBottom=!0;rafId=null;handleWheel;handleTouchStart;handleTouchMove;handleScroll;handleKeydown;constructor(r={}){this.config={...Ke,...r},this.handleWheel=this.onUserScroll.bind(this),this.handleTouchStart=this.onUserScroll.bind(this),this.handleTouchMove=this.onUserScroll.bind(this),this.handleScroll=this.onScroll.bind(this),this.handleKeydown=this.onKeydown.bind(this)}attach(r){this.isDestroyed||(this.detach(),this.scrollContainer=r,this.setupEventListeners(),this.wasAtBottom=this.isAtBottom())}detach(){this.scrollContainer&&(this.scrollContainer.removeEventListener("wheel",this.handleWheel),this.scrollContainer.removeEventListener("touchstart",this.handleTouchStart),this.scrollContainer.removeEventListener("touchmove",this.handleTouchMove),this.scrollContainer.removeEventListener("scroll",this.handleScroll),this.scrollContainer.removeEventListener("keydown",this.handleKeydown)),this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.scrollContainer=null}setupEventListeners(){this.scrollContainer&&(this.scrollContainer.addEventListener("wheel",this.handleWheel,{passive:!0}),this.scrollContainer.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.scrollContainer.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.scrollContainer.addEventListener("scroll",this.handleScroll,{passive:!0}),this.scrollContainer.addEventListener("keydown",this.handleKeydown))}onUserScroll(){this.isEnabled&&(this.isUserScrolling=!0,this.userScrollTimeout&&clearTimeout(this.userScrollTimeout),this.userScrollTimeout=setTimeout(()=>{this.isUserScrolling=!1,this.isAtBottom()&&(this.wasAtBottom=!0)},this.config.userScrollTimeout))}onScroll(){this.wasAtBottom=this.isAtBottom()}onKeydown(r){["ArrowUp","ArrowDown","PageUp","PageDown","Home","End"].includes(r.key)&&this.onUserScroll()}isAtBottom(){if(!this.scrollContainer)return!0;const{scrollTop:r,scrollHeight:y,clientHeight:C}=this.scrollContainer;return y-r-C<=this.config.bottomThreshold}scrollToBottom(){!this.scrollContainer||!this.isEnabled||this.isDestroyed||this.isUserScrolling||!this.wasAtBottom||(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{if(this.rafId=null,!this.scrollContainer||this.isDestroyed)return;const r=this.scrollContainer.scrollHeight-this.scrollContainer.clientHeight;this.config.scrollBehavior==="instant"?this.scrollContainer.scrollTop=r:this.scrollContainer.scrollTo({top:r,behavior:"smooth"}),this.wasAtBottom=!0}))}forceScrollToBottom(){!this.scrollContainer||this.isDestroyed||(this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.scrollToBottom())}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isAutoScrollActive(){return this.isEnabled&&!this.isUserScrolling&&this.wasAtBottom}isUserScrollingNow(){return this.isUserScrolling}reset(){this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null)}destroy(){this.isDestroyed=!0,this.detach()}}function Xe(s={}){const r=new ze(s),y=n(!0),C=n(!1);let E=null;function b(l){l?(r.attach(l),w()):(r.detach(),G())}function q(l){Oe(l,c=>{b(c)},{immediate:!0})}function w(){G(),E=setInterval(()=>{y.value=r.isAutoScrollActive(),C.value=r.isUserScrollingNow()},100)}function G(){E&&(clearInterval(E),E=null)}function B(){r.scrollToBottom()}function X(){r.forceScrollToBottom()}function Y(){r.enable()}function re(){r.disable()}function d(){r.reset(),y.value=!0,C.value=!1}return He(()=>{G(),r.destroy()}),{attach:b,attachRef:q,scrollToBottom:B,forceScrollToBottom:X,enable:Y,disable:re,reset:d,isAutoScrollActive:y,isUserScrolling:C}}function lt({props:s,chapterContent:r,targetWordCount:y,estimates:C,ensureBalance:E,save:b,triggerAutoSave:q,calculateWritingStats:w,countWords:G,selectedText:B,richTextEditor:X,richTextEditorFullscreen:Y,isNativeFullscreen:re}){const d=n(!1),l=n(""),c=n(0),f=n(""),_=n(0),h=n(0),S=n(""),F=n(0),oe=n(""),ne=n([]),J=n(!1),ce=n(!1),Q=n(!1),R=n(!1),W=n(!1),V=n(!1),ae=n(0),o=n([]),I=10,M=n(!1),D=n(null),L=n(!1),Z=n(""),ee=n(""),we=n(0),Se=n(0),ye=n(null),Ce=n([]),be=n([]),Te=n(null),U=n(null),k=n(0),ue=3,le=n(2e3),H=n(!1),se=n(null),Ue=n("progressive"),i=n(null),Ee=n(),T=n(null),{attach:Ae,scrollToBottom:Ge,forceScrollToBottom:Fe,reset:xe,isAutoScrollActive:Le,isUserScrolling:je}=Xe({userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100}),$e=()=>{const t=document.querySelector("[data-editor-scroll-container]");if(t){const a=t.querySelector("[data-radix-scroll-area-viewport]");if(a)return console.log("ðŸ“œ Found Radix viewport inside marked container"),a;if(t.classList.contains("overflow-y-auto")||getComputedStyle(t).overflowY==="auto"||getComputedStyle(t).overflowY==="scroll")return console.log("ðŸ“œ Using marked container directly (has overflow)"),t}const e=document.querySelector("main");if(e){const a=e.querySelector("[data-radix-scroll-area-viewport]");if(a)return console.log("ðŸ“œ Found Radix viewport in main"),a}if(re.value){const a=Ee.value;if(a){const p=a.$el||a,P=p?.querySelector("[data-radix-scroll-area-viewport]")||p?.querySelector("[data-viewport]")||p?.querySelector('[role="region"]');if(P)return console.log("ðŸ“œ Found viewport in fullscreen ref"),P}const u=document.querySelector("[data-editor-scroll-container].overflow-y-auto");if(u)return console.log("ðŸ“œ Found fullscreen scroll container"),u}const g=[".custom-scrollbar.overflow-y-auto","main .overflow-y-auto"];for(const a of g){const u=document.querySelector(a);if(u&&u.scrollHeight>u.clientHeight)return console.log("ðŸ“œ Found container via selector:",a),u}if(e){const a=e.querySelectorAll("div");for(const u of a)if(u.scrollHeight>u.clientHeight&&u.classList.contains("overflow-y-auto"))return console.log("ðŸ“œ Found fallback scrollable div"),u}return null},ke=()=>{Me(()=>{T.value=$e(),T.value?(Ae(T.value),console.log("ðŸ“œ Auto-scroll initialized on container:",T.value.className||T.value.tagName)):console.warn("ðŸ“œ No scroll container found for auto-scroll")})},ve=()=>{!d.value&&!R.value||Me(()=>{(!T.value||!T.value.isConnected)&&(T.value=$e()),requestAnimationFrame(()=>{T.value&&T.value.isConnected&&(T.value.scrollTop=T.value.scrollHeight)})})},Pe=async()=>{if(!navigator.onLine)return v.error("No Internet Connection",{description:"Please check your internet connection and try again."}),!1;const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(t){const e=t.effectiveType;(e==="slow-2g"||e==="2g")&&v.warning("Slow Connection Detected",{description:"Your connection is slow. Content will be auto-saved during generation.",duration:4e3})}try{const e=new AbortController,g=setTimeout(()=>e.abort(),5e3),a=performance.now();await fetch(N("api.ping"),{method:"HEAD",cache:"no-cache",signal:e.signal}),clearTimeout(g);const u=performance.now()-a;console.log("ðŸ“¡ Server latency:",u.toFixed(0),"ms"),u>2e3&&v.info("Connection is slow",{description:"Content will be auto-saved during generation to prevent data loss.",duration:3e3})}catch(e){console.warn("Connection check ping failed:",e),v.info("Connection check skipped",{description:"Content will be auto-saved during generation.",duration:2e3})}return!0},ge=t=>{const e=r.value;e&&(o.value.length>0&&o.value[o.value.length-1].content===e||(o.value.push({content:e,action:t,timestamp:Date.now()}),o.value.length>I&&o.value.shift(),M.value=o.value.length>0))},qe=()=>{if(o.value.length===0)return v.error("Nothing to undo"),!1;const t=o.value.pop();return t?(D.value=r.value,r.value=t.content,M.value=o.value.length>0,v.success("Undone",{description:`Reverted "${t.action}" action`,action:{label:"Redo",onClick:()=>{D.value&&(ge("Redo"),r.value=D.value,D.value=null)}}}),!0):!1},Be=()=>{o.value=[],M.value=!1,D.value=null},_e=t=>{if(d.value&&h.value>0)return t.preventDefault(),t.returnValue="Chapter generation is in progress. Your content may not be fully saved.",t.returnValue},De=()=>{typeof window<"u"&&window.addEventListener("beforeunload",_e)},de=()=>{typeof window<"u"&&window.removeEventListener("beforeunload",_e)},Ne=()=>{de()},We=async()=>new Promise(t=>{let e=0;const g=120,a=async()=>{try{const p=await(await fetch(N("api.projects.paper-collection.status",{project:s.project.slug}))).json();if(p.success&&p.data){Te.value=p.data;const P=p.data.status,A=p.data.papers_count||p.data.count||0,$=p.data.message,O=p.data.percentage||0,m=p.data.current_source,K=p.data.sources_completed||[],z=p.data.papers_preview||[];if(we.value=A,Se.value=O,ye.value=m,Ce.value=K,be.value=z,P==="completed"){ee.value="Complete",Z.value=`âœ“ Collected ${A} verified sources from ${K.length} databases`,c.value=50,L.value=!1,U.value&&clearInterval(U.value),t(!0);return}else if(["collecting_papers","initializing","processing","storing"].includes(P)){let j="";m&&(j={semantic_scholar:"Semantic Scholar",openalex:"OpenAlex",arxiv:"arXiv",crossref:"CrossRef",pubmed:"PubMed"}[m]||m),ee.value=j||"Collecting Sources",Z.value=$||"Collecting sources from academic databases...",c.value=Math.min(5+O*.4,45)}else if(P==="collection_failed"){ee.value="Error",Z.value=$||"âŒ Source collection failed",L.value=!1,U.value&&clearInterval(U.value),t(!1);return}}e++,e>=g&&(ee.value="Timeout",Z.value="â±ï¸ Source collection timed out",L.value=!1,U.value&&clearInterval(U.value),t(!1))}catch(u){console.error("Error checking paper collection status:",u),e++}};a(),U.value=setInterval(a,5e3)}),Re=async()=>{L.value=!0,ee.value="Starting",Z.value="Initializing source collection...",c.value=5;try{const t=document.querySelector('meta[name="csrf-token"]')?.content;if(!t)throw new Error("CSRF token not found - please refresh the page");const e=await fetch(N("api.projects.paper-collection.start",{project:s.project.slug}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!e.ok){const g=await e.text();if(console.error("API Error:",e.status,g),e.status===409)try{const a=JSON.parse(g);throw new Error(a.message||"Source collection is already in progress")}catch{throw new Error("Source collection is already in progress for this project")}throw new Error(`Failed to start source collection: ${e.status}`)}return await We()}catch(t){return console.error("Paper collection failed:",t),ee.value="Error",Z.value="âŒ Source collection failed",L.value=!1,!1}},he=async(t,e={})=>{const g=t==="improve"?300:C.chapter(y.value||0);if(!E(g,t==="improve"?"improve this chapter":"generate this chapter with AI")||!await Pe())return;if(d.value=!0,S.value="",h.value=0,c.value=5,f.value="Papers",l.value="Checking for verified sources...",R.value=!0,xe(),_.value=y.value||0,Q.value=!0,!await Re()){v.error("Paper Collection Failed",{description:"Unable to collect verified papers. Please try again."}),d.value=!1,Q.value=!1;return}De(),f.value="Initializing",l.value="Starting AI generation with verified sources...",c.value=51;const P=setInterval(()=>{c.value<52&&d.value?c.value+=.2:clearInterval(P)},100),A=N("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number});let $=`?generation_type=${t}`;e.section&&($+=`&section_type=${encodeURIComponent(e.section)}`),e.selectedText&&($+=`&selected_text=${encodeURIComponent(e.selectedText)}`),e.style&&($+=`&style=${encodeURIComponent(e.style)}`),i.value=new EventSource(`${A}${$}`),i.value.onmessage=O=>{const m=JSON.parse(O.data);switch(m.type){case"start":f.value="Connecting",c.value=52,l.value="Connecting to AI service...",ke();break;case"content":f.value="Writing",S.value+=m.content,h.value=m.word_count||S.value.split(/\s+/).filter(j=>j.length>0).length;const K=Date.now();if(K-F.value>200){r.value=S.value,F.value=K;const j=Math.min(h.value/Math.max(_.value,1)*43,43);c.value=Math.max(52,52+j),l.value=`Writing chapter content... (${h.value} / ${_.value} words)`,ve()}break;case"heartbeat":c.value<95&&(c.value+=.5);break;case"complete":f.value="Complete",c.value=100,d.value=!1,R.value=!1,T.value=null,r.value=S.value,de();const z=m.final_word_count||h.value;l.value=`âœ“ Generated ${z} words successfully`,w(),fe(z,`Chapter generation (${s.chapter.chapter_number})`,"chapter",s.chapter.id).catch(j=>console.error("Failed to record word usage (chapter generation):",j)),setTimeout(()=>{q()},500),i.value?.close(),i.value=null;break;case"error":f.value="Error",c.value=50,R.value=!1,T.value=null,de(),m.partial_saved&&(V.value=!0,ae.value=m.saved_word_count||0),m.code==="OFFLINE_MODE"?(l.value="ðŸ“¡ AI services offline",d.value=!1,v.error("AI Services Offline",{description:"Please check your internet connection and try again."})):m.can_resume?(l.value=`âš ï¸ Generation interrupted (${m.saved_word_count} words saved)`,d.value=!1,W.value=!0,v.warning("Generation Interrupted",{description:`${m.saved_word_count} words were saved. You can resume generation.`,duration:8e3})):(l.value="âŒ Generation failed",d.value=!1,v.error("Generation Error",{description:m.message||"Please try again."})),i.value?.close(),i.value=null;break;case"autosave":m.word_count&&m.generation_id&&(se.value=m.generation_id);break}},i.value.onerror=()=>{if(k.value<ue){k.value++,H.value=!0,f.value="Reconnecting",l.value=`ðŸ”„ Connection lost. Reconnecting... (${k.value}/${ue})`,i.value?.close(),i.value=null;const O=le.value*Math.pow(2,k.value-1);setTimeout(()=>pe(t),O)}else f.value="Error",c.value=50,d.value=!1,H.value=!1,l.value="âŒ Connection failed after multiple attempts",de(),h.value>100?(V.value=!0,ae.value=h.value,W.value=!0,v.warning("Connection Lost",{description:`${h.value} words have been saved. Check and resume if needed.`,duration:8e3})):v.error("Connection Error",{description:"Please check your internet connection and try again."}),i.value?.close(),i.value=null,k.value=0,le.value=2e3}},pe=t=>{i.value&&(i.value.close(),i.value=null);const e=N("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number}),g=new URLSearchParams({generation_type:t,resume_from:h.value.toString()});se.value&&g.set("generation_id",se.value),i.value=new EventSource(`${e}?${g}`),i.value.onmessage=a=>{const u=JSON.parse(a.data);switch(["content","start"].includes(u.type)&&(H.value=!1,k.value=0,f.value="Writing"),u.type){case"start":l.value="âœ… Reconnected! Continuing generation...",ke(),v.success("Reconnected",{description:"Generation resumed successfully.",duration:3e3});break;case"content":f.value="Writing",S.value+=u.content,h.value=u.word_count||S.value.split(/\s+/).filter(A=>A.length>0).length;const p=Date.now();if(p-F.value>150){r.value=S.value,F.value=p;const A=Math.min(h.value/Math.max(_.value,1)*43,43);c.value=Math.max(52,52+A),l.value=`Writing chapter content... (${h.value} / ${_.value} words)`,ve()}break;case"complete":f.value="Complete",c.value=100,d.value=!1,H.value=!1,T.value=null,r.value=S.value;const P=u.final_word_count||h.value;l.value=`âœ“ Generated ${P} words successfully`,fe(P,`Chapter generation (${s.chapter.chapter_number})`,"chapter",s.chapter.id).catch(A=>console.error("Failed to record word usage:",A)),setTimeout(()=>{q()},500),i.value?.close(),i.value=null;break;case"error":f.value="Error",d.value=!1,H.value=!1,T.value=null,l.value="âŒ Generation failed",v.error("Generation Error",{description:u.message||"Please try again."}),i.value?.close(),i.value=null;break;case"autosave":u.generation_id&&(se.value=u.generation_id);break}},i.value.onerror=()=>{if(k.value<ue){k.value++;const a=le.value*Math.pow(2,k.value-1);l.value=`ðŸ”„ Reconnecting... (${k.value}/${ue})`,i.value?.close(),setTimeout(()=>pe(t),a)}else f.value="Error",d.value=!1,H.value=!1,l.value="âŒ Connection failed",h.value>100?(W.value=!0,v.warning("Connection Lost",{description:`${h.value} words may be saved. Refresh to recover.`})):v.error("Connection Error",{description:"Please check your connection and try again."}),i.value?.close(),i.value=null,k.value=0}},Ie=async t=>{d.value=!0,S.value="",h.value=0,c.value=5,f.value="Papers",l.value="Checking for verified sources...",_.value=600,oe.value=r.value||s.chapter.content||"",Q.value=!0;try{c.value=50,f.value="Papers",l.value="Using existing verified sources...",await new Promise(g=>setTimeout(g,500)),f.value="Section",l.value=`Writing ${t} section with verified sources...`,c.value=51;const e=N("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number});i.value=new EventSource(`${e}?generation_type=section&section_type=${t}`),i.value.onmessage=g=>{const a=JSON.parse(g.data);switch(a.type){case"start":f.value="Writing Section",c.value=52,l.value=`Starting ${t} section generation...`;break;case"content":S.value+=a.content,h.value=a.word_count||G(S.value);const u=Date.now();if(u-F.value>150){r.value=oe.value+`

`+S.value,F.value=u;const p=Math.min(h.value/_.value*43,43);c.value=Math.max(52,52+p),l.value=`Writing ${t} section... (${h.value} / ${_.value} words)`,w(),ve()}break;case"complete":c.value=100,f.value="Complete",l.value=`âœ“ Generated ${t} section (${h.value} words)`,r.value=oe.value+`

`+S.value,b(!0),v.success("âœ… Section Generated Successfully",{description:`Added ${t} section with ${h.value} words and verified citations.`,duration:5e3}),d.value=!1,i.value?.close();break;case"error":throw new Error(a.message||"Section generation failed");case"heartbeat":c.value<95&&(c.value+=.5);break}},i.value.onerror=()=>{d.value=!1,f.value="Error",l.value="âŒ Section generation failed",v.error("âŒ Generation Failed",{description:"Unable to generate section. Please check your connection and try again."}),i.value?.close()}}catch(e){console.error("Section generation failed:",e),d.value=!1,f.value="Error",l.value="âŒ Section generation error",v.error("âŒ Generation Failed",{description:"Section generation encountered an error."})}},me=async(t,e,g)=>{const a=t.split(/\s+/).length;if(!E(300,`${e} selected text`))return;d.value=!0,S.value="",h.value=0,c.value=10,f.value=e==="rephrase"?"Rephrasing":"Expanding",l.value=`${e==="rephrase"?"Rephrasing":"Expanding"} selected text...`,_.value=Math.max(a*(e==="expand"?2:1),100);const p=Y.value||X.value,P=p?.getSelectionRange(),A={originalText:t,range:P,wordCount:a,style:g||"Academic Formal",startTime:Date.now()};Q.value=!0;try{const $=document.querySelector('meta[name="csrf-token"]')?.content;if(!$)throw new Error("CSRF token not found - please refresh the page");const O=e==="rephrase"?N("chapters.quick-actions.rephrase",{project:s.project.slug,chapter:s.chapter.chapter_number}):N("chapters.quick-actions.expand",{project:s.project.slug,chapter:s.chapter.chapter_number});c.value=35;const m=await fetch(O,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":$,"X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify({text:t,...e==="rephrase"?{style:A.style}:{}})});if(!m.ok){let te=`Request failed (${m.status})`;try{const ie=await m.json();te=ie?.message||ie?.error||ie?.data?.message||te}catch{}throw new Error(te)}const K=await m.json(),z=String(K?.text||"").trim();if(!z)throw new Error("Empty response from AI service");c.value=100,f.value="Complete",l.value=`âœ“ Text ${e==="rephrase"?"rephrased":"expanded"} successfully`,A.range&&(p?.replaceSelection(z,A.range)?setTimeout(()=>{const ie=p?.getHTML()||r.value;r.value=ie},50):v.warning("Please manually replace the selected text",{description:"The generated text is ready but could not be automatically inserted."})),b(!0),v.success(`âœ… Text ${e==="rephrase"?"Rephrased":"Expanded"} Successfully`,{description:`${e==="rephrase"?"Rephrased":"Expanded"} selection (${a} words).`});const j=Number(K?.word_count)||G(z)||(e==="expand"?a*2:a);fe(j,e==="rephrase"?`Rephrase (${A.style})`:"Expand text","chapter",s.chapter.id).catch(te=>console.error(`Failed to record word usage (${e}):`,te)),d.value=!1}catch($){console.error("Selection generation failed:",$),d.value=!1,f.value="Error",l.value=`âŒ Text ${e==="rephrase"?"rephrasing":"expansion"} error`,v.error(`âŒ ${e==="rephrase"?"Rephrasing":"Expansion"} Failed`,{description:$ instanceof Error?$.message:"Text generation encountered an error."})}};return{isGenerating:d,generationProgress:l,generationPercentage:c,generationPhase:f,estimatedTotalWords:_,streamWordCount:h,streamBuffer:S,lastStreamUpdate:F,originalContentForAppend:oe,aiSuggestions:ne,isLoadingSuggestions:J,showCitationHelper:ce,showPresentationMode:Q,isStreamingMode:R,showRecoveryDialog:W,partialContentSaved:V,savedWordCountOnError:ae,isCollectingPapers:L,paperCollectionProgress:Z,paperCollectionPhase:ee,collectedPapersCount:we,paperCollectionPercentage:Se,currentSource:ye,sourcesCompleted:Ce,papersPreview:be,paperCollectionData:Te,paperCollectionInterval:U,reconnectAttempts:k,reconnectDelay:le,isReconnecting:H,currentGenerationId:se,currentGenerationType:Ue,eventSource:i,editorScrollRef:Ee,attachScroller:Ae,smoothScrollToBottom:Ge,forceScrollToBottom:Fe,resetScroller:xe,isAutoScrollActive:Le,isUserScrollingScroller:je,scrollToBottom:ve,checkConnectionQuality:Pe,startPaperCollection:Re,startStreamingGeneration:he,attemptReconnection:pe,startSectionGeneration:Ie,handleSelectionGeneration:me,handleAIGeneration:(t,e)=>{t==="section"&&e?.section?Ie(e.section):t==="rephrase"&&e?.selectedText?me(e.selectedText,"rephrase",e.style):t==="expand"&&e?.selectedText?me(e.selectedText,"expand"):he(t)},handleRegenerateChapter:async(t=!1)=>{if(!t)return!1;const e=C.chapter(y.value||0);return E(e,"regenerate this chapter")?(r.value&&r.value.trim().length>0&&(ge("Before regenerate"),v.info("Previous content saved",{description:"You can undo to restore it if needed.",duration:3e3})),r.value="",await he("progressive"),!0):!1},getAISuggestions:async()=>{if(!B.value)return;const t=C.suggestion();if(E(t,"get AI suggestions")){J.value=!0;try{const g=await(await fetch(N("chapters.suggestions",{project:s.project.slug,chapter:s.chapter.chapter_number}),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({selected_text:B.value,context:r.value})})).json();ne.value=g.suggestions||[],ne.value.length&&fe(C.suggestion(),"AI suggestions","chapter",s.chapter.id).catch(a=>console.error("Failed to record word usage (suggestions):",a))}catch{v.error("Error getting suggestions",{description:"Please try again."})}finally{J.value=!1}}},checkCitations:()=>{ce.value=!0,v.success("Citation Manager opened!",{description:"Review and verify your citations in the panel below."})},insertCitation:t=>{try{const e=Y.value?.editor||X.value?.editor;if(!e){v.error("Editor not found");return}const{from:g}=e.state.selection;e.chain().focus().insertContentAt(g,` ${t} `).run(),v.success("Citation inserted successfully")}catch(e){console.error("Failed to insert citation:",e),v.error("Failed to insert citation")}},resumeGeneration:()=>{W.value=!1,V.value=!1,window.location.reload()},dismissRecovery:()=>{W.value=!1,V.value=!1,ae.value=0},checkForAutoGeneration:()=>{const t=new URLSearchParams(window.location.search),e=t.get("ai_generate")==="true",g=t.get("generation_type");!e||!g||setTimeout(()=>{he("progressive");const a=new URL(window.location.href);a.searchParams.delete("ai_generate"),a.searchParams.delete("generation_type"),window.history.replaceState({},"",a.toString()),v.success("ðŸš€ AI Generation Started",{description:`Writing ${s.chapter.title} with AI assistance...`})},1e3)},stopGeneration:()=>{!d.value&&!L.value||(i.value&&(i.value.close(),i.value=null),U.value&&(clearInterval(U.value),U.value=null),S.value&&h.value>0?(r.value=S.value,v.info("Generation Stopped",{description:`${h.value} words have been saved. You can continue editing or regenerate.`,duration:5e3})):v.info("Generation Stopped",{description:"Generation was cancelled.",duration:3e3}),d.value=!1,R.value=!1,L.value=!1,H.value=!1,k.value=0,le.value=2e3,f.value="Stopped",l.value="Generation stopped by user",T.value=null,h.value>0&&setTimeout(()=>{q()},500))},contentHistory:o,canUndo:M,pushToHistory:ge,undoLastAction:qe,clearHistory:Be,cleanupGenerationProtection:Ne}}function st(s){const{delay:r=1e4,onSave:y}=s,C=n(!1),E=n(!1),b=n(null),q=()=>{C.value=!0,b.value&&clearTimeout(b.value),b.value=setTimeout(()=>{w(!0)},r)},w=async(B=!1)=>{if(!E.value){E.value=!0;try{await y(B),C.value=!1,b.value&&(clearTimeout(b.value),b.value=null)}finally{E.value=!1}}};return{hasUnsavedChanges:C,isSaving:E,triggerAutoSave:q,save:w,clearAutoSave:()=>{b.value&&(clearTimeout(b.value),b.value=null)}}}function it(s,r=n(3e3),y=.8){const C=o=>{if(!o)return 0;const M=o.replace(/<[^>]*>/g,"").trim().replace(/\s+/g," ");if(!M)return 0;const D=M.match(/\b\w+\b/g);return D?D.length:0},E=o=>o?o.replace(/<[^>]*>/g,"").replace(/\r\n|\r/g,`
`).trim().split(/\n\s*\n/).filter(L=>L.trim().length>0).length:0,b=o=>{if(!o)return 0;const M=o.replace(/<[^>]*>/g,"").match(/[.!?]+/g);return M?M.length:0},q=o=>Math.round(o/200*10)/10,w=x(()=>C(s.value)),G=x(()=>s.value.length),B=x(()=>s.value.replace(/\s/g,"").length),X=x(()=>E(s.value)),Y=x(()=>b(s.value)),re=x(()=>q(w.value)),d=x(()=>{const o=r.value;return!o||o<=0?0:Math.min(w.value/o*100,100)}),l=x(()=>w.value>=r.value*y),c=x(()=>{const o=r.value-w.value;return Math.max(o,0)}),f=x(()=>{const o=r.value*y-w.value;return Math.max(o,0)}),_=x(()=>({wordCount:w.value,characterCount:G.value,characterCountNoSpaces:B.value,paragraphCount:X.value,sentenceCount:Y.value,readingTimeMinutes:re.value})),h=x(()=>({current:w.value,target:r.value,percentage:d.value,isComplete:l.value,completionThreshold:y})),S=o=>o>=1e3?`${Math.round(o/100)/10}k`:o.toString(),F=(o=0)=>`${Math.round(d.value*Math.pow(10,o))/Math.pow(10,o)}%`,oe=()=>`${w.value} / ${r.value} words (${F()}%)`,ne=()=>{if(l.value)return`âœ… Complete (${S(w.value)} words)`;const o=f.value;return`${S(o)} more words to complete`},J=()=>{const o=w.value,I=r.value;return o===0?"empty":o<I*.25?"started":o<I*.75?"progressing":o<I*y?"near_complete":o<I?"complete":"exceeded"},ce=()=>{const o=J();return{empty:"text-gray-500",started:"text-blue-500",progressing:"text-yellow-500",near_complete:"text-orange-500",complete:"text-green-500",exceeded:"text-emerald-600"}[o]},Q=()=>{const o=J();return{empty:"bg-gray-200",started:"bg-blue-200",progressing:"bg-yellow-200",near_complete:"bg-orange-200",complete:"bg-green-200",exceeded:"bg-emerald-200"}[o]},R=800,W=x(()=>w.value>=R),V=x(()=>Math.max(R-w.value,0)),ae=x(()=>Math.min(w.value/R*100,100));return{currentWordCount:w,characterCount:G,characterCountNoSpaces:B,paragraphCount:X,sentenceCount:Y,readingTimeMinutes:re,progressPercentage:d,isComplete:l,wordsRemaining:c,wordsToComplete:f,wordCountStats:_,wordCountProgress:h,meetsDefenseThreshold:W,defenseWordsRemaining:V,defenseProgressPercentage:ae,DEFENSE_THRESHOLD:R,formatWordCount:S,formatProgress:F,getProgressDisplay:oe,getCompletionDisplay:ne,getWordCountStatus:J,getStatusColor:ce,getProgressBarColor:Q,countWords:C}}export{it as a,lt as b,st as u};
