import{bs as r,cR as Ye,ci as Ve,cj as v,cl as j,bD as De,ck as x}from"./vendor-DTjPma1U.js";import{r as me}from"./useWordBalance-CuedtyJP.js";const Qe={userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100};class Ze{scrollContainer=null;isUserScrolling=!1;userScrollTimeout=null;isEnabled=!0;isDestroyed=!1;config;wasAtBottom=!0;rafId=null;handleWheel;handleTouchStart;handleTouchMove;handleScroll;handleKeydown;constructor(a={}){this.config={...Qe,...a},this.handleWheel=this.onUserScroll.bind(this),this.handleTouchStart=this.onUserScroll.bind(this),this.handleTouchMove=this.onUserScroll.bind(this),this.handleScroll=this.onScroll.bind(this),this.handleKeydown=this.onKeydown.bind(this)}attach(a){this.isDestroyed||(this.detach(),this.scrollContainer=a,this.setupEventListeners(),this.wasAtBottom=this.isAtBottom())}detach(){this.scrollContainer&&(this.scrollContainer.removeEventListener("wheel",this.handleWheel),this.scrollContainer.removeEventListener("touchstart",this.handleTouchStart),this.scrollContainer.removeEventListener("touchmove",this.handleTouchMove),this.scrollContainer.removeEventListener("scroll",this.handleScroll),this.scrollContainer.removeEventListener("keydown",this.handleKeydown)),this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.scrollContainer=null}setupEventListeners(){this.scrollContainer&&(this.scrollContainer.addEventListener("wheel",this.handleWheel,{passive:!0}),this.scrollContainer.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.scrollContainer.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.scrollContainer.addEventListener("scroll",this.handleScroll,{passive:!0}),this.scrollContainer.addEventListener("keydown",this.handleKeydown))}onUserScroll(){this.isEnabled&&(this.isUserScrolling=!0,this.userScrollTimeout&&clearTimeout(this.userScrollTimeout),this.userScrollTimeout=setTimeout(()=>{this.isUserScrolling=!1,this.isAtBottom()&&(this.wasAtBottom=!0)},this.config.userScrollTimeout))}onScroll(){this.wasAtBottom=this.isAtBottom()}onKeydown(a){["ArrowUp","ArrowDown","PageUp","PageDown","Home","End"].includes(a.key)&&this.onUserScroll()}isAtBottom(){if(!this.scrollContainer)return!0;const{scrollTop:a,scrollHeight:y,clientHeight:C}=this.scrollContainer;return y-a-C<=this.config.bottomThreshold}scrollToBottom(){!this.scrollContainer||!this.isEnabled||this.isDestroyed||this.isUserScrolling||!this.wasAtBottom||(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{if(this.rafId=null,!this.scrollContainer||this.isDestroyed)return;const a=this.scrollContainer.scrollHeight-this.scrollContainer.clientHeight;this.config.scrollBehavior==="instant"?this.scrollContainer.scrollTop=a:this.scrollContainer.scrollTo({top:a,behavior:"smooth"}),this.wasAtBottom=!0}))}forceScrollToBottom(){!this.scrollContainer||this.isDestroyed||(this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.scrollToBottom())}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isAutoScrollActive(){return this.isEnabled&&!this.isUserScrolling&&this.wasAtBottom}isUserScrollingNow(){return this.isUserScrolling}reset(){this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null)}destroy(){this.isDestroyed=!0,this.detach()}}function et(i={}){const a=new Ze(i),y=r(!0),C=r(!1);let E=null;function b(n){n?(a.attach(n),S()):(a.detach(),G())}function L(n){Ve(n,c=>{b(c)},{immediate:!0})}function S(){G(),E=setInterval(()=>{y.value=a.isAutoScrollActive(),C.value=a.isUserScrollingNow()},100)}function G(){E&&(clearInterval(E),E=null)}function F(){a.scrollToBottom()}function z(){a.forceScrollToBottom()}function X(){a.enable()}function ae(){a.disable()}function d(){a.reset(),y.value=!0,C.value=!1}return Ye(()=>{G(),a.destroy()}),{attach:b,attachRef:L,scrollToBottom:F,forceScrollToBottom:z,enable:X,disable:ae,reset:d,isAutoScrollActive:y,isUserScrolling:C}}function dt({props:i,chapterContent:a,targetWordCount:y,estimates:C,ensureBalance:E,save:b,triggerAutoSave:L,calculateWritingStats:S,countWords:G,selectedText:F,richTextEditor:z,richTextEditorFullscreen:X,isNativeFullscreen:ae}){const d=r(!1),n=r(""),c=r(0),f=r(""),I=r(0),h=r(0),w=r(""),q=r(0),re=r(""),le=r([]),J=r(!1),ue=r(!1),Y=r(!1),M=r(!1),D=r(!1),V=r(!1),oe=r(0),l=r(!1),$=r(!1),B=r(null),A=r([]),we=10,ve=r(!1),se=r(null),N=r(!1),Q=r(""),Z=r(""),Ce=r(0),be=r(0),Te=r(null),Ee=r([]),Ae=r([]),Pe=r(null),U=r(null),k=r(0),de=3,ie=r(2e3),W=r(!1),ne=r(null),xe=r("progressive"),s=r(null),$e=r(),T=r(null),{attach:_e,scrollToBottom:Be,forceScrollToBottom:je,reset:ke,isAutoScrollActive:qe,isUserScrolling:Ne}=et({userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100}),Re=()=>{const t=document.querySelector("[data-editor-scroll-container]");if(t){const o=t.querySelector("[data-radix-scroll-area-viewport]");if(o)return console.log("ðŸ“œ Found Radix viewport inside marked container"),o;if(t.classList.contains("overflow-y-auto")||getComputedStyle(t).overflowY==="auto"||getComputedStyle(t).overflowY==="scroll")return console.log("ðŸ“œ Using marked container directly (has overflow)"),t}const e=document.querySelector("main");if(e){const o=e.querySelector("[data-radix-scroll-area-viewport]");if(o)return console.log("ðŸ“œ Found Radix viewport in main"),o}if(ae.value){const o=$e.value;if(o){const p=o.$el||o,R=p?.querySelector("[data-radix-scroll-area-viewport]")||p?.querySelector("[data-viewport]")||p?.querySelector('[role="region"]');if(R)return console.log("ðŸ“œ Found viewport in fullscreen ref"),R}const u=document.querySelector("[data-editor-scroll-container].overflow-y-auto");if(u)return console.log("ðŸ“œ Found fullscreen scroll container"),u}const g=[".custom-scrollbar.overflow-y-auto","main .overflow-y-auto"];for(const o of g){const u=document.querySelector(o);if(u&&u.scrollHeight>u.clientHeight)return console.log("ðŸ“œ Found container via selector:",o),u}if(e){const o=e.querySelectorAll("div");for(const u of o)if(u.scrollHeight>u.clientHeight&&u.classList.contains("overflow-y-auto"))return console.log("ðŸ“œ Found fallback scrollable div"),u}return null},Ie=()=>{De(()=>{T.value=Re(),T.value?(_e(T.value),console.log("ðŸ“œ Auto-scroll initialized on container:",T.value.className||T.value.tagName)):console.warn("ðŸ“œ No scroll container found for auto-scroll")})},he=()=>{!d.value&&!M.value||De(()=>{(!T.value||!T.value.isConnected)&&(T.value=Re()),requestAnimationFrame(()=>{T.value&&T.value.isConnected&&T.value.scrollTo({top:T.value.scrollHeight,behavior:"smooth"})})})},Me=async()=>{if(!navigator.onLine)return v.error("No Internet Connection",{description:"Please check your internet connection and try again."}),!1;const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(t){const e=t.effectiveType;(e==="slow-2g"||e==="2g")&&v.warning("Slow Connection Detected",{description:"Your connection is slow. Content will be auto-saved during generation.",duration:4e3})}try{const e=new AbortController,g=setTimeout(()=>e.abort(),5e3),o=performance.now();await fetch(j("api.ping"),{method:"HEAD",cache:"no-cache",signal:e.signal}),clearTimeout(g);const u=performance.now()-o;console.log("ðŸ“¡ Server latency:",u.toFixed(0),"ms"),u>2e3&&v.info("Connection is slow",{description:"Content will be auto-saved during generation to prevent data loss.",duration:3e3})}catch(e){console.warn("Connection check ping failed:",e),v.info("Connection check skipped",{description:"Content will be auto-saved during generation.",duration:2e3})}return!0},Se=t=>{const e=a.value;e&&(A.value.length>0&&A.value[A.value.length-1].content===e||(A.value.push({content:e,action:t,timestamp:Date.now()}),A.value.length>we&&A.value.shift(),ve.value=A.value.length>0))},We=()=>{if(A.value.length===0)return v.error("Nothing to undo"),!1;const t=A.value.pop();return t?(se.value=a.value,a.value=t.content,ve.value=A.value.length>0,v.success("Undone",{description:`Reverted "${t.action}" action`,action:{label:"Redo",onClick:()=>{se.value&&(Se("Redo"),a.value=se.value,se.value=null)}}}),!0):!1},He=()=>{A.value=[],ve.value=!1,se.value=null},Ue=t=>{if(d.value&&h.value>0)return t.preventDefault(),t.returnValue="Chapter generation is in progress. Your content may not be fully saved.",t.returnValue},Ge=()=>{l.value=document.hidden,document.hidden?Oe():Ke()},Oe=()=>{if(!(!d.value||!s.value)){B.value=Date.now(),$.value=!0;try{localStorage.setItem(`generation_pause_${i.chapter.id}`,JSON.stringify({generationId:ne.value,streamBuffer:w.value,streamWordCount:h.value,pausedAt:Date.now()}))}catch{}s.value?.close(),s.value=null,f.value="Paused",n.value=`Paused (${h.value} words saved)`}},Ke=async()=>{if(!$.value)return;const t=Date.now()-(B.value||0),e=300*1e3;if(t>e){$.value=!1,D.value=!0,d.value=!1;return}if(!navigator.onLine){v.warning("No connection",{description:"Reconnect to resume."});return}f.value="Resuming",$.value=!1,pe(xe.value)},ze=()=>{typeof window<"u"&&(window.addEventListener("beforeunload",Ue),document.addEventListener("visibilitychange",Ge))},fe=()=>{typeof window<"u"&&(window.removeEventListener("beforeunload",Ue),document.removeEventListener("visibilitychange",Ge))},Xe=()=>{fe();try{localStorage.removeItem(`generation_pause_${i.chapter.id}`)}catch{}},Je=async()=>new Promise(t=>{let e=0;const g=120,o=async()=>{try{const p=await(await fetch(j("api.projects.paper-collection.status",{project:i.project.slug}))).json();if(p.success&&p.data){Pe.value=p.data;const R=p.data.status,P=p.data.papers_count||p.data.count||0,_=p.data.message,H=p.data.percentage||0,m=p.data.current_source,ee=p.data.sources_completed||[],O=p.data.papers_preview||[];if(Ce.value=P,be.value=H,Te.value=m,Ee.value=ee,Ae.value=O,R==="completed"){Z.value="Complete",Q.value=`âœ“ Collected ${P} verified sources from ${ee.length} databases`,c.value=50,N.value=!1,U.value&&clearInterval(U.value),t(!0);return}else if(["collecting_papers","initializing","processing","storing"].includes(R)){let K="";m&&(K={semantic_scholar:"Semantic Scholar",openalex:"OpenAlex",arxiv:"arXiv",crossref:"CrossRef",pubmed:"PubMed"}[m]||m),Z.value=K||"Collecting Sources",Q.value=_||"Collecting sources from academic databases...",c.value=Math.min(5+H*.4,45)}else if(R==="collection_failed"){Z.value="Error",Q.value=_||"âŒ Source collection failed",N.value=!1,U.value&&clearInterval(U.value),t(!1);return}}e++,e>=g&&(Z.value="Timeout",Q.value="â±ï¸ Source collection timed out",N.value=!1,U.value&&clearInterval(U.value),t(!1))}catch(u){console.error("Error checking paper collection status:",u),e++}};o(),U.value=setInterval(o,5e3)}),Le=async()=>{N.value=!0,Z.value="Starting",Q.value="Initializing source collection...",c.value=5;try{const t=document.querySelector('meta[name="csrf-token"]')?.content;if(!t)throw new Error("CSRF token not found - please refresh the page");const e=await fetch(j("api.projects.paper-collection.start",{project:i.project.slug}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!e.ok){const g=await e.text();if(console.error("API Error:",e.status,g),e.status===409)try{const o=JSON.parse(g);throw new Error(o.message||"Source collection is already in progress")}catch{throw new Error("Source collection is already in progress for this project")}throw new Error(`Failed to start source collection: ${e.status}`)}return await Je()}catch(t){return console.error("Paper collection failed:",t),Z.value="Error",Q.value="âŒ Source collection failed",N.value=!1,!1}},ge=async(t,e={})=>{const g=t==="improve"?300:C.chapter(y.value||0);if(!E(g,t==="improve"?"improve this chapter":"generate this chapter with AI")||!await Me())return;if(d.value=!0,w.value="",h.value=0,c.value=5,f.value="Papers",n.value="Checking for verified sources...",M.value=!0,ke(),I.value=y.value||0,Y.value=!0,!await Le()){v.error("Paper Collection Failed",{description:"Unable to collect verified papers. Please try again."}),d.value=!1,Y.value=!1;return}ze(),f.value="Initializing",n.value="Starting AI generation with verified sources...",c.value=51;const R=setInterval(()=>{c.value<52&&d.value?c.value+=.2:clearInterval(R)},100),P=j("chapters.stream",{project:i.project.slug,chapter:i.chapter.chapter_number});let _=`?generation_type=${t}`;e.section&&(_+=`&section_type=${encodeURIComponent(e.section)}`),e.selectedText&&(_+=`&selected_text=${encodeURIComponent(e.selectedText)}`),e.style&&(_+=`&style=${encodeURIComponent(e.style)}`),s.value=new EventSource(`${P}${_}`),s.value.onmessage=H=>{const m=JSON.parse(H.data);switch(m.type){case"start":f.value="Connecting",c.value=52,n.value="Connecting to AI service...",Ie();break;case"content":f.value="Writing",w.value+=m.content,h.value=m.word_count||w.value.split(/\s+/).filter(K=>K.length>0).length,a.value=w.value;const ee=Math.min(h.value/Math.max(I.value,1)*43,43);c.value=Math.max(52,52+ee),n.value=`Writing chapter content... (${h.value} / ${I.value} words)`,he();break;case"heartbeat":c.value<95&&(c.value+=.5);break;case"complete":f.value="Complete",c.value=100,d.value=!1,M.value=!1,T.value=null,a.value=w.value,fe();const O=m.final_word_count||h.value;n.value=`âœ“ Generated ${O} words successfully`,S(),me(O,`Chapter generation (${i.chapter.chapter_number})`,"chapter",i.chapter.id).catch(K=>console.error("Failed to record word usage (chapter generation):",K)),setTimeout(()=>{L()},500),s.value?.close(),s.value=null;break;case"error":f.value="Error",c.value=50,M.value=!1,T.value=null,fe(),m.partial_saved&&(V.value=!0,oe.value=m.saved_word_count||0),m.code==="OFFLINE_MODE"?(n.value="ðŸ“¡ AI services offline",d.value=!1,v.error("AI Services Offline",{description:"Please check your internet connection and try again."})):m.can_resume?(n.value=`âš ï¸ Generation interrupted (${m.saved_word_count} words saved)`,d.value=!1,D.value=!0,v.warning("Generation Interrupted",{description:`${m.saved_word_count} words were saved. You can resume generation.`,duration:8e3})):(n.value="âŒ Generation failed",d.value=!1,v.error("Generation Error",{description:m.message||"Please try again."})),s.value?.close(),s.value=null;break;case"autosave":m.word_count&&m.generation_id&&(ne.value=m.generation_id);break}},s.value.onerror=()=>{if(k.value<de){k.value++,W.value=!0,f.value="Reconnecting",n.value=`ðŸ”„ Connection lost. Reconnecting... (${k.value}/${de})`,s.value?.close(),s.value=null;const H=ie.value*Math.pow(2,k.value-1);setTimeout(()=>pe(t),H)}else f.value="Error",c.value=50,d.value=!1,W.value=!1,n.value="âŒ Connection failed after multiple attempts",fe(),h.value>100?(V.value=!0,oe.value=h.value,D.value=!0,v.warning("Connection Lost",{description:`${h.value} words have been saved. Check and resume if needed.`,duration:8e3})):v.error("Connection Error",{description:"Please check your internet connection and try again."}),s.value?.close(),s.value=null,k.value=0,ie.value=2e3}},pe=t=>{s.value&&(s.value.close(),s.value=null);const e=j("chapters.stream",{project:i.project.slug,chapter:i.chapter.chapter_number}),g=new URLSearchParams({generation_type:t,resume_from:h.value.toString()});ne.value&&g.set("generation_id",ne.value),s.value=new EventSource(`${e}?${g}`),s.value.onmessage=o=>{const u=JSON.parse(o.data);switch(["content","start"].includes(u.type)&&(W.value=!1,k.value=0,f.value="Writing"),u.type){case"start":n.value="âœ… Reconnected! Continuing generation...",Ie(),v.success("Reconnected",{description:"Generation resumed successfully.",duration:3e3});break;case"content":f.value="Writing",w.value+=u.content,h.value=u.word_count||w.value.split(/\s+/).filter(P=>P.length>0).length;const p=Date.now();if(p-q.value>150){a.value=w.value,q.value=p;const P=Math.min(h.value/Math.max(I.value,1)*43,43);c.value=Math.max(52,52+P),n.value=`Writing chapter content... (${h.value} / ${I.value} words)`,he()}break;case"complete":f.value="Complete",c.value=100,d.value=!1,W.value=!1,T.value=null,a.value=w.value;const R=u.final_word_count||h.value;n.value=`âœ“ Generated ${R} words successfully`,me(R,`Chapter generation (${i.chapter.chapter_number})`,"chapter",i.chapter.id).catch(P=>console.error("Failed to record word usage:",P)),setTimeout(()=>{L()},500),s.value?.close(),s.value=null;break;case"error":f.value="Error",d.value=!1,W.value=!1,T.value=null,n.value="âŒ Generation failed",v.error("Generation Error",{description:u.message||"Please try again."}),s.value?.close(),s.value=null;break;case"autosave":u.generation_id&&(ne.value=u.generation_id);break}},s.value.onerror=()=>{if(k.value<de){k.value++;const o=ie.value*Math.pow(2,k.value-1);n.value=`ðŸ”„ Reconnecting... (${k.value}/${de})`,s.value?.close(),setTimeout(()=>pe(t),o)}else f.value="Error",d.value=!1,W.value=!1,n.value="âŒ Connection failed",h.value>100?(D.value=!0,v.warning("Connection Lost",{description:`${h.value} words may be saved. Refresh to recover.`})):v.error("Connection Error",{description:"Please check your connection and try again."}),s.value?.close(),s.value=null,k.value=0}},Fe=async t=>{d.value=!0,w.value="",h.value=0,c.value=5,f.value="Papers",n.value="Checking for verified sources...",I.value=600,re.value=a.value||i.chapter.content||"",Y.value=!0;try{c.value=50,f.value="Papers",n.value="Using existing verified sources...",await new Promise(g=>setTimeout(g,500)),f.value="Section",n.value=`Writing ${t} section with verified sources...`,c.value=51;const e=j("chapters.stream",{project:i.project.slug,chapter:i.chapter.chapter_number});s.value=new EventSource(`${e}?generation_type=section&section_type=${t}`),s.value.onmessage=g=>{const o=JSON.parse(g.data);switch(o.type){case"start":f.value="Writing Section",c.value=52,n.value=`Starting ${t} section generation...`;break;case"content":w.value+=o.content,h.value=o.word_count||G(w.value);const u=Date.now();if(u-q.value>150){a.value=re.value+`

`+w.value,q.value=u;const p=Math.min(h.value/I.value*43,43);c.value=Math.max(52,52+p),n.value=`Writing ${t} section... (${h.value} / ${I.value} words)`,S(),he()}break;case"complete":c.value=100,f.value="Complete",n.value=`âœ“ Generated ${t} section (${h.value} words)`,a.value=re.value+`

`+w.value,b(!0),v.success("âœ… Section Generated Successfully",{description:`Added ${t} section with ${h.value} words and verified citations.`,duration:5e3}),d.value=!1,s.value?.close();break;case"error":throw new Error(o.message||"Section generation failed");case"heartbeat":c.value<95&&(c.value+=.5);break}},s.value.onerror=()=>{d.value=!1,f.value="Error",n.value="âŒ Section generation failed",v.error("âŒ Generation Failed",{description:"Unable to generate section. Please check your connection and try again."}),s.value?.close()}}catch(e){console.error("Section generation failed:",e),d.value=!1,f.value="Error",n.value="âŒ Section generation error",v.error("âŒ Generation Failed",{description:"Section generation encountered an error."})}},ye=async(t,e,g)=>{const o=t.split(/\s+/).length;if(!E(300,`${e} selected text`))return;d.value=!0,w.value="",h.value=0,c.value=10,f.value=e==="rephrase"?"Rephrasing":"Expanding",n.value=`${e==="rephrase"?"Rephrasing":"Expanding"} selected text...`,I.value=Math.max(o*(e==="expand"?2:1),100);const p=X.value||z.value,R=p?.getSelectionRange(),P={originalText:t,range:R,wordCount:o,style:g||"Academic Formal",startTime:Date.now()};Y.value=!0;try{const _=document.querySelector('meta[name="csrf-token"]')?.content;if(!_)throw new Error("CSRF token not found - please refresh the page");const H=e==="rephrase"?j("chapters.quick-actions.rephrase",{project:i.project.slug,chapter:i.chapter.chapter_number}):j("chapters.quick-actions.expand",{project:i.project.slug,chapter:i.chapter.chapter_number});c.value=35;const m=await fetch(H,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":_,"X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify({text:t,...e==="rephrase"?{style:P.style}:{}})});if(!m.ok){let te=`Request failed (${m.status})`;try{const ce=await m.json();te=ce?.message||ce?.error||ce?.data?.message||te}catch{}throw new Error(te)}const ee=await m.json(),O=String(ee?.text||"").trim();if(!O)throw new Error("Empty response from AI service");c.value=100,f.value="Complete",n.value=`âœ“ Text ${e==="rephrase"?"rephrased":"expanded"} successfully`,P.range&&(p?.replaceSelection(O,P.range)?setTimeout(()=>{const ce=p?.getHTML()||a.value;a.value=ce},50):v.warning("Please manually replace the selected text",{description:"The generated text is ready but could not be automatically inserted."})),b(!0),v.success(`âœ… Text ${e==="rephrase"?"Rephrased":"Expanded"} Successfully`,{description:`${e==="rephrase"?"Rephrased":"Expanded"} selection (${o} words).`});const K=Number(ee?.word_count)||G(O)||(e==="expand"?o*2:o);me(K,e==="rephrase"?`Rephrase (${P.style})`:"Expand text","chapter",i.chapter.id).catch(te=>console.error(`Failed to record word usage (${e}):`,te)),d.value=!1}catch(_){console.error("Selection generation failed:",_),d.value=!1,f.value="Error",n.value=`âŒ Text ${e==="rephrase"?"rephrasing":"expansion"} error`,v.error(`âŒ ${e==="rephrase"?"Rephrasing":"Expansion"} Failed`,{description:_ instanceof Error?_.message:"Text generation encountered an error."})}};return{isGenerating:d,generationProgress:n,generationPercentage:c,generationPhase:f,estimatedTotalWords:I,streamWordCount:h,streamBuffer:w,lastStreamUpdate:q,originalContentForAppend:re,aiSuggestions:le,isLoadingSuggestions:J,showCitationHelper:ue,showPresentationMode:Y,isStreamingMode:M,showRecoveryDialog:D,partialContentSaved:V,savedWordCountOnError:oe,isCollectingPapers:N,paperCollectionProgress:Q,paperCollectionPhase:Z,collectedPapersCount:Ce,paperCollectionPercentage:be,currentSource:Te,sourcesCompleted:Ee,papersPreview:Ae,paperCollectionData:Pe,paperCollectionInterval:U,reconnectAttempts:k,reconnectDelay:ie,isReconnecting:W,currentGenerationId:ne,currentGenerationType:xe,eventSource:s,editorScrollRef:$e,attachScroller:_e,smoothScrollToBottom:Be,forceScrollToBottom:je,resetScroller:ke,isAutoScrollActive:qe,isUserScrollingScroller:Ne,scrollToBottom:he,checkConnectionQuality:Me,startPaperCollection:Le,startStreamingGeneration:ge,attemptReconnection:pe,startSectionGeneration:Fe,handleSelectionGeneration:ye,handleAIGeneration:(t,e)=>{t==="section"&&e?.section?Fe(e.section):t==="rephrase"&&e?.selectedText?ye(e.selectedText,"rephrase",e.style):t==="expand"&&e?.selectedText?ye(e.selectedText,"expand"):ge(t)},handleRegenerateChapter:async(t=!1)=>{if(!t)return!1;const e=C.chapter(y.value||0);return E(e,"regenerate this chapter")?(a.value&&a.value.trim().length>0&&(Se("Before regenerate"),v.info("Previous content saved",{description:"You can undo to restore it if needed.",duration:3e3})),a.value="",await ge("progressive"),!0):!1},getAISuggestions:async()=>{if(!F.value)return;const t=C.suggestion();if(E(t,"get AI suggestions")){J.value=!0;try{const g=await(await fetch(j("chapters.suggestions",{project:i.project.slug,chapter:i.chapter.chapter_number}),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({selected_text:F.value,context:a.value})})).json();le.value=g.suggestions||[],le.value.length&&me(C.suggestion(),"AI suggestions","chapter",i.chapter.id).catch(o=>console.error("Failed to record word usage (suggestions):",o))}catch{v.error("Error getting suggestions",{description:"Please try again."})}finally{J.value=!1}}},checkCitations:()=>{ue.value=!0,v.success("Citation Manager opened!",{description:"Review and verify your citations in the panel below."})},insertCitation:t=>{try{const e=X.value?.editor||z.value?.editor;if(!e){v.error("Editor not found");return}const{from:g}=e.state.selection;e.chain().focus().insertContentAt(g,` ${t} `).run(),v.success("Citation inserted successfully")}catch(e){console.error("Failed to insert citation:",e),v.error("Failed to insert citation")}},resumeGeneration:()=>{D.value=!1,V.value=!1,window.location.reload()},dismissRecovery:()=>{D.value=!1,V.value=!1,oe.value=0},checkForAutoGeneration:()=>{const t=new URLSearchParams(window.location.search),e=t.get("ai_generate")==="true",g=t.get("generation_type");!e||!g||setTimeout(()=>{ge("progressive");const o=new URL(window.location.href);o.searchParams.delete("ai_generate"),o.searchParams.delete("generation_type"),window.history.replaceState({},"",o.toString()),v.success("ðŸš€ AI Generation Started",{description:`Writing ${i.chapter.title} with AI assistance...`})},1e3)},stopGeneration:()=>{!d.value&&!N.value||(s.value&&(s.value.close(),s.value=null),U.value&&(clearInterval(U.value),U.value=null),w.value&&h.value>0?(a.value=w.value,v.info("Generation Stopped",{description:`${h.value} words have been saved. You can continue editing or regenerate.`,duration:5e3})):v.info("Generation Stopped",{description:"Generation was cancelled.",duration:3e3}),d.value=!1,M.value=!1,N.value=!1,W.value=!1,k.value=0,ie.value=2e3,f.value="Stopped",n.value="Generation stopped by user",T.value=null,h.value>0&&setTimeout(()=>{L()},500))},contentHistory:A,canUndo:ve,pushToHistory:Se,undoLastAction:We,clearHistory:He,cleanupGenerationProtection:Xe}}function ht(i){const{delay:a=1e4,onSave:y}=i,C=r(!1),E=r(!1),b=r(null),L=()=>{C.value=!0,b.value&&clearTimeout(b.value),b.value=setTimeout(()=>{S(!0)},a)},S=async(F=!1)=>{if(!E.value){E.value=!0;try{await y(F),C.value=!1,b.value&&(clearTimeout(b.value),b.value=null)}finally{E.value=!1}}};return{hasUnsavedChanges:C,isSaving:E,triggerAutoSave:L,save:S,clearAutoSave:()=>{b.value&&(clearTimeout(b.value),b.value=null)}}}function ft(i,a=r(3e3),y=.8){const C=l=>{if(!l)return 0;const B=l.replace(/<[^>]*>/g,"").trim().replace(/\s+/g," ");if(!B)return 0;const A=B.match(/\b\w+\b/g);return A?A.length:0},E=l=>l?l.replace(/<[^>]*>/g,"").replace(/\r\n|\r/g,`
`).trim().split(/\n\s*\n/).filter(we=>we.trim().length>0).length:0,b=l=>{if(!l)return 0;const B=l.replace(/<[^>]*>/g,"").match(/[.!?]+/g);return B?B.length:0},L=l=>Math.round(l/200*10)/10,S=x(()=>C(i.value)),G=x(()=>i.value.length),F=x(()=>i.value.replace(/\s/g,"").length),z=x(()=>E(i.value)),X=x(()=>b(i.value)),ae=x(()=>L(S.value)),d=x(()=>{const l=a.value;return!l||l<=0?0:Math.min(S.value/l*100,100)}),n=x(()=>S.value>=a.value*y),c=x(()=>{const l=a.value-S.value;return Math.max(l,0)}),f=x(()=>{const l=a.value*y-S.value;return Math.max(l,0)}),I=x(()=>({wordCount:S.value,characterCount:G.value,characterCountNoSpaces:F.value,paragraphCount:z.value,sentenceCount:X.value,readingTimeMinutes:ae.value})),h=x(()=>({current:S.value,target:a.value,percentage:d.value,isComplete:n.value,completionThreshold:y})),w=l=>l>=1e3?`${Math.round(l/100)/10}k`:l.toString(),q=(l=0)=>`${Math.round(d.value*Math.pow(10,l))/Math.pow(10,l)}%`,re=()=>`${S.value} / ${a.value} words (${q()}%)`,le=()=>{if(n.value)return`âœ… Complete (${w(S.value)} words)`;const l=f.value;return`${w(l)} more words to complete`},J=()=>{const l=S.value,$=a.value;return l===0?"empty":l<$*.25?"started":l<$*.75?"progressing":l<$*y?"near_complete":l<$?"complete":"exceeded"},ue=()=>{const l=J();return{empty:"text-gray-500",started:"text-blue-500",progressing:"text-yellow-500",near_complete:"text-orange-500",complete:"text-green-500",exceeded:"text-emerald-600"}[l]},Y=()=>{const l=J();return{empty:"bg-gray-200",started:"bg-blue-200",progressing:"bg-yellow-200",near_complete:"bg-orange-200",complete:"bg-green-200",exceeded:"bg-emerald-200"}[l]},M=800,D=x(()=>S.value>=M),V=x(()=>Math.max(M-S.value,0)),oe=x(()=>Math.min(S.value/M*100,100));return{currentWordCount:S,characterCount:G,characterCountNoSpaces:F,paragraphCount:z,sentenceCount:X,readingTimeMinutes:ae,progressPercentage:d,isComplete:n,wordsRemaining:c,wordsToComplete:f,wordCountStats:I,wordCountProgress:h,meetsDefenseThreshold:D,defenseWordsRemaining:V,defenseProgressPercentage:oe,DEFENSE_THRESHOLD:M,formatWordCount:w,formatProgress:q,getProgressDisplay:re,getCompletionDisplay:le,getWordCountStatus:J,getStatusColor:ue,getProgressBarColor:Y,countWords:C}}export{ft as a,dt as b,ht as u};
