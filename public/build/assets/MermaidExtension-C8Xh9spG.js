import{N as Le,a as De,V as Se,m as qe}from"./vendor-tiptap-DuG0yIO_.js";import{bu as Be,bt as b,ck as E,fW as O,fX as oe,ei as le,fY as Ee,cC as Ae,fZ as de,f_ as Re,f$ as Ne,g0 as ze,dk as Ue,ci as G,bB as Ve,cR as je,cn as x,co as u,cp as C,cr as s,cB as _,cG as A,cu as I,dB as Oe,ct as R,cq as f,cs as K,bF as n,dU as Z,g1 as ce,cv as Fe,g2 as He,g3 as Pe,g4 as $e,eu as Ge,dF as Ie,dT as ue,fr as Ke,eA as Ze,dN as Ye,cw as Xe,eE as Je,eF as Qe,fc as et,c$ as tt,bE as F,aP as at}from"./vendor-BJBNFzu6.js";import{_ as T}from"./index-DKTzjY4t.js";import{m as Y}from"./vendor-mermaid-DjbGXZoA.js";import{_ as rt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const st={class:"flex items-center justify-between gap-2 px-3 py-2 bg-muted/50 border-b border-border"},nt={class:"flex items-center gap-2"},it={key:0,class:"text-xs text-destructive flex items-center gap-1"},ot={class:"flex items-center gap-1"},lt={key:0,class:"flex items-center gap-1 px-1 border-l border-border ml-1"},dt={class:"text-xs font-medium w-10 text-center"},ct={class:"relative"},ut={key:0,class:"p-3"},mt=["onKeydown"],ft={key:0,class:"mt-2 p-3 rounded-md bg-destructive/10 border border-destructive/30"},gt={class:"flex items-start gap-2"},pt={class:"text-sm"},vt={class:"text-muted-foreground mt-1 font-mono text-xs whitespace-pre-wrap"},ht={key:1,class:"p-4"},yt={key:0,class:"flex items-center justify-center min-h-[200px]"},wt={class:"flex flex-col items-center gap-3"},bt={key:1,class:"flex flex-col items-center justify-center min-h-[200px] text-center"},xt={class:"text-sm text-muted-foreground mt-1 max-w-md"},Ct=["innerHTML"],kt=Be({__name:"MermaidNodeView",props:{node:{type:Object,required:!0},editor:{type:Object,required:!0},selected:{type:Boolean,default:!1},getPos:{type:Function,required:!0},updateAttributes:{type:Function,required:!0},deleteNode:{type:Function,required:!0}},setup(r){let a=!1,g=null,v=null;const d=r,l=b(d.node.attrs.code||""),c=b(""),y=b(""),i=b(!1),w=b(!1),k=b(!1),H=b(!1),J=b(null),Q=b(null),N=b(0),m=b(d.node.attrs.scale||100),h=E(()=>d.node.attrs.viewMode==="code"),z=E(()=>d.node.attrs.diagramType||"flowchart"),me=E(()=>({flowchart:"Flowchart",sequence:"Sequence",class:"Class",state:"State",er:"ER Diagram",gantt:"Gantt",pie:"Pie Chart",journey:"Journey",git:"Git Graph",mindmap:"Mind Map",timeline:"Timeline",quadrant:"Quadrant",requirement:"Requirement",c4:"C4 Diagram",unknown:"Diagram"})[z.value]||"Diagram"),fe=E(()=>({flowchart:de,sequence:Ue,class:O,state:ze,er:oe,gantt:le,pie:Ne,journey:Re,git:de,mindmap:Ae,timeline:Ee,quadrant:le,requirement:O,c4:oe,unknown:O})[z.value]||O),ge=E(()=>i.value?"bg-destructive/10 text-destructive":"bg-primary/10 text-primary"),ee=()=>{const t=pe(),e=JSON.stringify(t);a&&g===e||(a=!0,g=e,Y.initialize({startOnLoad:!1,theme:"base",securityLevel:"loose",fontFamily:"ui-sans-serif, system-ui, sans-serif",themeVariables:t,flowchart:{useMaxWidth:!0,htmlLabels:!0,curve:"basis"},sequence:{useMaxWidth:!0,wrap:!0},gantt:{useMaxWidth:!0}}))},p=t=>{if(typeof window>"u"||typeof document>"u"||!document.body)return t;const e=document.createElement("span");e.style.color=t,e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",document.body.appendChild(e);const o=window.getComputedStyle(e).color;return document.body.removeChild(e),o||t},pe=()=>{const t=typeof document<"u"&&document.documentElement.classList.contains("dark");return{fontFamily:"ui-sans-serif, system-ui, sans-serif",background:p("hsl(var(--background))"),textColor:p("hsl(var(--foreground))"),nodeTextColor:p("hsl(var(--foreground))"),mainBkg:p(t?"hsl(var(--muted))":"hsl(var(--card))"),lineColor:p("hsl(var(--border))"),nodeBorder:p("hsl(var(--border))"),clusterBkg:p(t?"hsl(var(--background))":"hsl(var(--muted))"),clusterBorder:p("hsl(var(--border))"),titleColor:p("hsl(var(--foreground))"),primaryColor:p("hsl(var(--primary))"),primaryTextColor:p("hsl(var(--primary-foreground))"),secondaryColor:p("hsl(var(--secondary))"),tertiaryColor:p("hsl(var(--muted))"),edgeLabelBackground:p("hsl(var(--background))")}},W=async()=>{if(ee(),!l.value.trim()){i.value=!0,y.value="No diagram code provided",c.value="";return}w.value=!0,i.value=!1,y.value="";const t=++N.value;try{await Y.parse(l.value);const e=`mermaid-${Date.now()}-${t}`,{svg:o}=await Y.render(e,l.value,Q.value??void 0);t===N.value&&(c.value=o,i.value=!1,y.value="",d.updateAttributes({error:null}))}catch(e){if(t===N.value){i.value=!0;const o=e;y.value=ve(o.message||"Unknown error"),d.updateAttributes({error:y.value})}}finally{t===N.value&&(w.value=!1)}},ve=t=>{let e=t.replace(/^Error: /,"").replace(/^Syntax error in text/,"Syntax error").replace(/mermaid version [\d.]+/,"").trim();return e.length>200&&(e=e.substring(0,200)+"..."),e};let M=null;const he=()=>{M&&clearTimeout(M),M=setTimeout(()=>{const t=ae(l.value);d.updateAttributes({code:l.value,diagramType:t}),h.value||W()},500)},ye=()=>{M&&(clearTimeout(M),M=null);const t=ae(l.value);d.updateAttributes({code:l.value,diagramType:t})},te=()=>{const t=h.value?"diagram":"code";d.updateAttributes({viewMode:t}),t==="diagram"?F(()=>W()):F(()=>{J.value?.focus()})},we=async()=>{try{await navigator.clipboard.writeText(l.value),H.value=!0,setTimeout(()=>{H.value=!1},2e3)}catch(t){console.error("Failed to copy:",t)}},be=()=>{if(!c.value)return;const t=new Blob([c.value],{type:"image/svg+xml"}),e=URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download=`diagram-${z.value}-${Date.now()}.svg`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(e)},xe=async()=>{if(!(!c.value||k.value)){k.value=!0;try{const t=document.createElement("div");t.innerHTML=c.value;const e=t.querySelector("svg");if(!e)throw new Error("SVG element not found");const o=e.getBBox(),L=Math.ceil(o.width+o.x*2)||800,D=Math.ceil(o.height+o.y*2)||600,S=m.value/100,P=Math.ceil(L*S*2),$=Math.ceil(D*S*2);e.setAttribute("width",String(L)),e.setAttribute("height",String(D));let U=new XMLSerializer().serializeToString(e);U.startsWith("<?xml")||(U='<?xml version="1.0" encoding="UTF-8"?>'+U);const _e=new Blob([U],{type:"image/svg+xml;charset=utf-8"}),re=URL.createObjectURL(_e),q=new Image;q.crossOrigin="anonymous",await new Promise((We,se)=>{q.onload=()=>{const V=document.createElement("canvas");V.width=P,V.height=$;const j=V.getContext("2d");if(!j){se(new Error("Could not get canvas context"));return}j.fillStyle="#ffffff",j.fillRect(0,0,P,$),j.drawImage(q,0,0,P,$),V.toBlob(ne=>{if(ne){const ie=URL.createObjectURL(ne),B=document.createElement("a");B.href=ie,B.download=`diagram-${z.value}-${Date.now()}.png`,document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(ie)}We()},"image/png",1)},q.onerror=()=>{se(new Error("Failed to load SVG image"))},q.src=re}),URL.revokeObjectURL(re)}catch(t){console.error("Failed to export PNG:",t)}finally{k.value=!1}}},Ce=()=>{m.value<200&&(m.value=Math.min(200,m.value+25),d.updateAttributes({scale:m.value}))},ke=()=>{m.value>25&&(m.value=Math.max(25,m.value-25),d.updateAttributes({scale:m.value}))},Te=()=>{m.value=100,d.updateAttributes({scale:100})},Me=t=>{const e=t.target,o=e.selectionStart,L=e.selectionEnd;l.value=l.value.substring(0,o)+"    "+l.value.substring(L),F(()=>{e.selectionStart=e.selectionEnd=o+4})},ae=t=>{const e=t.trim().toLowerCase();return e.startsWith("flowchart")||e.startsWith("graph")?"flowchart":e.startsWith("sequencediagram")||e.match(/^sequence\s/)?"sequence":e.startsWith("classdiagram")||e.match(/^class\s/)?"class":e.startsWith("statediagram")||e.match(/^state\s/)?"state":e.startsWith("erdiagram")||e.match(/^er\s/)?"er":e.startsWith("gantt")?"gantt":e.startsWith("pie")?"pie":e.startsWith("journey")?"journey":e.startsWith("gitgraph")?"git":e.startsWith("mindmap")?"mindmap":e.startsWith("timeline")?"timeline":e.startsWith("quadrantchart")?"quadrant":e.startsWith("requirementdiagram")?"requirement":e.startsWith("c4context")||e.startsWith("c4container")||e.startsWith("c4component")?"c4":"unknown"};return G(()=>d.node.attrs.code,t=>{t!==l.value&&(l.value=t,h.value||W())}),G(()=>d.node.attrs.viewMode,t=>{t==="diagram"&&F(()=>W())}),G(()=>d.node.attrs.scale,t=>{t&&t!==m.value&&(m.value=t)}),Ve(()=>{if(ee(),h.value||W(),typeof window<"u"&&typeof document<"u"){let t=null,e=document.documentElement.classList.contains("dark");const o=()=>{t&&clearTimeout(t),t=setTimeout(()=>{h.value||W()},50)};v=new MutationObserver(L=>{for(const D of L){if(D.type!=="attributes"||D.attributeName!=="class")continue;const S=document.documentElement.classList.contains("dark");S!==e&&(e=S,o())}}),v.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]})}}),je(()=>{M&&clearTimeout(M),v&&(v.disconnect(),v=null)}),(t,e)=>(u(),x(n(Le),{class:I(["mermaid-node-wrapper my-4 rounded-lg border border-border bg-card overflow-hidden",{"ring-2 ring-primary ring-offset-2":r.selected,"border-destructive":i.value}])},{default:C(()=>[s("div",st,[s("div",nt,[s("div",{class:I(["flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-medium",ge.value])},[(u(),x(Oe(fe.value),{class:"w-3.5 h-3.5"})),s("span",null,R(me.value),1)],2),i.value?(u(),_("span",it,[f(n(Z),{class:"w-3.5 h-3.5"}),e[1]||(e[1]=K(" Syntax Error ",-1))])):A("",!0)]),s("div",ot,[f(n(T),{variant:"ghost",size:"sm",class:"h-7 px-2 text-xs",onClick:te,title:h.value?"Show Diagram":"Edit Code"},{default:C(()=>[h.value?(u(),x(n(Fe),{key:1,class:"w-3.5 h-3.5 mr-1"})):(u(),x(n(ce),{key:0,class:"w-3.5 h-3.5 mr-1"})),K(" "+R(h.value?"Preview":"Edit"),1)]),_:1},8,["title"]),!h.value&&!i.value&&c.value?(u(),_("div",lt,[f(n(T),{variant:"ghost",size:"sm",class:"h-7 w-7 p-0",onClick:ke,title:"Zoom out",disabled:m.value<=25},{default:C(()=>[f(n(He),{class:"w-3.5 h-3.5"})]),_:1},8,["disabled"]),s("span",dt,R(m.value)+"%",1),f(n(T),{variant:"ghost",size:"sm",class:"h-7 w-7 p-0",onClick:Ce,title:"Zoom in",disabled:m.value>=200},{default:C(()=>[f(n(Pe),{class:"w-3.5 h-3.5"})]),_:1},8,["disabled"]),f(n(T),{variant:"ghost",size:"sm",class:"h-7 w-7 p-0",onClick:Te,title:"Reset zoom",disabled:m.value===100},{default:C(()=>[f(n($e),{class:"w-3.5 h-3.5"})]),_:1},8,["disabled"])])):A("",!0),f(n(T),{variant:"ghost",size:"sm",class:"h-7 w-7 p-0",onClick:we,title:"Copy code"},{default:C(()=>[H.value?(u(),x(n(Ge),{key:0,class:"w-3.5 h-3.5 text-green-500"})):(u(),x(n(Ie),{key:1,class:"w-3.5 h-3.5"}))]),_:1}),!h.value&&!i.value&&c.value?(u(),x(n(T),{key:1,variant:"ghost",size:"sm",class:"h-7 w-7 p-0",onClick:xe,disabled:k.value,title:"Download PNG"},{default:C(()=>[k.value?(u(),x(n(ue),{key:0,class:"w-3.5 h-3.5 animate-spin"})):(u(),x(n(Ke),{key:1,class:"w-3.5 h-3.5"}))]),_:1},8,["disabled"])):A("",!0),!h.value&&!i.value&&c.value?(u(),x(n(T),{key:2,variant:"ghost",size:"sm",class:"h-7 w-7 p-0",onClick:be,title:"Download SVG"},{default:C(()=>[f(n(Ze),{class:"w-3.5 h-3.5"})]),_:1})):A("",!0),f(n(T),{variant:"ghost",size:"sm",class:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:r.deleteNode,title:"Delete diagram"},{default:C(()=>[f(n(Ye),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick"])])]),s("div",ct,[h.value?(u(),_("div",ut,[Xe(s("textarea",{ref_key:"codeTextarea",ref:J,"onUpdate:modelValue":e[0]||(e[0]=o=>l.value=o),class:"w-full min-h-[200px] max-h-[400px] p-3 font-mono text-sm bg-muted/30 rounded-md border border-border focus:outline-none focus:ring-2 focus:ring-primary resize-y",placeholder:"Enter Mermaid diagram code...",spellcheck:"false",onInput:he,onBlur:ye,onKeydown:Je(Qe(Me,["prevent"]),["tab"])},null,40,mt),[[et,l.value]]),i.value?(u(),_("div",ft,[s("div",gt,[f(n(Z),{class:"w-4 h-4 text-destructive mt-0.5 shrink-0"}),s("div",pt,[e[2]||(e[2]=s("p",{class:"font-medium text-destructive"},"Diagram Error",-1)),s("p",vt,R(y.value),1)])])])):A("",!0),e[3]||(e[3]=s("div",{class:"mt-3 p-3 rounded-md bg-muted/30 text-xs text-muted-foreground"},[s("p",{class:"font-medium mb-2"},"Quick Reference:"),s("div",{class:"grid grid-cols-2 gap-2"},[s("code",{class:"bg-muted px-1.5 py-0.5 rounded"},"flowchart TD"),s("span",null,"Top-down flowchart"),s("code",{class:"bg-muted px-1.5 py-0.5 rounded"},"sequenceDiagram"),s("span",null,"Sequence diagram"),s("code",{class:"bg-muted px-1.5 py-0.5 rounded"},"classDiagram"),s("span",null,"Class diagram"),s("code",{class:"bg-muted px-1.5 py-0.5 rounded"},'pie title "Title"'),s("span",null,"Pie chart")])],-1))])):(u(),_("div",ht,[w.value?(u(),_("div",yt,[s("div",wt,[f(n(ue),{class:"w-8 h-8 animate-spin text-primary"}),e[4]||(e[4]=s("span",{class:"text-sm text-muted-foreground"},"Rendering diagram...",-1))])])):i.value&&!c.value?(u(),_("div",bt,[f(n(Z),{class:"w-12 h-12 text-destructive mb-3"}),e[6]||(e[6]=s("p",{class:"font-medium text-destructive"},"Unable to render diagram",-1)),s("p",xt,R(y.value),1),f(n(T),{variant:"outline",size:"sm",class:"mt-4",onClick:te},{default:C(()=>[f(n(ce),{class:"w-4 h-4 mr-2"}),e[5]||(e[5]=K(" Edit Code ",-1))]),_:1})])):(u(),_("div",{key:2,ref_key:"diagramContainer",ref:Q,class:I(["mermaid-diagram flex justify-center overflow-auto",{"opacity-50":i.value}])},[s("div",{class:"diagram-scale-wrapper transition-transform duration-200 origin-center",style:tt({transform:`scale(${m.value/100})`}),innerHTML:c.value},null,12,Ct)],2))]))])]),_:1},8,["class"]))}}),Tt=rt(kt,[["__scopeId","data-v-4e65a24f"]]),qt=De.create({name:"mermaid",group:"block",atom:!0,draggable:!0,addOptions(){return{HTMLAttributes:{class:"mermaid-block"}}},addAttributes(){return{code:{default:`flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Result 1]
    B -->|No| D[Result 2]`,parseHTML:r=>{const a=r.getAttribute("data-mermaid-code");if(a)return a;const g=r.querySelector("code");return g?g.textContent||"":r.textContent||""}},viewMode:{default:"diagram",parseHTML:r=>r.getAttribute("data-view-mode")||"diagram"},error:{default:null,parseHTML:()=>null},diagramType:{default:"flowchart",parseHTML:r=>r.getAttribute("data-diagram-type")||"flowchart"},scale:{default:100,parseHTML:r=>{const a=r.getAttribute("data-scale");return a?parseInt(a,10):100}}}},parseHTML(){return[{tag:"div[data-mermaid]"},{tag:"pre",getAttrs:r=>typeof r=="string"?!1:r.querySelector("code.language-mermaid")?{}:!1},{tag:"div.mermaid-container"}]},renderHTML({HTMLAttributes:r,node:a}){return["div",qe(this.options.HTMLAttributes,r,{"data-mermaid":"","data-mermaid-code":a.attrs.code,"data-view-mode":a.attrs.viewMode,"data-diagram-type":a.attrs.diagramType,"data-scale":String(a.attrs.scale||100)}),["pre",{},["code",{class:"language-mermaid"},a.attrs.code]]]},addNodeView(){return Se(Tt)},addCommands(){return{insertMermaid:r=>({commands:a})=>{const g=r||`flowchart TD
	    A[Start] --> B{Decision}
	    B -->|Yes| C[Result 1]
	    B -->|No| D[Result 2]`;return a.insertContent({type:this.name,attrs:{code:g,viewMode:"diagram",diagramType:X(g)}})},updateMermaid:r=>({commands:a,state:g})=>{const{selection:v}=g;return g.doc.nodeAt(v.from)?.type.name!==this.name?!1:a.updateAttributes(this.name,{code:r,diagramType:X(r),error:null})},toggleMermaidView:()=>({commands:r,state:a})=>{const{selection:g}=a,v=a.doc.nodeAt(g.from);if(v?.type.name!==this.name)return!1;const d=v.attrs.viewMode==="diagram"?"code":"diagram";return r.updateAttributes(this.name,{viewMode:d})}}},addProseMirrorPlugins(){const r=this.name,a=`flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Result 1]
    B -->|No| D[Result 2]`,g=(v,d)=>{const l=v.nodes[r];if(!l)return null;const c=d.trim()||a;return l.create({code:c,viewMode:"diagram",diagramType:X(c),error:null,scale:100})};return[new at({appendTransaction:(v,d,l)=>{if(!v.some(i=>i.docChanged))return null;const c=[];if(l.doc.descendants((i,w)=>{if(i.type.name!=="codeBlock")return;const k=i.attrs?.language;String(k||"").toLowerCase()==="mermaid"&&c.push({from:w,to:w+i.nodeSize,code:i.textContent})}),c.length===0)return null;const y=l.tr;for(const i of c.sort((w,k)=>k.from-w.from)){const w=g(l.schema,i.code);w&&y.replaceWith(i.from,i.to,w)}return y.docChanged?y:null}})]},addKeyboardShortcuts(){return{"Mod-Shift-m":()=>this.editor.commands.insertMermaid(),"Mod-Alt-m":()=>this.editor.commands.insertMermaid()}}});function X(r){const a=r.trim().toLowerCase();return a.startsWith("flowchart")||a.startsWith("graph")?"flowchart":a.startsWith("sequencediagram")||a.startsWith("sequence")?"sequence":a.startsWith("classdiagram")||a.startsWith("class")?"class":a.startsWith("statediagram")||a.startsWith("state")?"state":a.startsWith("erdiagram")||a.startsWith("er")?"er":a.startsWith("gantt")?"gantt":a.startsWith("pie")?"pie":a.startsWith("journey")?"journey":a.startsWith("gitgraph")?"git":a.startsWith("mindmap")?"mindmap":a.startsWith("timeline")?"timeline":a.startsWith("quadrantchart")?"quadrant":a.startsWith("requirementdiagram")?"requirement":a.startsWith("c4context")||a.startsWith("c4container")||a.startsWith("c4component")?"c4":"unknown"}export{qt as M};
