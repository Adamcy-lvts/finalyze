import{_ as j}from"./index-DXsLaJg_.js";import{_ as T}from"./index-Dh4Dof5h.js";import{a as $,_ as I}from"./CardContent.vue_vue_type_script_setup_true_lang-CHCDuRZd.js";import{_ as F,a as M}from"./CardTitle.vue_vue_type_script_setup_true_lang-CFv199a3.js";import{_ as P}from"./Progress.vue_vue_type_script_setup_true_lang-Dgae3pP5.js";import{_ as z}from"./ScrollArea.vue_vue_type_script_setup_true_lang-CUrnYQEM.js";import{_ as ee}from"./SafeHtmlText.vue_vue_type_script_setup_true_lang--LMJo8yA.js";import{bt as te,ch as se,bs as C,cR as oe,cB as r,co as a,cr as t,cq as n,cp as c,bE as l,eM as S,cz as V,ct as i,cs as f,cn as h,cG as u,it as ae,cA as A,dg as N,cS as B,df as L,cl as E,cb as O}from"./vendor-BwJgEX4g.js";import{R as le}from"./SelectLabel.vue_vue_type_script_setup_true_lang-BCwWObAm.js";import"./vendor-tiptap-C_SwIIdp.js";import"./MermaidExtension-BAW3KdnI.js";import"./vendor-mermaid-DpXUzUXc.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ie={class:"flex h-screen flex-col overflow-hidden bg-background"},ne={class:"flex flex-shrink-0 items-center justify-between border-b bg-background/95 p-3 backdrop-blur supports-[backdrop-filter]:bg-background/60"},re={class:"flex items-center gap-4"},de={class:"flex items-center gap-2"},ue={class:"text-sm text-muted-foreground"},ce={class:"flex items-center gap-2"},fe={class:"flex-shrink-0 bg-muted/30 px-3 py-2"},pe={class:"mb-1 flex items-center justify-between"},me={class:"text-xs text-muted-foreground"},ge={class:"flex flex-1 overflow-hidden"},ve={class:"flex min-h-0 flex-1 flex-col border-r"},xe={class:"flex-shrink-0 space-y-2"},he={class:"text-lg font-semibold"},_e={key:1,class:"flex items-center justify-center h-64 text-muted-foreground"},ye={class:"flex min-h-0 flex-1 flex-col bg-muted/20"},be={class:"flex-shrink-0 space-y-2"},ke={key:0,class:"flex gap-2"},Ce={key:0,class:"flex-shrink-0 space-y-2"},we={class:"text-sm text-muted-foreground p-3 bg-muted/50 rounded-md"},Te={key:0,class:"space-y-2"},Re={class:"flex items-center justify-between text-xs text-muted-foreground"},Ve={key:1,class:"flex-shrink-0"},je={class:"flex items-center justify-between"},$e={class:"grid grid-cols-2 gap-3 text-sm"},Ie={class:"flex items-center gap-2 p-2 rounded bg-background/50"},Pe={class:"font-medium"},Se={class:"flex items-center gap-2 p-2 rounded bg-background/50"},Ae={class:"font-medium"},Ne={class:"flex items-center gap-2 p-2 rounded bg-background/50"},Ee={class:"font-medium"},Fe={class:"flex items-center gap-2 p-2 rounded bg-background/50"},Me={class:"font-medium"},ze={key:0,class:"text-xs text-muted-foreground text-center"},Be={class:"space-y-3"},Le={key:0,class:"font-medium"},Oe={class:"flex items-center gap-2"},Ue={key:2,class:"h-4 w-4 rounded-full bg-gray-300"},qe={class:"text-sm bg-muted px-1 rounded"},We={class:"text-xs text-muted-foreground"},De={key:0},Xe={key:1,class:"font-medium pt-4"},Ye={class:"flex items-center justify-between"},Ge={class:"flex items-center gap-2"},He={class:"font-medium text-sm"},Je={class:"space-y-2"},Ke={key:0,class:"text-sm"},Qe={class:"font-medium text-primary"},Ze={class:"flex items-center gap-4 text-xs text-muted-foreground"},et={key:0},tt={key:1},st={key:1,class:"text-xs text-muted-foreground"},ot={key:2,class:"flex items-center gap-4 text-xs"},at={key:0,class:"flex items-center gap-1"},lt=["href"],it={key:1,class:"flex items-center gap-1"},nt=["href"],rt={key:3,class:"space-y-2"},dt={class:"text-xs text-muted-foreground"},ut={key:0,class:"ml-2"},ct={key:0,class:"mt-2 p-2 bg-muted/30 rounded border-l-2 border-green-500"},ft={class:"text-xs text-foreground italic"},pt={key:4,class:"space-y-2"},mt={key:0,class:"text-xs text-red-600"},gt={class:"flex items-center gap-2"},vt={class:"text-xs"},xt={class:"mt-1 p-2 bg-muted/20 rounded text-xs font-mono"},ht={key:2,class:"text-center text-muted-foreground py-8"},St=te({__name:"CitationVerificationLayout",props:{project:{},chapter:{},chapterTitle:{},chapterContent:{},currentWordCount:{},targetWordCount:{},progressPercentage:{}},emits:["exitCitationMode"],setup(U,{emit:q}){const k=U,W=q;se();const w=C([]),x=C([]),p=C({total:0,verified:0,failed:0,unverified:0,pending:0}),v=C(!1),_=C(!1),d=C(""),y=C({percentage:0,message:"",completed:!1});let R=null,b=null;const D=o=>{b&&clearInterval(b),b=setInterval(async()=>{try{const e=await O.get(E("api.citation-verification.progress",o));if(e.data.success){const s=e.data.progress;y.value=s,d.value=s.message,(s.completed||s.percentage>=100)&&(clearInterval(b),b=null,setTimeout(()=>X(o),1e3))}}catch(e){console.error("Error fetching progress:",e)}},1e3)},X=async o=>{try{const e=await O.get(E("api.citation-verification.result",o));if(e.data.success){const s=e.data;w.value=s.citations||[],x.value=s.references||[],p.value=s.summary||p.value,d.value=s.message||"Verification completed",_.value=!0}else d.value=e.data.message||"Failed to fetch results"}catch(e){console.error("Error fetching results:",e),d.value="Failed to fetch verification results"}finally{v.value=!1,y.value={percentage:100,message:"Completed",completed:!0},R=null}},Y=async()=>{if(!k.chapter?.id){console.error("No chapter ID available"),d.value="No chapter available to verify";return}v.value=!0,_.value=!1,y.value={percentage:0,message:"Initializing...",completed:!1},d.value="Starting async verification process...",console.log("=== ASYNC CITATION VERIFICATION START ==="),console.log("Chapter object:",k.chapter),console.log("Chapter ID:",k.chapter.id);try{const o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");console.log("CSRF token found:",!!o);const e=E("api.projects.chapters.verify-citations",{project:k.project.slug,chapter:k.chapter.slug});console.log("Generated URL:",e);const s={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":o||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin",body:JSON.stringify({})};console.log("About to make async fetch request to:",e);const m=await fetch(e,s);if(console.log("Response received:",m.status,m.statusText),!m.ok)throw new Error(`HTTP error! status: ${m.status}`);const g=await m.json();console.log("Initial response:",g),g.success&&g.async?(R=g.session_id,d.value=g.message,console.log("Starting progress tracking for session:",R),D(R)):g.success?(w.value=g.citations||[],x.value=g.references||[],p.value=g.summary||p.value,d.value=g.message||"Verification completed",_.value=!0,v.value=!1):(d.value=g.message||"Verification failed",v.value=!1)}catch(o){console.error("Citation verification error:",o),o.message&&o.message.includes("419")?d.value="Session expired. Please refresh the page and try again.":o.message&&o.message.includes("401")?d.value="Unauthorized. Please log in again.":o.message&&o.message.includes("404")?d.value="Chapter not found. Please try again.":o.message&&o.message.includes("500")?d.value="Server error. Please try again.":(console.error("Error:",o.message),d.value="An unexpected error occurred. Please try again."),v.value=!1,y.value={percentage:0,message:"",completed:!1}}},G=()=>{b&&(clearInterval(b),b=null)},H=async()=>{try{const o=x.value.filter(m=>m.status==="verified"&&m.formatted_citation);let e="";o.length>0?e=o.map(m=>m.formatted_citation).join(`

`):e=x.value.map(m=>{const g=m.authors?m.authors.join(", "):"Unknown",Q=m.year||"n.d.",Z=m.title||"Title not available";return`${g} (${Q}). ${Z}.`}).join(`

`),await navigator.clipboard.writeText(e);const s=d.value;d.value="References copied to clipboard!",setTimeout(()=>{d.value=s},2e3)}catch(o){console.error("Failed to copy references:",o),d.value="Failed to copy references to clipboard"}},J=()=>{console.log("Export references:",x.value),d.value="Export functionality coming soon!",setTimeout(()=>{d.value=_.value?`Verified ${p.value.verified} out of ${p.value.total} references using bibliography parsing`:""},2e3)},K=async o=>{console.log("Retrying reference:",o),d.value=`Retrying verification for reference ${o.id}...`,setTimeout(()=>{d.value='Individual retry functionality coming soon! Use "Verify Sources" to retry all.',setTimeout(()=>{d.value=_.value?`Verified ${p.value.verified} out of ${p.value.total} references using bibliography parsing`:""},2e3)},1e3)};return oe(()=>{G()}),(o,e)=>(a(),r("div",ie,[t("div",ne,[t("div",re,[n(l(T),{onClick:e[0]||(e[0]=s=>W("exitCitationMode")),variant:"ghost",size:"icon"},{default:c(()=>[n(l(S),{class:"h-4 w-4"})]),_:1}),t("div",de,[n(l(V),{class:"h-5 w-5 text-primary"}),t("div",null,[n(ee,{as:"h1",class:"text-lg font-bold",content:k.project.title},null,8,["content"]),t("p",ue," Citation Verification • Chapter "+i(k.chapter.chapter_number)+" • "+i(o.currentWordCount)+" / "+i(o.targetWordCount)+" words ",1)])])]),t("div",ce,[n(l(j),{variant:o.chapter.status==="approved"?"default":"secondary"},{default:c(()=>[f(i(o.chapter.status.replace("_"," ")),1)]),_:1},8,["variant"])])]),t("div",fe,[t("div",pe,[e[1]||(e[1]=t("span",{class:"text-xs font-medium"},"Writing Progress",-1)),t("span",me,i(Math.round(o.progressPercentage))+"%",1)]),n(l(P),{value:o.progressPercentage,class:"h-1"},null,8,["value"])]),t("div",ge,[t("div",ve,[n(l(I),{class:"flex min-h-0 flex-1 flex-col rounded-none border-0 bg-transparent shadow-none"},{default:c(()=>[n(l(F),{class:"flex-shrink-0 border-b px-4 py-3"},{default:c(()=>[n(l(M),{class:"text-base"},{default:c(()=>[f("Chapter "+i(o.chapter.chapter_number)+" - Content",1)]),_:1})]),_:1}),n(l($),{class:"flex min-h-0 flex-1 flex-col space-y-3 p-4"},{default:c(()=>[t("div",xe,[t("h2",he,i(o.chapterTitle||"Untitled Chapter"),1)]),n(l(z),{class:"min-h-0 flex-1"},{default:c(()=>[o.chapterContent?(a(),h(le,{key:0,content:o.chapterContent,class:"p-4",style:{"font-family":"'Times New Roman', serif","line-height":"1.6"}},null,8,["content"])):(a(),r("div",_e,[...e[2]||(e[2]=[t("p",null,"No content available to verify",-1)])]))]),_:1})]),_:1})]),_:1})]),t("div",ye,[n(l(I),{class:"flex min-h-0 flex-1 flex-col rounded-none border-0 bg-transparent shadow-none"},{default:c(()=>[n(l(F),{class:"flex-shrink-0 border-b px-4 py-3"},{default:c(()=>[n(l(M),{class:"text-base flex items-center gap-2"},{default:c(()=>[n(l(V),{class:"h-4 w-4"}),e[3]||(e[3]=f(" Citation Verification ",-1))]),_:1})]),_:1}),n(l($),{class:"flex min-h-0 flex-1 flex-col space-y-4 p-4"},{default:c(()=>[t("div",be,[n(l(T),{onClick:Y,disabled:v.value||!o.chapterContent,class:"w-full"},{default:c(()=>[v.value?(a(),h(l(ae),{key:0,class:"h-4 w-4 mr-2 animate-spin"})):(a(),h(l(V),{key:1,class:"h-4 w-4 mr-2"})),f(" "+i(v.value?"Verifying...":"Verify Sources"),1)]),_:1},8,["disabled"]),_.value&&x.value.length>0?(a(),r("div",ke,[n(l(T),{onClick:H,variant:"outline",size:"sm",class:"flex-1 text-xs"},{default:c(()=>[...e[4]||(e[4]=[f(" Copy References ",-1)])]),_:1}),n(l(T),{onClick:J,variant:"outline",size:"sm",class:"flex-1 text-xs"},{default:c(()=>[...e[5]||(e[5]=[f(" Export ",-1)])]),_:1})])):u("",!0)]),d.value||v.value?(a(),r("div",Ce,[t("div",we,i(d.value),1),v.value&&y.value.percentage>0?(a(),r("div",Te,[t("div",Re,[t("span",null,i(y.value.message),1),t("span",null,i(Math.round(y.value.percentage))+"%",1)]),n(l(P),{value:y.value.percentage,class:"h-2"},null,8,["value"])])):u("",!0)])):u("",!0),_.value?(a(),r("div",Ve,[n(l(I),{class:"bg-muted/30"},{default:c(()=>[n(l($),{class:"p-4 space-y-3"},{default:c(()=>[t("div",je,[e[6]||(e[6]=t("h4",{class:"font-medium text-sm"},"Verification Results",-1)),n(l(j),{variant:"outline",class:"text-xs"},{default:c(()=>[f(i(Math.round(p.value.verified/p.value.total*100))+"% verified ",1)]),_:1})]),n(l(P),{value:p.value.verified/p.value.total*100,class:"h-2"},null,8,["value"]),t("div",$e,[t("div",Ie,[e[7]||(e[7]=t("div",{class:"h-3 w-3 rounded-full bg-blue-500"},null,-1)),t("span",Pe,i(p.value.total),1),e[8]||(e[8]=t("span",{class:"text-muted-foreground text-xs"},"Total",-1))]),t("div",Se,[n(l(A),{class:"h-3 w-3 text-green-500"}),t("span",Ae,i(p.value.verified),1),e[9]||(e[9]=t("span",{class:"text-muted-foreground text-xs"},"Verified",-1))]),t("div",Ne,[n(l(S),{class:"h-3 w-3 text-red-500"}),t("span",Ee,i(p.value.failed||0),1),e[10]||(e[10]=t("span",{class:"text-muted-foreground text-xs"},"Failed",-1))]),t("div",Fe,[n(l(N),{class:"h-3 w-3 text-orange-500"}),t("span",Me,i(p.value.pending||0),1),e[11]||(e[11]=t("span",{class:"text-muted-foreground text-xs"},"Pending",-1))])]),p.value.processing_time_ms||d.value.includes("processing_time_ms")?(a(),r("div",ze,[...e[12]||(e[12]=[t("span",null,"Processing completed",-1)])])):u("",!0)]),_:1})]),_:1})])):u("",!0),_.value?(a(),h(l(z),{key:2,class:"min-h-0 flex-1"},{default:c(()=>[t("div",Be,[w.value.length>0?(a(),r("h3",Le,"In-text Citations")):u("",!0),(a(!0),r(B,null,L(w.value,s=>(a(),r("div",{key:s.id,class:"border rounded-md p-3 space-y-2"},[t("div",Oe,[s.status==="verified"?(a(),h(l(A),{key:0,class:"h-4 w-4 text-green-500"})):s.status==="unverified"?(a(),h(l(N),{key:1,class:"h-4 w-4 text-orange-500"})):(a(),r("div",Ue)),t("code",qe,i(s.text),1)]),t("div",We,[t("p",null,[e[13]||(e[13]=t("strong",null,"Author:",-1)),f(" "+i(s.author),1)]),t("p",null,[e[14]||(e[14]=t("strong",null,"Year:",-1)),f(" "+i(s.year),1)]),s.details?(a(),r("p",De,[e[15]||(e[15]=t("strong",null,"Status:",-1)),f(" "+i(s.details),1)])):u("",!0)])]))),128)),x.value.length>0?(a(),r("h3",Xe,"Reference List")):u("",!0),(a(!0),r(B,null,L(x.value,s=>(a(),r("div",{key:s.id,class:"border rounded-md p-4 space-y-3"},[t("div",Ye,[t("div",Ge,[s.status==="verified"?(a(),h(l(A),{key:0,class:"h-5 w-5 text-green-500"})):s.status==="failed"?(a(),h(l(S),{key:1,class:"h-5 w-5 text-red-500"})):(a(),h(l(N),{key:2,class:"h-5 w-5 text-orange-500"})),t("span",He,"Reference "+i(s.id),1)]),n(l(j),{variant:s.status==="verified"?"default":s.status==="failed"?"destructive":"secondary",class:"text-xs"},{default:c(()=>[f(i(s.status||"unverified"),1)]),_:2},1032,["variant"])]),t("div",Je,[s.title?(a(),r("div",Ke,[t("span",Qe,i(s.title),1)])):u("",!0),t("div",Ze,[s.authors&&s.authors.length>0?(a(),r("div",et,[e[16]||(e[16]=t("strong",null,"Authors:",-1)),f(" "+i(s.authors.join(", ")),1)])):u("",!0),s.year?(a(),r("div",tt,[e[17]||(e[17]=t("strong",null,"Year:",-1)),f(" "+i(s.year),1)])):u("",!0)]),s.journal||s.publisher?(a(),r("div",st,[e[18]||(e[18]=t("strong",null,"Published in:",-1)),f(" "+i(s.journal||s.publisher),1)])):u("",!0),s.doi||s.url?(a(),r("div",ot,[s.doi?(a(),r("div",at,[e[19]||(e[19]=t("strong",null,"DOI:",-1)),t("a",{href:"https://doi.org/"+s.doi,target:"_blank",class:"text-blue-600 hover:underline"},i(s.doi),9,lt)])):u("",!0),s.url&&!s.doi?(a(),r("div",it,[e[20]||(e[20]=t("strong",null,"URL:",-1)),t("a",{href:s.url,target:"_blank",class:"text-blue-600 hover:underline break-all"},i(s.url.length>40?s.url.substring(0,40)+"...":s.url),9,nt)])):u("",!0)])):u("",!0),s.status==="verified"?(a(),r("div",rt,[t("div",dt,[e[23]||(e[23]=t("strong",null,"Verification Method:",-1)),f(" "+i(s.verification_method||"api")+" ",1),s.confidence?(a(),r("span",ut,[e[21]||(e[21]=f(" | ",-1)),e[22]||(e[22]=t("strong",null,"Confidence:",-1)),f(" "+i(Math.round(s.confidence*100))+"% ",1)])):u("",!0)]),s.formatted_citation?(a(),r("div",ct,[e[24]||(e[24]=t("div",{class:"text-xs font-medium text-muted-foreground mb-1"},"Formatted Citation (APA):",-1)),t("div",ft,i(s.formatted_citation),1)])):u("",!0)])):u("",!0),s.status==="failed"?(a(),r("div",pt,[s.failure_reason?(a(),r("div",mt,[e[25]||(e[25]=t("strong",null,"Issue:",-1)),f(" "+i(s.failure_reason),1)])):u("",!0),t("div",gt,[n(l(T),{onClick:m=>K(s),variant:"outline",size:"sm",class:"text-xs h-6 px-2",disabled:v.value},{default:c(()=>[...e[26]||(e[26]=[f(" Retry ",-1)])]),_:2},1032,["onClick","disabled"]),e[27]||(e[27]=t("span",{class:"text-xs text-muted-foreground"}," Try searching with different criteria ",-1))])])):u("",!0),t("details",vt,[e[28]||(e[28]=t("summary",{class:"cursor-pointer text-muted-foreground hover:text-foreground"}," Show raw reference text ",-1)),t("div",xt,i(s.raw_text),1)])])]))),128)),w.value.length===0&&x.value.length===0?(a(),r("div",ht,[n(l(V),{class:"h-12 w-12 mx-auto mb-2 opacity-50"}),e[29]||(e[29]=t("p",null,"No citations found in this chapter",-1)),e[30]||(e[30]=t("p",{class:"text-xs"},"Citations will appear here when detected",-1))])):u("",!0)])]),_:1})):u("",!0)]),_:1})]),_:1})])])]))}});export{St as default};
