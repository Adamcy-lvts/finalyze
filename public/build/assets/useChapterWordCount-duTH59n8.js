import{s as N}from"./useAppearance-DRazjLJ1.js";import{r as n,x as Be,G as De,aI as v,J as Re,l as x}from"./vendor-H8yUxHVJ.js";import{r as he}from"./useWordBalance-C1hXK7OD.js";const Ne={userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100};class He{scrollContainer=null;isUserScrolling=!1;userScrollTimeout=null;isEnabled=!0;isDestroyed=!1;config;wasAtBottom=!0;rafId=null;handleWheel;handleTouchStart;handleTouchMove;handleScroll;handleKeydown;constructor(r={}){this.config={...Ne,...r},this.handleWheel=this.onUserScroll.bind(this),this.handleTouchStart=this.onUserScroll.bind(this),this.handleTouchMove=this.onUserScroll.bind(this),this.handleScroll=this.onScroll.bind(this),this.handleKeydown=this.onKeydown.bind(this)}attach(r){this.isDestroyed||(this.detach(),this.scrollContainer=r,this.setupEventListeners(),this.wasAtBottom=this.isAtBottom())}detach(){this.scrollContainer&&(this.scrollContainer.removeEventListener("wheel",this.handleWheel),this.scrollContainer.removeEventListener("touchstart",this.handleTouchStart),this.scrollContainer.removeEventListener("touchmove",this.handleTouchMove),this.scrollContainer.removeEventListener("scroll",this.handleScroll),this.scrollContainer.removeEventListener("keydown",this.handleKeydown)),this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.scrollContainer=null}setupEventListeners(){this.scrollContainer&&(this.scrollContainer.addEventListener("wheel",this.handleWheel,{passive:!0}),this.scrollContainer.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.scrollContainer.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.scrollContainer.addEventListener("scroll",this.handleScroll,{passive:!0}),this.scrollContainer.addEventListener("keydown",this.handleKeydown))}onUserScroll(){this.isEnabled&&(this.isUserScrolling=!0,this.userScrollTimeout&&clearTimeout(this.userScrollTimeout),this.userScrollTimeout=setTimeout(()=>{this.isUserScrolling=!1,this.isAtBottom()&&(this.wasAtBottom=!0)},this.config.userScrollTimeout))}onScroll(){this.wasAtBottom=this.isAtBottom()}onKeydown(r){["ArrowUp","ArrowDown","PageUp","PageDown","Home","End"].includes(r.key)&&this.onUserScroll()}isAtBottom(){if(!this.scrollContainer)return!0;const{scrollTop:r,scrollHeight:y,clientHeight:C}=this.scrollContainer;return y-r-C<=this.config.bottomThreshold}scrollToBottom(){!this.scrollContainer||!this.isEnabled||this.isDestroyed||this.isUserScrolling||!this.wasAtBottom||(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{if(this.rafId=null,!this.scrollContainer||this.isDestroyed)return;const r=this.scrollContainer.scrollHeight-this.scrollContainer.clientHeight;this.config.scrollBehavior==="instant"?this.scrollContainer.scrollTop=r:this.scrollContainer.scrollTo({top:r,behavior:"smooth"}),this.wasAtBottom=!0}))}forceScrollToBottom(){!this.scrollContainer||this.isDestroyed||(this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.scrollToBottom())}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isAutoScrollActive(){return this.isEnabled&&!this.isUserScrolling&&this.wasAtBottom}isUserScrollingNow(){return this.isUserScrolling}reset(){this.isUserScrolling=!1,this.wasAtBottom=!0,this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null)}destroy(){this.isDestroyed=!0,this.detach()}}function Oe(s={}){const r=new He(s),y=n(!0),C=n(!1);let A=null;function T(l){l?(r.attach(l),w()):(r.detach(),F())}function q(l){De(l,c=>{T(c)},{immediate:!0})}function w(){F(),A=setInterval(()=>{y.value=r.isAutoScrollActive(),C.value=r.isUserScrollingNow()},100)}function F(){A&&(clearInterval(A),A=null)}function B(){r.scrollToBottom()}function W(){r.forceScrollToBottom()}function K(){r.enable()}function ee(){r.disable()}function d(){r.reset(),y.value=!0,C.value=!1}return Be(()=>{F(),r.destroy()}),{attach:T,attachRef:q,scrollToBottom:B,forceScrollToBottom:W,enable:K,disable:ee,reset:d,isAutoScrollActive:y,isUserScrolling:C}}function at({props:s,chapterContent:r,targetWordCount:y,estimates:C,ensureBalance:A,save:T,triggerAutoSave:q,calculateWritingStats:w,countWords:F,selectedText:B,richTextEditor:W,richTextEditorFullscreen:K,isNativeFullscreen:ee}){const d=n(!1),l=n(""),c=n(0),h=n(""),_=n(0),f=n(0),S=n(""),L=n(0),te=n(""),ae=n([]),z=n(!1),ie=n(!1),X=n(!1),R=n(!1),H=n(!1),J=n(!1),re=n(0),a=n([]),G=10,I=n(!1),D=n(null),j=n(!1),Y=n(""),Q=n(""),me=n(0),we=n(0),Se=n(null),ye=n([]),Ce=n([]),Te=n(null),M=n(null),k=n(0),ce=3,oe=n(2e3),O=n(!1),ne=n(null),Ge=n("progressive"),i=n(null),be=n(),b=n(null),{attach:Ee,scrollToBottom:Ie,forceScrollToBottom:Me,reset:Ae,isAutoScrollActive:Ue,isUserScrolling:Fe}=Oe({userScrollTimeout:2e3,scrollBehavior:"smooth",bottomThreshold:100}),xe=()=>{const t=document.querySelector("[data-editor-scroll-container]");if(t){const o=t.querySelector("[data-radix-scroll-area-viewport]");if(o)return console.log("ðŸ“œ Found Radix viewport inside marked container"),o;if(t.classList.contains("overflow-y-auto")||getComputedStyle(t).overflowY==="auto"||getComputedStyle(t).overflowY==="scroll")return console.log("ðŸ“œ Using marked container directly (has overflow)"),t}const e=document.querySelector("main");if(e){const o=e.querySelector("[data-radix-scroll-area-viewport]");if(o)return console.log("ðŸ“œ Found Radix viewport in main"),o}if(ee.value){const o=be.value;if(o){const g=o.$el||o,$=g?.querySelector("[data-radix-scroll-area-viewport]")||g?.querySelector("[data-viewport]")||g?.querySelector('[role="region"]');if($)return console.log("ðŸ“œ Found viewport in fullscreen ref"),$}const u=document.querySelector("[data-editor-scroll-container].overflow-y-auto");if(u)return console.log("ðŸ“œ Found fullscreen scroll container"),u}const p=[".custom-scrollbar.overflow-y-auto","main .overflow-y-auto"];for(const o of p){const u=document.querySelector(o);if(u&&u.scrollHeight>u.clientHeight)return console.log("ðŸ“œ Found container via selector:",o),u}if(e){const o=e.querySelectorAll("div");for(const u of o)if(u.scrollHeight>u.clientHeight&&u.classList.contains("overflow-y-auto"))return console.log("ðŸ“œ Found fallback scrollable div"),u}return null},ke=()=>{Re(()=>{b.value=xe(),b.value?(Ee(b.value),console.log("ðŸ“œ Auto-scroll initialized on container:",b.value.className||b.value.tagName)):console.warn("ðŸ“œ No scroll container found for auto-scroll")})},ue=()=>{!d.value&&!R.value||Re(()=>{(!b.value||!b.value.isConnected)&&(b.value=xe()),requestAnimationFrame(()=>{b.value&&b.value.isConnected&&(b.value.scrollTop=b.value.scrollHeight)})})},$e=async()=>{if(!navigator.onLine)return v.error("No Internet Connection",{description:"Please check your internet connection and try again."}),!1;const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(t){const e=t.effectiveType;(e==="slow-2g"||e==="2g")&&v.warning("Slow Connection Detected",{description:"Your connection is slow. Content will be auto-saved during generation.",duration:4e3})}try{const e=new AbortController,p=setTimeout(()=>e.abort(),5e3),o=performance.now();await fetch(N("api.ping"),{method:"HEAD",cache:"no-cache",signal:e.signal}),clearTimeout(p);const u=performance.now()-o;console.log("ðŸ“¡ Server latency:",u.toFixed(0),"ms"),u>2e3&&v.info("Connection is slow",{description:"Content will be auto-saved during generation to prevent data loss.",duration:3e3})}catch(e){console.warn("Connection check ping failed:",e),v.info("Connection check skipped",{description:"Content will be auto-saved during generation.",duration:2e3})}return!0},fe=t=>{const e=r.value;e&&(a.value.length>0&&a.value[a.value.length-1].content===e||(a.value.push({content:e,action:t,timestamp:Date.now()}),a.value.length>G&&a.value.shift(),I.value=a.value.length>0))},Le=()=>{if(a.value.length===0)return v.error("Nothing to undo"),!1;const t=a.value.pop();return t?(D.value=r.value,r.value=t.content,I.value=a.value.length>0,v.success("Undone",{description:`Reverted "${t.action}" action`,action:{label:"Redo",onClick:()=>{D.value&&(fe("Redo"),r.value=D.value,D.value=null)}}}),!0):!1},je=()=>{a.value=[],I.value=!1,D.value=null},qe=async()=>new Promise(t=>{let e=0;const p=120,o=async()=>{try{const g=await(await fetch(N("api.projects.paper-collection.status",{project:s.project.slug}))).json();if(g.success&&g.data){Te.value=g.data;const $=g.data.status,E=g.data.papers_count||g.data.count||0,m=g.data.message,Z=g.data.percentage||0,P=g.data.current_source,U=g.data.sources_completed||[],le=g.data.papers_preview||[];if(me.value=E,we.value=Z,Se.value=P,ye.value=U,Ce.value=le,$==="completed"){Q.value="Complete",Y.value=`âœ“ Collected ${E} verified sources from ${U.length} databases`,c.value=50,j.value=!1,M.value&&clearInterval(M.value),t(!0);return}else if(["collecting_papers","initializing","processing","storing"].includes($)){let de="";P&&(de={semantic_scholar:"Semantic Scholar",openalex:"OpenAlex",arxiv:"arXiv",crossref:"CrossRef",pubmed:"PubMed"}[P]||P),Q.value=de||"Collecting Sources",Y.value=m||"Collecting sources from academic databases...",c.value=Math.min(5+Z*.4,45)}else if($==="collection_failed"){Q.value="Error",Y.value=m||"âŒ Source collection failed",j.value=!1,M.value&&clearInterval(M.value),t(!1);return}}e++,e>=p&&(Q.value="Timeout",Y.value="â±ï¸ Source collection timed out",j.value=!1,M.value&&clearInterval(M.value),t(!1))}catch(u){console.error("Error checking paper collection status:",u),e++}};o(),M.value=setInterval(o,5e3)}),_e=async()=>{j.value=!0,Q.value="Starting",Y.value="Initializing source collection...",c.value=5;try{const t=document.querySelector('meta[name="csrf-token"]')?.content;if(!t)throw new Error("CSRF token not found - please refresh the page");const e=await fetch(N("api.projects.paper-collection.start",{project:s.project.slug}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!e.ok){const p=await e.text();if(console.error("API Error:",e.status,p),e.status===409)try{const o=JSON.parse(p);throw new Error(o.message||"Source collection is already in progress")}catch{throw new Error("Source collection is already in progress for this project")}throw new Error(`Failed to start source collection: ${e.status}`)}return await qe()}catch(t){return console.error("Paper collection failed:",t),Q.value="Error",Y.value="âŒ Source collection failed",j.value=!1,!1}},ve=async t=>{const e=t==="improve"?300:C.chapter(y.value||0);if(!A(e,t==="improve"?"improve this chapter":"generate this chapter with AI")||!await $e())return;if(d.value=!0,S.value="",f.value=0,c.value=5,h.value="Papers",l.value="Checking for verified sources...",R.value=!0,Ae(),_.value=y.value||0,X.value=!0,!await _e()){v.error("Paper Collection Failed",{description:"Unable to collect verified papers. Please try again."}),d.value=!1,X.value=!1;return}h.value="Initializing",l.value="Starting AI generation with verified sources...",c.value=51;const g=setInterval(()=>{c.value<52&&d.value?c.value+=.2:clearInterval(g)},100),$=N("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number});i.value=new EventSource(`${$}?generation_type=${t}`),i.value.onmessage=E=>{const m=JSON.parse(E.data);switch(m.type){case"start":h.value="Connecting",c.value=52,l.value="Connecting to AI service...",ke();break;case"content":h.value="Generating",S.value+=m.content,f.value=m.word_count||S.value.split(/\s+/).filter(U=>U.length>0).length;const Z=Date.now();if(Z-L.value>200){r.value=S.value,L.value=Z;const U=Math.min(f.value/Math.max(_.value,1)*43,43);c.value=Math.max(52,52+U),l.value=`Generating chapter content... (${f.value} / ${_.value} words)`,ue()}break;case"heartbeat":c.value<95&&(c.value+=.5);break;case"complete":h.value="Complete",c.value=100,d.value=!1,R.value=!1,b.value=null,r.value=S.value;const P=m.final_word_count||f.value;l.value=`âœ“ Generated ${P} words successfully`,w(),he(P,`Chapter generation (${s.chapter.chapter_number})`,"chapter",s.chapter.id).catch(U=>console.error("Failed to record word usage (chapter generation):",U)),setTimeout(()=>{q()},500),i.value?.close(),i.value=null;break;case"error":h.value="Error",c.value=50,R.value=!1,b.value=null,m.partial_saved&&(J.value=!0,re.value=m.saved_word_count||0),m.code==="OFFLINE_MODE"?(l.value="ðŸ“¡ AI services offline",d.value=!1,v.error("AI Services Offline",{description:"Please check your internet connection and try again."})):m.can_resume?(l.value=`âš ï¸ Generation interrupted (${m.saved_word_count} words saved)`,d.value=!1,H.value=!0,v.warning("Generation Interrupted",{description:`${m.saved_word_count} words were saved. You can resume generation.`,duration:8e3})):(l.value="âŒ Generation failed",d.value=!1,v.error("Generation Error",{description:m.message||"Please try again."})),i.value?.close(),i.value=null;break;case"autosave":m.word_count&&m.generation_id&&(ne.value=m.generation_id);break}},i.value.onerror=()=>{if(k.value<ce){k.value++,O.value=!0,h.value="Reconnecting",l.value=`ðŸ”„ Connection lost. Reconnecting... (${k.value}/${ce})`,i.value?.close(),i.value=null;const E=oe.value*Math.pow(2,k.value-1);setTimeout(()=>ge(t),E)}else h.value="Error",c.value=50,d.value=!1,O.value=!1,l.value="âŒ Connection failed after multiple attempts",f.value>100?(J.value=!0,re.value=f.value,H.value=!0,v.warning("Connection Lost",{description:`${f.value} words may have been saved. Check and resume if needed.`,duration:8e3})):v.error("Connection Error",{description:"Please check your internet connection and try again."}),i.value?.close(),i.value=null,k.value=0,oe.value=2e3}},ge=t=>{i.value&&(i.value.close(),i.value=null);const e=N("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number}),p=new URLSearchParams({generation_type:t,resume_from:f.value.toString()});ne.value&&p.set("generation_id",ne.value),i.value=new EventSource(`${e}?${p}`),i.value.onmessage=o=>{const u=JSON.parse(o.data);switch(["content","start"].includes(u.type)&&(O.value=!1,k.value=0,h.value="Generating"),u.type){case"start":l.value="âœ… Reconnected! Continuing generation...",ke(),v.success("Reconnected",{description:"Generation resumed successfully.",duration:3e3});break;case"content":h.value="Generating",S.value+=u.content,f.value=u.word_count||S.value.split(/\s+/).filter(E=>E.length>0).length;const g=Date.now();if(g-L.value>150){r.value=S.value,L.value=g;const E=Math.min(f.value/Math.max(_.value,1)*43,43);c.value=Math.max(52,52+E),l.value=`Generating chapter content... (${f.value} / ${_.value} words)`,ue()}break;case"complete":h.value="Complete",c.value=100,d.value=!1,O.value=!1,b.value=null,r.value=S.value;const $=u.final_word_count||f.value;l.value=`âœ“ Generated ${$} words successfully`,he($,`Chapter generation (${s.chapter.chapter_number})`,"chapter",s.chapter.id).catch(E=>console.error("Failed to record word usage:",E)),setTimeout(()=>{q()},500),i.value?.close(),i.value=null;break;case"error":h.value="Error",d.value=!1,O.value=!1,b.value=null,l.value="âŒ Generation failed",v.error("Generation Error",{description:u.message||"Please try again."}),i.value?.close(),i.value=null;break;case"autosave":u.generation_id&&(ne.value=u.generation_id);break}},i.value.onerror=()=>{if(k.value<ce){k.value++;const o=oe.value*Math.pow(2,k.value-1);l.value=`ðŸ”„ Reconnecting... (${k.value}/${ce})`,i.value?.close(),setTimeout(()=>ge(t),o)}else h.value="Error",d.value=!1,O.value=!1,l.value="âŒ Connection failed",f.value>100?(H.value=!0,v.warning("Connection Lost",{description:`${f.value} words may be saved. Refresh to recover.`})):v.error("Connection Error",{description:"Please check your connection and try again."}),i.value?.close(),i.value=null,k.value=0}},Pe=async t=>{d.value=!0,S.value="",f.value=0,c.value=5,h.value="Papers",l.value="Checking for verified sources...",_.value=600,te.value=r.value||s.chapter.content||"",X.value=!0;try{c.value=50,h.value="Papers",l.value="Using existing verified sources...",await new Promise(p=>setTimeout(p,500)),h.value="Section",l.value=`Generating ${t} section with verified sources...`,c.value=51;const e=N("chapters.stream",{project:s.project.slug,chapter:s.chapter.chapter_number});i.value=new EventSource(`${e}?generation_type=section&section_type=${t}`),i.value.onmessage=p=>{const o=JSON.parse(p.data);switch(o.type){case"start":h.value="Generating Section",c.value=52,l.value=`Starting ${t} section generation...`;break;case"content":S.value+=o.content,f.value=o.word_count||F(S.value);const u=Date.now();if(u-L.value>150){r.value=te.value+`

`+S.value,L.value=u;const g=Math.min(f.value/_.value*43,43);c.value=Math.max(52,52+g),l.value=`Generating ${t} section... (${f.value} / ${_.value} words)`,w(),ue()}break;case"complete":c.value=100,h.value="Complete",l.value=`âœ“ Generated ${t} section (${f.value} words)`,r.value=te.value+`

`+S.value,T(!0),v.success("âœ… Section Generated Successfully",{description:`Added ${t} section with ${f.value} words and verified citations.`,duration:5e3}),d.value=!1,i.value?.close();break;case"error":throw new Error(o.message||"Section generation failed");case"heartbeat":c.value<95&&(c.value+=.5);break}},i.value.onerror=()=>{d.value=!1,h.value="Error",l.value="âŒ Section generation failed",v.error("âŒ Generation Failed",{description:"Unable to generate section. Please check your connection and try again."}),i.value?.close()}}catch(e){console.error("Section generation failed:",e),d.value=!1,h.value="Error",l.value="âŒ Section generation error",v.error("âŒ Generation Failed",{description:"Section generation encountered an error."})}},pe=async(t,e,p)=>{const o=t.split(/\s+/).length;if(!A(300,`${e} selected text`))return;d.value=!0,S.value="",f.value=0,c.value=10,h.value=e==="rephrase"?"Rephrasing":"Expanding",l.value=`${e==="rephrase"?"Rephrasing":"Expanding"} selected text...`,_.value=Math.max(o*(e==="expand"?2:1),100);const g=K.value||W.value,$=g?.getSelectionRange(),E={originalText:t,range:$,wordCount:o,style:p||"Academic Formal",startTime:Date.now()};X.value=!0;try{const m=document.querySelector('meta[name="csrf-token"]')?.content;if(!m)throw new Error("CSRF token not found - please refresh the page");const Z=e==="rephrase"?N("chapters.quick-actions.rephrase",{project:s.project.slug,chapter:s.chapter.chapter_number}):N("chapters.quick-actions.expand",{project:s.project.slug,chapter:s.chapter.chapter_number});c.value=35;const P=await fetch(Z,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":m,"X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify({text:t,...e==="rephrase"?{style:E.style}:{}})});if(!P.ok){let V=`Request failed (${P.status})`;try{const se=await P.json();V=se?.message||se?.error||se?.data?.message||V}catch{}throw new Error(V)}const U=await P.json(),le=String(U?.text||"").trim();if(!le)throw new Error("Empty response from AI service");c.value=100,h.value="Complete",l.value=`âœ“ Text ${e==="rephrase"?"rephrased":"expanded"} successfully`,E.range&&(g?.replaceSelection(le,E.range)?setTimeout(()=>{const se=g?.getHTML()||r.value;r.value=se},50):v.warning("Please manually replace the selected text",{description:"The generated text is ready but could not be automatically inserted."})),T(!0),v.success(`âœ… Text ${e==="rephrase"?"Rephrased":"Expanded"} Successfully`,{description:`${e==="rephrase"?"Rephrased":"Expanded"} selection (${o} words).`});const de=Number(U?.word_count)||F(le)||(e==="expand"?o*2:o);he(de,e==="rephrase"?`Rephrase (${E.style})`:"Expand text","chapter",s.chapter.id).catch(V=>console.error(`Failed to record word usage (${e}):`,V)),d.value=!1}catch(m){console.error("Selection generation failed:",m),d.value=!1,h.value="Error",l.value=`âŒ Text ${e==="rephrase"?"rephrasing":"expansion"} error`,v.error(`âŒ ${e==="rephrase"?"Rephrasing":"Expansion"} Failed`,{description:m instanceof Error?m.message:"Text generation encountered an error."})}};return{isGenerating:d,generationProgress:l,generationPercentage:c,generationPhase:h,estimatedTotalWords:_,streamWordCount:f,streamBuffer:S,lastStreamUpdate:L,originalContentForAppend:te,aiSuggestions:ae,isLoadingSuggestions:z,showCitationHelper:ie,showPresentationMode:X,isStreamingMode:R,showRecoveryDialog:H,partialContentSaved:J,savedWordCountOnError:re,isCollectingPapers:j,paperCollectionProgress:Y,paperCollectionPhase:Q,collectedPapersCount:me,paperCollectionPercentage:we,currentSource:Se,sourcesCompleted:ye,papersPreview:Ce,paperCollectionData:Te,paperCollectionInterval:M,reconnectAttempts:k,reconnectDelay:oe,isReconnecting:O,currentGenerationId:ne,currentGenerationType:Ge,eventSource:i,editorScrollRef:be,attachScroller:Ee,smoothScrollToBottom:Ie,forceScrollToBottom:Me,resetScroller:Ae,isAutoScrollActive:Ue,isUserScrollingScroller:Fe,scrollToBottom:ue,checkConnectionQuality:$e,startPaperCollection:_e,startStreamingGeneration:ve,attemptReconnection:ge,startSectionGeneration:Pe,handleSelectionGeneration:pe,handleAIGeneration:(t,e)=>{t==="section"&&e?.section?Pe(e.section):t==="rephrase"&&e?.selectedText?pe(e.selectedText,"rephrase",e.style):t==="expand"&&e?.selectedText?pe(e.selectedText,"expand"):ve(t)},handleRegenerateChapter:async(t=!1)=>{if(!t)return!1;const e=C.chapter(y.value||0);return A(e,"regenerate this chapter")?(r.value&&r.value.trim().length>0&&(fe("Before regenerate"),v.info("Previous content saved",{description:"You can undo to restore it if needed.",duration:3e3})),r.value="",await ve("progressive"),!0):!1},getAISuggestions:async()=>{if(!B.value)return;const t=C.suggestion();if(A(t,"get AI suggestions")){z.value=!0;try{const p=await(await fetch(N("chapters.suggestions",{project:s.project.slug,chapter:s.chapter.chapter_number}),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({selected_text:B.value,context:r.value})})).json();ae.value=p.suggestions||[],ae.value.length&&he(C.suggestion(),"AI suggestions","chapter",s.chapter.id).catch(o=>console.error("Failed to record word usage (suggestions):",o))}catch{v.error("Error getting suggestions",{description:"Please try again."})}finally{z.value=!1}}},checkCitations:()=>{ie.value=!0,v.success("Citation Manager opened!",{description:"Review and verify your citations in the panel below."})},insertCitation:t=>{try{const e=K.value?.editor||W.value?.editor;if(!e){v.error("Editor not found");return}const{from:p}=e.state.selection;e.chain().focus().insertContentAt(p,` ${t} `).run(),v.success("Citation inserted successfully")}catch(e){console.error("Failed to insert citation:",e),v.error("Failed to insert citation")}},resumeGeneration:()=>{H.value=!1,J.value=!1,window.location.reload()},dismissRecovery:()=>{H.value=!1,J.value=!1,re.value=0},checkForAutoGeneration:()=>{const t=new URLSearchParams(window.location.search),e=t.get("ai_generate")==="true",p=t.get("generation_type");!e||!p||setTimeout(()=>{ve("progressive");const o=new URL(window.location.href);o.searchParams.delete("ai_generate"),o.searchParams.delete("generation_type"),window.history.replaceState({},"",o.toString()),v.success("ðŸš€ AI Generation Started",{description:`Generating ${s.chapter.title} with AI assistance...`})},1e3)},stopGeneration:()=>{!d.value&&!j.value||(i.value&&(i.value.close(),i.value=null),M.value&&(clearInterval(M.value),M.value=null),S.value&&f.value>0?(r.value=S.value,v.info("Generation Stopped",{description:`${f.value} words have been saved. You can continue editing or regenerate.`,duration:5e3})):v.info("Generation Stopped",{description:"Generation was cancelled.",duration:3e3}),d.value=!1,R.value=!1,j.value=!1,O.value=!1,k.value=0,oe.value=2e3,h.value="Stopped",l.value="Generation stopped by user",b.value=null,f.value>0&&setTimeout(()=>{q()},500))},contentHistory:a,canUndo:I,pushToHistory:fe,undoLastAction:Le,clearHistory:je}}function ot(s){const{delay:r=1e4,onSave:y}=s,C=n(!1),A=n(!1),T=n(null),q=()=>{C.value=!0,T.value&&clearTimeout(T.value),T.value=setTimeout(()=>{w(!0)},r)},w=async(B=!1)=>{if(!A.value){A.value=!0;try{await y(B),C.value=!1,T.value&&(clearTimeout(T.value),T.value=null)}finally{A.value=!1}}};return{hasUnsavedChanges:C,isSaving:A,triggerAutoSave:q,save:w,clearAutoSave:()=>{T.value&&(clearTimeout(T.value),T.value=null)}}}function nt(s,r=n(3e3),y=.8){const C=a=>{if(!a)return 0;const I=a.replace(/<[^>]*>/g,"").trim().replace(/\s+/g," ");if(!I)return 0;const D=I.match(/\b\w+\b/g);return D?D.length:0},A=a=>a?a.replace(/<[^>]*>/g,"").replace(/\r\n|\r/g,`
`).trim().split(/\n\s*\n/).filter(j=>j.trim().length>0).length:0,T=a=>{if(!a)return 0;const I=a.replace(/<[^>]*>/g,"").match(/[.!?]+/g);return I?I.length:0},q=a=>Math.round(a/200*10)/10,w=x(()=>C(s.value)),F=x(()=>s.value.length),B=x(()=>s.value.replace(/\s/g,"").length),W=x(()=>A(s.value)),K=x(()=>T(s.value)),ee=x(()=>q(w.value)),d=x(()=>{const a=r.value;return!a||a<=0?0:Math.min(w.value/a*100,100)}),l=x(()=>w.value>=r.value*y),c=x(()=>{const a=r.value-w.value;return Math.max(a,0)}),h=x(()=>{const a=r.value*y-w.value;return Math.max(a,0)}),_=x(()=>({wordCount:w.value,characterCount:F.value,characterCountNoSpaces:B.value,paragraphCount:W.value,sentenceCount:K.value,readingTimeMinutes:ee.value})),f=x(()=>({current:w.value,target:r.value,percentage:d.value,isComplete:l.value,completionThreshold:y})),S=a=>a>=1e3?`${Math.round(a/100)/10}k`:a.toString(),L=(a=0)=>`${Math.round(d.value*Math.pow(10,a))/Math.pow(10,a)}%`,te=()=>`${w.value} / ${r.value} words (${L()}%)`,ae=()=>{if(l.value)return`âœ… Complete (${S(w.value)} words)`;const a=h.value;return`${S(a)} more words to complete`},z=()=>{const a=w.value,G=r.value;return a===0?"empty":a<G*.25?"started":a<G*.75?"progressing":a<G*y?"near_complete":a<G?"complete":"exceeded"},ie=()=>{const a=z();return{empty:"text-gray-500",started:"text-blue-500",progressing:"text-yellow-500",near_complete:"text-orange-500",complete:"text-green-500",exceeded:"text-emerald-600"}[a]},X=()=>{const a=z();return{empty:"bg-gray-200",started:"bg-blue-200",progressing:"bg-yellow-200",near_complete:"bg-orange-200",complete:"bg-green-200",exceeded:"bg-emerald-200"}[a]},R=800,H=x(()=>w.value>=R),J=x(()=>Math.max(R-w.value,0)),re=x(()=>Math.min(w.value/R*100,100));return{currentWordCount:w,characterCount:F,characterCountNoSpaces:B,paragraphCount:W,sentenceCount:K,readingTimeMinutes:ee,progressPercentage:d,isComplete:l,wordsRemaining:c,wordsToComplete:h,wordCountStats:_,wordCountProgress:f,meetsDefenseThreshold:H,defenseWordsRemaining:J,defenseProgressPercentage:re,DEFENSE_THRESHOLD:R,formatWordCount:S,formatProgress:L,getProgressDisplay:te,getCompletionDisplay:ae,getWordCountStatus:z,getStatusColor:ie,getProgressBarColor:X,countWords:C}}export{ot as a,at as b,nt as u};
