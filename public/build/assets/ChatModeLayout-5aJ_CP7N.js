import{d as ce,I as oe,D as Xe,c as f,o as n,a as T,b as a,e as t,u as e,w as l,cE as Ge,cF as qe,cG as Ye,b_ as Ue,r as b,p as O,L as ye,n as N,g as D,bE as Ze,bW as Je,t as y,ab as Me,h as g,aP as et,F as fe,f as ve,aA as tt,bo as st,bh as pe,ay as He,S as me,aa as be,by as Be,ap as je,i as Ve,j as Qe,P as at,y as De,cc as We,cH as re,cI as ot,a0 as lt,aI as ae,aK as ze,aD as Fe,cx as nt,bS as rt,b6 as ie,bL as it,a2 as dt,aL as ut,bD as ct,aW as pt,at as mt,az as ft,bc as vt,s as gt,c8 as ht,bX as Pe,aE as xt,bk as Oe,a8 as yt,a9 as bt,aZ as wt,bZ as _t,z as kt,X as Ee,b9 as Ct,Z as Ie,bi as $t}from"./vendor-Bd-YbXdQ.js";import{_ as de}from"./index-CPLcYuC3.js";import{_ as v}from"./index-DhgXNBxs.js";import{a as St,_ as Tt}from"./CardContent.vue_vue_type_script_setup_true_lang-BpnkKGTV.js";import{_ as Ke}from"./Progress.vue_vue_type_script_setup_true_lang-D4c9IteC.js";import{_ as we}from"./ScrollArea.vue_vue_type_script_setup_true_lang-lhCXI5ih.js";import{ak as Mt,al as zt,av as jt}from"./index-C3PXxNyG.js";import{i as Dt,R as Ft}from"./RichTextEditor-BCMX_Km-.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{R as ge}from"./RichTextViewer-Cr7IaEGL.js";import{_ as Ae,a as Ne}from"./index-BGtFkfLN.js";import{s as ue}from"./useAppearance-Y8PyvRNY.js";import{_ as Pt}from"./Input.vue_vue_type_script_setup_true_lang-Bhu57pIq.js";import{_ as _e,a as ke}from"./DialogContent.vue_vue_type_script_setup_true_lang-B0_mTwB9.js";import{_ as Ce}from"./DialogDescription.vue_vue_type_script_setup_true_lang-o698b8xn.js";import{_ as $e}from"./DialogFooter.vue_vue_type_script_setup_true_lang-CWpuYIJK.js";import{_ as Se,a as Te}from"./DialogTitle.vue_vue_type_script_setup_true_lang-DzEVjang.js";import"./index-CPshGmzU.js";import"./Presence-TRPLJXzT.js";import"./useForwardExpose-BQPhk1XK.js";import"./nullish-CHIgUVhi.js";import"./useNonce-BrCVioIE.js";import"./purify.es-DxJI3Wx7.js";import"./step-CXjX0ghh.js";import"./Label.vue_vue_type_script_setup_true_lang-BtVR4Xej.js";import"./Sonner.vue_vue_type_script_setup_true_lang-aZGMRizj.js";import"./DialogTitle-RQf4465M.js";import"./VisuallyHidden-BP1uy0Yl.js";const Et={class:"w-full border rounded-md bg-background"},It={key:0,class:"flex items-center gap-1 p-1 border-b bg-muted/20"},At={class:"relative"},Nt=ce({__name:"CompactRichTextEditor",props:{modelValue:{},placeholder:{default:"Type your message..."},disabled:{type:Boolean,default:!1},showToolbar:{type:Boolean,default:!0}},emits:["update:modelValue","submit","keydown"],setup(Q,{expose:W,emit:w}){const _=Q,u=w,p=Mt({content:_.modelValue,editable:!_.disabled,extensions:[zt.configure({heading:!1,bulletList:!1,orderedList:!1,blockquote:!1,horizontalRule:!1,codeBlock:!1}),Dt.configure({placeholder:_.placeholder})],editorProps:{attributes:{class:"prose prose-sm dark:prose-invert max-w-none focus:outline-none min-h-[2rem] max-h-32 overflow-y-auto",style:"padding: 8px; line-height: 1.5;"},handleKeyDown:(S,j)=>(u("keydown",j),j.key==="Enter"&&!j.shiftKey?(j.preventDefault(),u("submit"),!0):!1)},onUpdate:({editor:S})=>{u("update:modelValue",S.getHTML())}});oe(()=>_.modelValue,S=>{p.value&&p.value.getHTML()!==S&&p.value.commands.setContent(S,!1)}),oe(()=>_.disabled,S=>{p.value&&p.value.setEditable(!S)}),Xe(()=>{p.value&&p.value.destroy()});const h=()=>p.value?.chain().focus().toggleBold().run(),x=()=>p.value?.chain().focus().toggleItalic().run(),k=()=>p.value?.chain().focus().toggleCode().run(),M=S=>p.value?.isActive(S)??!1,C=()=>{p.value?.commands.focus()},P=()=>p.value?.getText()??"";return W({focus:C,clear:()=>{p.value?.commands.clearContent()},getTextContent:P,editor:p}),(S,j)=>(n(),f("div",Et,[S.showToolbar?(n(),f("div",It,[t(e(v),{onClick:h,variant:M("bold")?"default":"ghost",size:"sm",class:"h-6 w-6 p-0"},{default:l(()=>[t(e(Ge),{class:"w-3 h-3"})]),_:1},8,["variant"]),t(e(v),{onClick:x,variant:M("italic")?"default":"ghost",size:"sm",class:"h-6 w-6 p-0"},{default:l(()=>[t(e(qe),{class:"w-3 h-3"})]),_:1},8,["variant"]),t(e(v),{onClick:k,variant:M("code")?"default":"ghost",size:"sm",class:"h-6 w-6 p-0"},{default:l(()=>[t(e(Ye),{class:"w-3 h-3"})]),_:1},8,["variant"]),j[1]||(j[1]=a("div",{class:"flex-1"},null,-1)),t(e(v),{onClick:j[0]||(j[0]=U=>u("submit")),disabled:S.disabled||!P().trim(),size:"sm",class:"h-6 px-2"},{default:l(()=>[t(e(Ue),{class:"w-3 h-3"})]),_:1},8,["disabled"])])):T("",!0),a("div",At,[t(e(jt),{editor:e(p),class:"compact-prose-editor"},null,8,["editor"])])]))}}),Rt=he(Nt,[["__scopeId","data-v-06ee7de1"]]),Lt={class:"space-y-4"},Ut=["accept","disabled"],Ht={class:"flex flex-col items-center gap-3"},Bt={class:"space-y-1"},Vt={class:"text-sm font-medium"},Qt={class:"text-xs text-muted-foreground"},Wt={key:0,class:"w-full max-w-xs"},Ot={class:"text-xs text-muted-foreground mt-1"},Kt={key:0,class:"space-y-2"},Xt={key:1,class:"space-y-2"},Gt={key:2,class:"space-y-3"},qt={class:"space-y-2"},Yt={class:"flex-1 min-w-0 space-y-2"},Zt={class:"flex items-start justify-between gap-2"},Jt={class:"min-w-0 flex-1"},es={class:"text-sm font-medium truncate"},ts={class:"text-xs text-muted-foreground"},ss={class:"flex flex-wrap gap-1"},as={key:0,class:"text-xs text-muted-foreground"},os=ce({__name:"FileUpload",props:{projectSlug:{},chapterNumber:{},sessionId:{},disabled:{type:Boolean}},emits:["file-uploaded","file-deleted","files-loaded"],setup(Q,{emit:W}){const w=Q,_=W,u=b(),p=b(!1),h=b(0),x=b(""),k=b(""),M=b(!1),C=b([]),P=O(()=>C.value.length>0),E=O(()=>".pdf,.doc,.docx,.txt,.rtf,.md"),S=O(()=>"10 MB"),j=()=>{!w.disabled&&!p.value&&u.value?.click()},U=r=>{const s=r.target;s.files&&s.files.length>0&&V(s.files[0])},R=r=>{if(r.preventDefault(),M.value=!1,w.disabled||p.value)return;const s=r.dataTransfer?.files;s&&s.length>0&&V(s[0])},B=r=>{r.preventDefault(),!w.disabled&&!p.value&&(M.value=!0)},F=()=>{M.value=!1},V=async r=>{if(!w.disabled){if(x.value="",k.value="",p.value=!0,h.value=0,!I(r)){p.value=!1;return}try{const s=new FormData;s.append("file",r),s.append("session_id",w.sessionId);const i=await pe.post(ue("chapters.chat-upload",{project:w.projectSlug,chapter:w.chapterNumber}),s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:z=>{z.total&&(h.value=Math.round(z.loaded*100/z.total))}});i.data.success?(k.value=i.data.message,C.value.unshift(i.data.upload),_("file-uploaded",i.data.upload),u.value&&(u.value.value=""),setTimeout(()=>{k.value=""},3e3)):x.value=i.data.error||"Upload failed"}catch(s){console.error("Upload error:",s),x.value=s.response?.data?.error||"Failed to upload file. Please try again."}finally{p.value=!1,h.value=0}}},I=r=>{if(r.size>10485760)return x.value=`File size exceeds ${S.value} limit`,!1;const i=["pdf","doc","docx","txt","rtf","md"],z=r.name.split(".").pop()?.toLowerCase();return!z||!i.includes(z)?(x.value="Please upload PDF, DOC, DOCX, TXT, RTF, or MD files only",!1):!0},K=async r=>{try{(await pe.delete(ue("chapters.chat-file-delete",{project:w.projectSlug,chapter:w.chapterNumber,uploadId:r}))).data.success&&(C.value=C.value.filter(i=>i.id!==r),_("file-deleted",r))}catch(s){console.error("Delete error:",s),x.value="Failed to delete file"}},X=async()=>{try{const r=await pe.get(ue("chapters.chat-files",{project:w.projectSlug,chapter:w.chapterNumber}),{params:{session_id:w.sessionId}});r.data.success&&(C.value=r.data.files,_("files-loaded",r.data.files))}catch(r){console.error("Failed to load existing files:",r)}},G=r=>(r.split(".").pop()?.toLowerCase(),He),q=r=>r.slice(0,3).join(", ")+(r.length>3?"...":"");return ye(()=>{X()}),(r,s)=>(n(),f("div",Lt,[a("div",{class:N(["border-2 border-dashed rounded-lg p-6 text-center transition-all",M.value?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-muted-foreground/50",r.disabled||p.value?"opacity-50 cursor-not-allowed":"cursor-pointer"]),onClick:j,onDragover:B,onDragleave:F,onDrop:R},[a("input",{ref_key:"fileInput",ref:u,type:"file",accept:E.value,class:"hidden",onChange:U,disabled:r.disabled||p.value},null,40,Ut),a("div",Ht,[a("div",{class:N(["flex h-12 w-12 items-center justify-center rounded-full",p.value?"bg-primary/10":"bg-muted"])},[p.value?(n(),D(e(Ze),{key:0,class:"h-6 w-6 animate-spin text-primary"})):(n(),D(e(Je),{key:1,class:"h-6 w-6 text-muted-foreground"}))],2),a("div",Bt,[a("p",Vt,y(p.value?"Uploading and analyzing...":"Drop files here or click to browse"),1),a("p",Qt," PDF, DOC, DOCX, TXT, RTF, MD up to "+y(S.value),1)]),p.value?(n(),f("div",Wt,[t(e(Ke),{value:h.value,class:"h-2"},null,8,["value"]),a("p",Ot,y(h.value)+"%",1)])):T("",!0)])],34),x.value?(n(),f("div",Kt,[t(e(Ae),{variant:"destructive"},{default:l(()=>[t(e(Me),{class:"h-4 w-4"}),t(e(Ne),null,{default:l(()=>[g(y(x.value),1)]),_:1})]),_:1})])):T("",!0),k.value?(n(),f("div",Xt,[t(e(Ae),null,{default:l(()=>[t(e(et),{class:"h-4 w-4"}),t(e(Ne),null,{default:l(()=>[g(y(k.value),1)]),_:1})]),_:1})])):T("",!0),P.value?(n(),f("div",Gt,[s[0]||(s[0]=a("h4",{class:"text-sm font-medium text-foreground"},"Uploaded Documents",-1)),a("div",qt,[(n(!0),f(fe,null,ve(C.value,i=>(n(),f("div",{key:i.id,class:"flex items-start gap-3 p-3 bg-muted/30 rounded-lg border"},[(n(),D(tt(G(i.filename)),{class:"h-5 w-5 text-muted-foreground mt-0.5 flex-shrink-0"})),a("div",Yt,[a("div",Zt,[a("div",Jt,[a("p",es,y(i.filename),1),a("p",ts,y(i.size),1)]),t(e(v),{onClick:z=>K(i.id),variant:"ghost",size:"sm",class:"h-6 w-6 p-0 text-muted-foreground hover:text-destructive"},{default:l(()=>[t(e(st),{class:"h-3 w-3"})]),_:2},1032,["onClick"])]),a("div",ss,[t(e(de),{variant:"secondary",class:"text-xs"},{default:l(()=>[g(y(i.word_count)+" words ",1)]),_:2},1024),i.citations_found>0?(n(),D(e(de),{key:0,variant:"secondary",class:"text-xs"},{default:l(()=>[g(y(i.citations_found)+" citations ",1)]),_:2},1024)):T("",!0),i.main_topics.length>0?(n(),D(e(de),{key:1,variant:"outline",class:"text-xs"},{default:l(()=>[g(y(q(i.main_topics)),1)]),_:2},1024)):T("",!0)]),i.uploaded_at?(n(),f("p",as," Uploaded "+y(i.uploaded_at),1)):T("",!0)])]))),128))])])):T("",!0)]))}}),ls=he(os,[["__scopeId","data-v-0e5d2848"]]),ns={key:0,class:"flex h-full flex-col bg-background border-l"},rs={class:"flex-shrink-0 border-b p-3"},is={class:"flex items-center justify-between mb-3"},ds={class:"text-sm font-semibold flex items-center gap-2"},us={class:"space-y-2"},cs={class:"relative"},ps={class:"flex gap-1"},ms={class:"p-3 space-y-3"},fs={key:0,class:"text-center py-8"},vs={key:1,class:"text-center py-8"},gs={class:"text-sm text-destructive"},hs={key:2,class:"text-center py-8"},xs={class:"flex flex-col items-center gap-2"},ys={key:3,class:"space-y-2"},bs={class:"flex items-center justify-between"},ws={class:"text-xs text-muted-foreground"},_s={key:0,class:"text-xs text-muted-foreground"},ks={class:"space-y-2"},Cs=["onClick"],$s={class:"flex items-start justify-between gap-2 mb-2"},Ss={class:"flex items-center gap-1 text-xs text-muted-foreground"},Ts={class:"space-y-2"},Ms=["innerHTML"],zs={key:0,class:"text-xs text-muted-foreground border-l-2 pl-2"},js={key:0,class:"flex items-center justify-center gap-1 pt-2 border-t"},Ds={class:"text-xs text-muted-foreground px-2"},Fs={key:4,class:"text-center py-8"},Ps={class:"flex flex-col items-center gap-2"},Re=10,Es=ce({__name:"ChatSearch",props:{projectSlug:{},chapterNumber:{},show:{type:Boolean}},emits:["close","message-selected"],setup(Q,{emit:W}){const w=Q,_=W,u=b(""),p=b([]),h=b(!1),x=b(""),k=b(1),M=b(0),C=b("all"),P=O(()=>p.value.length>0),E=O(()=>Math.ceil(M.value/Re)),S=O(()=>k.value<E.value),j=O(()=>k.value>1),U=O(()=>!h.value&&u.value.length>0&&!P.value);let R=null;const B=()=>{R&&clearTimeout(R),R=setTimeout(()=>{u.value.trim().length>=2?F():(p.value=[],M.value=0,k.value=1)},300)},F=async(r=1)=>{if(!(!u.value.trim()||h.value)){h.value=!0,x.value="",k.value=r;try{const s=await pe.get(ue("chapters.chat-search",{project:w.projectSlug,chapter:w.chapterNumber}),{params:{q:u.value.trim(),type:C.value==="all"?null:C.value,page:r,per_page:Re}});s.data.success?(p.value=s.data.results,M.value=s.data.total):x.value=s.data.error||"Search failed"}catch(s){console.error("Search error:",s),x.value="Failed to search chat history. Please try again."}finally{h.value=!1}}},V=()=>{u.value="",p.value=[],M.value=0,k.value=1,x.value=""},I=r=>{r>=1&&r<=E.value&&r!==k.value&&F(r)},K=r=>{_("message-selected",r.id,r.session_id),_("close")},X=r=>{const s=new Date(r),z=new Date().getTime()-s.getTime(),Z=Math.floor(z/(1e3*60*60*24));return Z===0?"Today "+s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}):Z===1?"Yesterday "+s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}):Z<7?s.toLocaleDateString("en-US",{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1})},G=r=>{switch(r){case"user":return"You";case"ai":return"AI";case"system":return"System";default:return r}},q=r=>{switch(r){case"user":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";case"ai":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"system":return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"}};return oe(u,B),oe(C,()=>{u.value.trim().length>=2&&(k.value=1,F())}),oe(()=>w.show,r=>{r&&ye(()=>{document.querySelector("[data-search-input]")?.focus()})}),(r,s)=>r.show?(n(),f("div",ns,[a("div",rs,[a("div",is,[a("h3",ds,[t(e(me),{class:"h-4 w-4"}),s[8]||(s[8]=g(" Search Chat History ",-1))]),t(e(v),{onClick:s[0]||(s[0]=i=>_("close")),variant:"ghost",size:"icon",class:"h-6 w-6"},{default:l(()=>[t(e(be),{class:"h-3 w-3"})]),_:1})]),a("div",us,[a("div",cs,[t(e(me),{class:"absolute left-2 top-1/2 h-3 w-3 -translate-y-1/2 text-muted-foreground"}),t(e(Pt),{modelValue:u.value,"onUpdate:modelValue":s[1]||(s[1]=i=>u.value=i),"data-search-input":"",placeholder:"Search messages...",class:"pl-7 pr-8 h-8 text-sm"},null,8,["modelValue"]),u.value?(n(),D(e(v),{key:0,onClick:V,variant:"ghost",size:"icon",class:"absolute right-1 top-1/2 h-6 w-6 -translate-y-1/2"},{default:l(()=>[t(e(be),{class:"h-3 w-3"})]),_:1})):T("",!0)]),a("div",ps,[t(e(v),{onClick:s[2]||(s[2]=i=>C.value="all"),variant:C.value==="all"?"default":"outline",size:"xs",class:"h-6 px-2 text-xs"},{default:l(()=>[...s[9]||(s[9]=[g(" All ",-1)])]),_:1},8,["variant"]),t(e(v),{onClick:s[3]||(s[3]=i=>C.value="user"),variant:C.value==="user"?"default":"outline",size:"xs",class:"h-6 px-2 text-xs"},{default:l(()=>[...s[10]||(s[10]=[g(" Your Messages ",-1)])]),_:1},8,["variant"]),t(e(v),{onClick:s[4]||(s[4]=i=>C.value="ai"),variant:C.value==="ai"?"default":"outline",size:"xs",class:"h-6 px-2 text-xs"},{default:l(()=>[...s[11]||(s[11]=[g(" AI Responses ",-1)])]),_:1},8,["variant"])])])]),t(e(we),{class:"flex-1"},{default:l(()=>[a("div",ms,[h.value?(n(),f("div",fs,[...s[12]||(s[12]=[a("div",{class:"inline-flex items-center gap-2 text-sm text-muted-foreground"},[a("div",{class:"h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"}),g(" Searching... ")],-1)])])):x.value?(n(),f("div",vs,[a("p",gs,y(x.value),1),t(e(v),{onClick:s[5]||(s[5]=i=>F()),variant:"outline",size:"sm",class:"mt-2"},{default:l(()=>[...s[13]||(s[13]=[g(" Try Again ",-1)])]),_:1})])):U.value?(n(),f("div",hs,[a("div",xs,[t(e(Be),{class:"h-8 w-8 text-muted-foreground/50"}),s[14]||(s[14]=a("p",{class:"text-sm text-muted-foreground"},"No messages found",-1)),s[15]||(s[15]=a("p",{class:"text-xs text-muted-foreground"},"Try a different search term",-1))])])):P.value?(n(),f("div",ys,[a("div",bs,[a("p",ws,y(M.value)+" result"+y(M.value!==1?"s":"")+" found ",1),E.value>1?(n(),f("p",_s," Page "+y(k.value)+" of "+y(E.value),1)):T("",!0)]),a("div",ks,[(n(!0),f(fe,null,ve(p.value,i=>(n(),f("div",{key:i.id,onClick:z=>K(i),class:"cursor-pointer rounded-lg border p-3 hover:bg-muted/50 transition-colors"},[a("div",$s,[t(e(de),{class:N([q(i.message_type),"text-xs"])},{default:l(()=>[g(y(G(i.message_type)),1)]),_:2},1032,["class"]),a("div",Ss,[t(e(je),{class:"h-3 w-3"}),g(" "+y(X(i.timestamp)),1)])]),a("div",Ts,[a("p",{class:"text-sm leading-relaxed",innerHTML:i.highlight},null,8,Ms),i.context?(n(),f("p",zs,y(i.context),1)):T("",!0)])],8,Cs))),128))]),E.value>1?(n(),f("div",js,[t(e(v),{onClick:s[6]||(s[6]=i=>I(k.value-1)),disabled:!j.value,variant:"outline",size:"icon",class:"h-6 w-6"},{default:l(()=>[t(e(Ve),{class:"h-3 w-3"})]),_:1},8,["disabled"]),a("span",Ds,y(k.value)+" / "+y(E.value),1),t(e(v),{onClick:s[7]||(s[7]=i=>I(k.value+1)),disabled:!S.value,variant:"outline",size:"icon",class:"h-6 w-6"},{default:l(()=>[t(e(Qe),{class:"h-3 w-3"})]),_:1},8,["disabled"])])):T("",!0)])):u.value?T("",!0):(n(),f("div",Fs,[a("div",Ps,[t(e(me),{class:"h-8 w-8 text-muted-foreground/50"}),s[16]||(s[16]=a("p",{class:"text-sm text-muted-foreground"},"Search your chat history",-1)),s[17]||(s[17]=a("p",{class:"text-xs text-muted-foreground"},"Enter at least 2 characters to search",-1))])]))])]),_:1})])):T("",!0)}}),Is=he(Es,[["__scopeId","data-v-a92378d7"]]),As={class:"chat-history"},Ns={class:"flex items-center justify-between mb-4"},Rs={class:"flex items-center gap-2"},Ls={class:"flex items-center gap-2"},Us={key:0,class:"flex items-center justify-center py-8"},Hs={key:1,class:"text-center py-8"},Bs={class:"text-muted-foreground"},Vs={key:2,class:"space-y-4"},Qs={class:"flex items-center justify-between p-4 border-b bg-muted/30"},Ws={class:"flex-1"},Os={class:"font-medium text-sm truncate"},Ks={class:"flex items-center gap-4 text-xs text-muted-foreground mt-1"},Xs={class:"flex items-center gap-2"},Gs={key:0,class:"p-4 space-y-3 max-h-96 overflow-y-auto"},qs={class:"flex items-center justify-between mt-2 pt-2 border-t border-current/20"},Ys={class:"text-xs opacity-70"},Zs={key:3,class:"flex items-center justify-between mt-6"},Js={class:"text-sm text-muted-foreground"},ea={key:1,class:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"},ta={key:1,class:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"},sa={key:1,class:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"},aa=ce({__name:"ChatHistory",props:{projectSlug:{},chapterNumber:{}},emits:["chat-deleted","chat-cleared"],setup(Q,{emit:W}){const w=Q,_=W,u=b([]),p=b(!1),h=b(!1),x=b(1),k=b(1),M=b(0),C=at(new Set),P=b(!1),E=b(!1),S=b(!1),j=b(null),U=b(null),R=async(r=1)=>{p.value=!0;try{const i=await(await fetch(`/projects/${w.projectSlug}/chapters/${w.chapterNumber}/chat/sessions?page=${r}&per_page=10`)).json();if(i.success)u.value=i.sessions,x.value=i.page,k.value=i.total_pages,M.value=i.total_sessions;else throw new Error(i.error||"Failed to load chat history")}catch(s){console.error("Failed to load chat history:",s),ae.error("Failed to load chat history")}finally{p.value=!1}},B=r=>{r>=1&&r<=k.value&&R(r)},F=()=>{R(x.value)},V=r=>{C.has(r)?C.delete(r):C.add(r)},I=r=>{j.value=r,P.value=!0},K=(r,s)=>{U.value=r,j.value=s,E.value=!0},X=async()=>{if(j.value){h.value=!0;try{const s=await(await fetch(`/projects/${w.projectSlug}/chapters/${w.chapterNumber}/chat/sessions/${j.value.session_id}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",Accept:"application/json"}})).json();if(s.success)ae.success(s.message),P.value=!1,j.value=null,_("chat-deleted"),R(x.value);else throw new Error(s.error||"Failed to delete session")}catch(r){console.error("Failed to delete session:",r),ae.error("Failed to delete chat session")}finally{h.value=!1}}},G=async()=>{if(U.value){h.value=!0;try{const s=await(await fetch(`/projects/${w.projectSlug}/chapters/${w.chapterNumber}/chat/messages/${U.value.id}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",Accept:"application/json"}})).json();if(s.success)ae.success(s.message),E.value=!1,U.value=null,R(x.value);else throw new Error(s.error||"Failed to delete message")}catch(r){console.error("Failed to delete message:",r),ae.error("Failed to delete message")}finally{h.value=!1}}},q=async()=>{h.value=!0;try{const s=await(await fetch(`/projects/${w.projectSlug}/chapters/${w.chapterNumber}/chat/clear`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",Accept:"application/json"}})).json();if(s.success)ae.success(s.message),S.value=!1,_("chat-cleared"),u.value=[],M.value=0,k.value=1,x.value=1,C.clear();else throw new Error(s.error||"Failed to clear history")}catch(r){console.error("Failed to clear history:",r),ae.error("Failed to clear chat history")}finally{h.value=!1}};return De(()=>{R()}),(r,s)=>(n(),f("div",As,[a("div",Ns,[a("div",Rs,[t(e(je),{class:"h-5 w-5 text-muted-foreground"}),s[9]||(s[9]=a("h3",{class:"text-lg font-semibold"},"Chat History",-1))]),a("div",Ls,[t(e(v),{variant:"outline",size:"sm",onClick:F,disabled:p.value},{default:l(()=>[t(e(We),{class:"h-4 w-4"}),s[10]||(s[10]=g(" Refresh ",-1))]),_:1},8,["disabled"]),t(e(v),{variant:"destructive",size:"sm",onClick:s[0]||(s[0]=i=>S.value=!0),disabled:u.value.length===0||p.value},{default:l(()=>[t(e(re),{class:"h-4 w-4"}),s[11]||(s[11]=g(" Clear All ",-1))]),_:1},8,["disabled"])])]),p.value?(n(),f("div",Us,[...s[12]||(s[12]=[a("div",{class:"flex items-center gap-2 text-muted-foreground"},[a("div",{class:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}),g(" Loading chat history... ")],-1)])])):u.value.length===0?(n(),f("div",Hs,[a("div",Bs,[t(e(ot),{class:"h-12 w-12 mx-auto mb-2 opacity-50"}),s[13]||(s[13]=a("p",{class:"text-lg"},"No chat history yet",-1)),s[14]||(s[14]=a("p",{class:"text-sm"},"Start a conversation to see your chat history here.",-1))])])):(n(),f("div",Vs,[(n(!0),f(fe,null,ve(u.value,i=>(n(),f("div",{key:i.session_id,class:"border rounded-lg"},[a("div",Qs,[a("div",Ws,[a("div",Os,[t(ge,{content:i.title,class:"prose prose-sm max-w-none prose-headings:text-sm prose-headings:m-0 prose-p:m-0 prose-p:text-sm"},null,8,["content"])]),a("div",Ks,[a("span",null,y(i.started_at),1),a("span",null,y(i.message_count)+" messages",1),a("span",null,y(i.duration),1)])]),a("div",Xs,[t(e(v),{variant:"ghost",size:"sm",onClick:z=>V(i.session_id)},{default:l(()=>[t(e(lt),{class:N(["h-4 w-4 transition-transform",{"rotate-180":C.has(i.session_id)}])},null,8,["class"])]),_:2},1032,["onClick"]),t(e(v),{variant:"ghost",size:"sm",onClick:z=>I(i)},{default:l(()=>[t(e(re),{class:"h-4 w-4 text-destructive"})]),_:2},1032,["onClick"])])]),C.has(i.session_id)?(n(),f("div",Gs,[(n(!0),f(fe,null,ve(i.messages,z=>(n(),f("div",{key:z.id,class:N(["flex gap-3 group",z.message_type==="user"?"justify-end":"justify-start"])},[a("div",{class:N(["max-w-[80%] rounded-lg p-3 text-sm",z.message_type==="user"?"bg-primary text-primary-foreground":"bg-muted"])},[t(ge,{content:z.content,class:N(["prose prose-sm max-w-none",z.message_type==="user"?"chat-message-user prose-invert":"chat-message-ai"])},null,8,["content","class"]),a("div",qs,[a("div",Ys,y(z.formatted_time),1),t(e(v),{variant:"ghost",size:"sm",class:"opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0",onClick:Z=>K(z,i)},{default:l(()=>[t(e(re),{class:"h-3 w-3"})]),_:2},1032,["onClick"])])],2)],2))),128))])):T("",!0)]))),128))])),k.value>1?(n(),f("div",Zs,[t(e(v),{variant:"outline",size:"sm",onClick:s[1]||(s[1]=i=>B(x.value-1)),disabled:x.value===1||p.value},{default:l(()=>[t(e(Ve),{class:"h-4 w-4"}),s[15]||(s[15]=g(" Previous ",-1))]),_:1},8,["disabled"]),a("span",Js," Page "+y(x.value)+" of "+y(k.value),1),t(e(v),{variant:"outline",size:"sm",onClick:s[2]||(s[2]=i=>B(x.value+1)),disabled:x.value===k.value||p.value},{default:l(()=>[s[16]||(s[16]=g(" Next ",-1)),t(e(Qe),{class:"h-4 w-4"})]),_:1},8,["disabled"])])):T("",!0),t(e(_e),{open:P.value,"onUpdate:open":s[4]||(s[4]=i=>P.value=i)},{default:l(()=>[t(e(ke),null,{default:l(()=>[t(e(Se),null,{default:l(()=>[t(e(Te),null,{default:l(()=>[...s[17]||(s[17]=[g("Delete Chat Session",-1)])]),_:1}),t(e(Ce),null,{default:l(()=>[g(" Are you sure you want to delete this chat session? This will permanently remove "+y(j.value?.message_count)+" messages. This action cannot be undone. ",1)]),_:1})]),_:1}),t(e($e),null,{default:l(()=>[t(e(v),{variant:"outline",onClick:s[3]||(s[3]=i=>P.value=!1)},{default:l(()=>[...s[18]||(s[18]=[g(" Cancel ",-1)])]),_:1}),t(e(v),{variant:"destructive",onClick:X,disabled:h.value},{default:l(()=>[h.value?(n(),f("div",ea)):(n(),D(e(re),{key:0,class:"h-4 w-4 mr-2"})),g(" "+y(h.value?"Deleting...":"Delete Session"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"]),t(e(_e),{open:E.value,"onUpdate:open":s[6]||(s[6]=i=>E.value=i)},{default:l(()=>[t(e(ke),null,{default:l(()=>[t(e(Se),null,{default:l(()=>[t(e(Te),null,{default:l(()=>[...s[19]||(s[19]=[g("Delete Message",-1)])]),_:1}),t(e(Ce),null,{default:l(()=>[...s[20]||(s[20]=[g(" Are you sure you want to delete this message? This action cannot be undone. ",-1)])]),_:1})]),_:1}),t(e($e),null,{default:l(()=>[t(e(v),{variant:"outline",onClick:s[5]||(s[5]=i=>E.value=!1)},{default:l(()=>[...s[21]||(s[21]=[g(" Cancel ",-1)])]),_:1}),t(e(v),{variant:"destructive",onClick:G,disabled:h.value},{default:l(()=>[h.value?(n(),f("div",ta)):(n(),D(e(re),{key:0,class:"h-4 w-4 mr-2"})),g(" "+y(h.value?"Deleting...":"Delete Message"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"]),t(e(_e),{open:S.value,"onUpdate:open":s[8]||(s[8]=i=>S.value=i)},{default:l(()=>[t(e(ke),null,{default:l(()=>[t(e(Se),null,{default:l(()=>[t(e(Te),null,{default:l(()=>[...s[22]||(s[22]=[g("Clear All Chat History",-1)])]),_:1}),t(e(Ce),null,{default:l(()=>[g(" Are you sure you want to clear all chat history for this chapter? This will permanently delete all "+y(u.value.reduce((i,z)=>i+z.message_count,0))+" messages across "+y(u.value.length)+" sessions. This action cannot be undone. ",1)]),_:1})]),_:1}),t(e($e),null,{default:l(()=>[t(e(v),{variant:"outline",onClick:s[7]||(s[7]=i=>S.value=!1)},{default:l(()=>[...s[23]||(s[23]=[g(" Cancel ",-1)])]),_:1}),t(e(v),{variant:"destructive",onClick:q,disabled:h.value},{default:l(()=>[h.value?(n(),f("div",sa)):(n(),D(e(re),{key:0,class:"h-4 w-4 mr-2"})),g(" "+y(h.value?"Clearing...":"Clear All History"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"])]))}}),oa=he(aa,[["__scopeId","data-v-7d4b2681"]]),la={class:"flex items-center gap-3"},na={key:0,class:"flex items-center rounded-full border bg-muted/40 p-0.5 shadow-inner"},ra={class:"flex items-center gap-1"},ia={key:0,class:"flex flex-1 flex-col items-center justify-center space-y-2 p-2"},da={key:1,class:"relative flex-1 overflow-hidden"},ua={key:"search",class:"absolute inset-0 bg-background"},ca={key:"history",class:"absolute inset-0 bg-background overflow-y-auto"},pa={class:"p-4"},ma={key:"chat",class:"flex flex-col h-full"},fa={class:N(["flex-shrink-0 border-b bg-background px-4 py-3"])},va={class:"flex-shrink-0 border-b bg-muted/20 px-4 py-2"},ga={class:"flex items-center gap-2"},ha={class:"text-[10px] text-muted-foreground truncate"},xa={key:0,class:"flex-shrink-0 border-b bg-blue-50/50 dark:bg-blue-950/20 px-4 py-2"},ya={class:"flex items-start gap-3"},ba={class:"mt-0.5 p-1 rounded bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400"},wa={class:"min-w-0 flex-1"},_a={class:"flex items-center justify-between mb-1"},ka={class:"text-xs text-muted-foreground italic line-clamp-2 border-l-2 border-blue-200 dark:border-blue-800 pl-2"},Ca={key:0,class:"flex-shrink-0 border-b bg-orange-50 p-3 dark:bg-orange-950/20"},$a={class:"min-h-full space-y-4 p-3"},Sa={key:0,class:"flex max-w-[90%] gap-3"},Ta={class:"flex-1 min-w-0"},Ma={key:1,class:"flex items-center gap-2 py-1"},za={key:2,class:"mt-3 flex items-center justify-between border-t border-border/40 pt-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200"},ja={class:"flex items-center gap-1"},Da={key:3,class:"text-green-600"},Fa={key:4},Pa={key:5},Ea={class:"mt-1.5 px-1 text-[10px] text-muted-foreground/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300"},Ia={key:1,class:"flex max-w-[85%] gap-3 flex-row-reverse"},Aa={class:"mt-1 flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-primary shadow-sm"},Na={class:"flex-1 text-right"},Ra={class:"inline-block rounded-2xl rounded-tr-sm bg-primary px-6 py-4 text-primary-foreground shadow-md text-left"},La={class:"mt-1.5 px-1 text-[10px] text-muted-foreground/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300"},Ua={key:0,class:"flex gap-2"},Ha={class:"flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 shadow-md"},Ba={class:"flex-shrink-0 border-t bg-background/50 backdrop-blur-sm p-4"},Va={class:"relative rounded-xl border bg-background shadow-sm focus-within:ring-2 focus-within:ring-primary/20 transition-all"},Qa={class:"absolute right-2 bottom-2"},Wa={class:"mt-2 flex items-center justify-between px-1"},Oa={class:"flex items-center gap-2"},Ka={key:0,class:"text-[10px] text-muted-foreground"},Xa={key:1,class:"flex items-center gap-1.5 text-[10px] text-primary font-medium"},Ga={class:"flex items-center gap-2"},qa=ce({__name:"ChatAssistant",props:{isMinimized:{type:Boolean},messages:{},isTyping:{type:Boolean},selectedText:{},chapterContent:{},chapterNumber:{},input:{},currentMode:{default:"assist"},projectSlug:{},sessionId:{},isMobile:{type:Boolean,default:!1}},emits:["update:input","send-message","quick-action","retry-message","stop-generation","toggle-minimize","change-mode","copy-message","rate-message","new-session","chat-deleted","chat-cleared"],setup(Q,{emit:W}){const w=Q,_=W,u=b(),p=b(),h=b(!1),x=b(!1),k=b(!1),M=b([]),C=O(()=>w.selectedText.trim().length>0),P=O(()=>w.messages.length),E=O(()=>w.messages.reduce((d,o)=>d+o.content.length,0)),S=()=>{ye(()=>{setTimeout(()=>{try{const d=u.value;if(!d)return;const o=d.$el||d;if(!o)return;let m=o.querySelector("[data-radix-scroll-area-viewport]");if(m||(m=o.querySelector("[data-viewport]")),m||(m=o.querySelector('[role="region"]')),m||(m=o.querySelector('div[style*="overflow"]')),!m){const se=o.querySelectorAll("div");for(const xe of se){const le=window.getComputedStyle(xe);if(le.overflow==="auto"||le.overflow==="scroll"||le.overflowY==="auto"||le.overflowY==="scroll"){m=xe;break}}}m?(console.log("Scrolling chat to bottom:",{scrollHeight:m.scrollHeight,clientHeight:m.clientHeight,currentScrollTop:m.scrollTop}),m.scrollTop=m.scrollHeight,m.scrollTo&&m.scrollTo({top:m.scrollHeight,behavior:"auto"})):(console.warn("Could not find scrollable viewport in ScrollArea"),console.log("ScrollArea element structure:",o))}catch(d){console.warn("Chat scroll to bottom failed:",d)}},100)})};oe(P,()=>{S()},{flush:"post"}),oe(E,()=>{w.messages.some(o=>o.isStreaming)&&U()},{flush:"post"});let j=null;const U=()=>{j&&clearTimeout(j),j=setTimeout(()=>{S()},50)};De(()=>{setTimeout(()=>{S()},300)});const R=()=>{w.input.trim()&&(_("send-message"),setTimeout(()=>{S()},100),ye(()=>{try{p.value&&p.value.$el?p.value.$el.focus():p.value&&p.value.focus&&p.value.focus()}catch(d){console.warn("Focus failed:",d)}}))},B=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),R())},F=d=>{_("quick-action",d)},V=d=>d.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),I=b(null),K=async d=>{try{const o=document.createElement("div");o.innerHTML=d.content;const m=o.textContent||o.innerText||d.content;await navigator.clipboard.writeText(m),_("copy-message",d),I.value=d.id,setTimeout(()=>{I.value=null},1500)}catch(o){console.error("Failed to copy message:",o),I.value=-1,setTimeout(()=>{I.value=null},1500)}},X=()=>{C.value&&_("update:input",`Can you help me improve this text: "${w.selectedText}"`)},G=()=>{h.value=!h.value,h.value&&(x.value=!1,k.value=!1)},q=()=>{x.value=!x.value,x.value&&(h.value=!1,k.value=!1)},r=()=>{k.value=!k.value,k.value&&(h.value=!1,x.value=!1)},s=d=>{M.value.unshift(d),console.log("File uploaded and will be included in chat context:",d)},i=d=>{M.value=M.value.filter(o=>o.id!==d)},z=d=>{M.value=d},Z=(d,o)=>{console.log("Navigate to message:",d,"in session:",o),x.value=!1},c=()=>{_("new-session")},$=()=>{_("chat-deleted")},A=()=>{_("chat-cleared")},H=d=>{_("retry-message",d)},te=()=>{_("stop-generation")};return(d,o)=>(n(),f("div",{class:N(["flex h-full flex-col bg-background",d.isMobile?"border-0":"border-l"])},[a("div",{class:N(["flex flex-shrink-0 items-center justify-between border-b bg-background/80 backdrop-blur-md sticky top-0 z-10",d.isMobile?"p-3":"px-4 py-3"])},[a("div",la,[d.isMinimized?T("",!0):(n(),f("div",na,[t(e(v),{onClick:o[0]||(o[0]=m=>_("change-mode","assist")),variant:d.currentMode==="assist"?"default":"ghost",size:"sm",class:"h-7 rounded-full px-3 text-xs font-medium gap-1.5 transition-all duration-200"},{default:l(()=>[t(e(ze),{class:"h-3.5 w-3.5"}),o[15]||(o[15]=g(" Assist ",-1))]),_:1},8,["variant"]),t(e(v),{onClick:o[1]||(o[1]=m=>_("change-mode","review")),variant:d.currentMode==="review"?"default":"ghost",size:"sm",class:"h-7 rounded-full px-3 text-xs font-medium gap-1.5 transition-all duration-200"},{default:l(()=>[t(e(me),{class:"h-3.5 w-3.5"}),o[16]||(o[16]=g(" Review ",-1))]),_:1},8,["variant"])]))]),a("div",ra,[t(e(v),{onClick:c,variant:"ghost",size:"icon",class:"h-8 w-8 hover:bg-muted text-muted-foreground hover:text-foreground rounded-full transition-colors",title:"New Session"},{default:l(()=>[t(e(Fe),{class:"h-4 w-4"})]),_:1}),o[17]||(o[17]=a("div",{class:"h-4 w-px bg-border/60 mx-1"},null,-1)),t(e(v),{onClick:q,variant:"ghost",size:"icon",class:N(["h-8 w-8 rounded-full transition-colors",x.value?"bg-primary/10 text-primary":"hover:bg-muted text-muted-foreground hover:text-foreground"]),title:"Search"},{default:l(()=>[t(e(me),{class:"h-4 w-4"})]),_:1},8,["class"]),t(e(v),{onClick:r,variant:"ghost",size:"icon",class:N(["h-8 w-8 rounded-full transition-colors",k.value?"bg-primary/10 text-primary":"hover:bg-muted text-muted-foreground hover:text-foreground"]),title:"History"},{default:l(()=>[t(e(je),{class:"h-4 w-4"})]),_:1},8,["class"]),t(e(v),{onClick:G,variant:"ghost",size:"icon",class:N(["h-8 w-8 rounded-full transition-colors",h.value?"bg-primary/10 text-primary":"hover:bg-muted text-muted-foreground hover:text-foreground"]),title:"Upload Context"},{default:l(()=>[t(e(He),{class:"h-4 w-4"})]),_:1},8,["class"]),d.isMobile?T("",!0):(n(),D(e(v),{key:0,onClick:o[2]||(o[2]=m=>_("toggle-minimize")),variant:"ghost",size:"icon",class:"h-8 w-8 hover:bg-muted text-muted-foreground hover:text-foreground rounded-full transition-colors"},{default:l(()=>[d.isMinimized?(n(),D(e(rt),{key:1,class:"h-4 w-4"})):(n(),D(e(nt),{key:0,class:"h-4 w-4"}))]),_:1})),d.isMobile?(n(),D(e(v),{key:1,onClick:o[3]||(o[3]=m=>_("toggle-minimize")),variant:"ghost",size:"icon",class:"h-8 w-8 hover:bg-muted text-muted-foreground hover:text-foreground rounded-full"},{default:l(()=>[t(e(be),{class:"h-4 w-4"})]),_:1})):T("",!0)])],2),d.isMinimized?(n(),f("div",ia,[t(e(v),{onClick:o[4]||(o[4]=m=>_("toggle-minimize")),variant:"ghost",size:"icon",class:"h-12 w-12 rounded-full"},{default:l(()=>[t(e(Be),{class:"h-6 w-6"})]),_:1}),o[18]||(o[18]=a("p",{class:"-rotate-90 transform text-center text-xs whitespace-nowrap text-muted-foreground"},"Chat",-1))])):(n(),f("div",da,[t(ie,{name:"slide-left",mode:"out-in",appear:""},{default:l(()=>[x.value?(n(),f("div",ua,[t(Is,{"project-slug":d.projectSlug,"chapter-number":d.chapterNumber,show:x.value,onClose:o[5]||(o[5]=m=>x.value=!1),onMessageSelected:Z},null,8,["project-slug","chapter-number","show"])])):T("",!0)]),_:1}),t(ie,{name:"slide-right",mode:"out-in",appear:""},{default:l(()=>[k.value?(n(),f("div",ca,[a("div",pa,[t(oa,{"project-slug":d.projectSlug,"chapter-number":d.chapterNumber,onChatDeleted:$,onChatCleared:A},null,8,["project-slug","chapter-number"])])])):T("",!0)]),_:1}),t(ie,{name:"slide-up",mode:"out-in",appear:""},{default:l(()=>[!x.value&&!k.value&&!h.value?(n(),f("div",ma,[a("div",fa,[d.currentMode==="review"?(n(),f("div",{key:0,class:N(["flex flex-wrap gap-2",d.isMobile?"justify-start overflow-x-auto pb-2 noscrollbar":"justify-start"])},[t(e(v),{onClick:o[6]||(o[6]=m=>F("overall-review")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(it),{class:"mr-1.5 h-3.5 w-3.5 text-blue-500"}),o[19]||(o[19]=g(" Overall Review ",-1))]),_:1}),t(e(v),{onClick:o[7]||(o[7]=m=>F("test-knowledge")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(dt),{class:"mr-1.5 h-3.5 w-3.5 text-purple-500"}),o[20]||(o[20]=g(" Test Knowledge ",-1))]),_:1}),t(e(v),{onClick:o[8]||(o[8]=m=>F("find-weaknesses")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(ut),{class:"mr-1.5 h-3.5 w-3.5 text-red-500"}),o[21]||(o[21]=g(" Find Weaknesses ",-1))]),_:1}),t(e(v),{onClick:o[9]||(o[9]=m=>F("citation-check")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(ct),{class:"mr-1.5 h-3.5 w-3.5 text-amber-500"}),o[22]||(o[22]=g(" Check Citations ",-1))]),_:1}),t(e(v),{onClick:o[10]||(o[10]=m=>F("structure-review")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(pt),{class:"mr-1.5 h-3.5 w-3.5 text-indigo-500"}),o[23]||(o[23]=g(" Review Structure ",-1))]),_:1})],2)):(n(),f("div",{key:1,class:N(["flex flex-wrap gap-2",d.isMobile?"justify-start overflow-x-auto pb-2 noscrollbar":"justify-start"])},[t(e(v),{onClick:o[11]||(o[11]=m=>F("improve-writing")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(ze),{class:"mr-1.5 h-3.5 w-3.5 text-emerald-500"}),o[24]||(o[24]=g(" Improve Writing ",-1))]),_:1}),t(e(v),{onClick:o[12]||(o[12]=m=>F("expand-section")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(mt),{class:"mr-1.5 h-3.5 w-3.5 text-yellow-500"}),o[25]||(o[25]=g(" Expand Section ",-1))]),_:1}),t(e(v),{onClick:o[13]||(o[13]=m=>F("fix-grammar")),size:"sm",variant:"outline",class:"h-8 rounded-full px-3 text-xs bg-card hover:bg-muted/50 border-input transition-all"},{default:l(()=>[t(e(ft),{class:"mr-1.5 h-3.5 w-3.5 text-blue-500"}),o[26]||(o[26]=g(" Fix Grammar ",-1))]),_:1})],2))]),a("div",va,[a("div",ga,[t(e(de),{variant:"secondary",class:"h-5 px-1.5 text-[10px] bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 gap-1 border-0"},{default:l(()=>[t(e(vt),{class:"h-3 w-3"}),o[27]||(o[27]=g(" Context Active ",-1))]),_:1}),a("span",ha," Analyzing "+y(Math.round(d.chapterContent.length/1e3))+"k characters of content ",1)])]),t(ie,{name:"slide-down"},{default:l(()=>[C.value?(n(),f("div",xa,[a("div",ya,[a("div",ba,[t(e(gt),{class:"h-3.5 w-3.5"})]),a("div",wa,[a("div",_a,[o[29]||(o[29]=a("p",{class:"text-xs font-medium text-blue-700 dark:text-blue-300"},"Selected text context",-1)),t(e(v),{onClick:X,size:"sm",variant:"ghost",class:"h-5 px-2 text-[10px] hover:bg-blue-100 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400"},{default:l(()=>[...o[28]||(o[28]=[g(" Ask AI ",-1)])]),_:1})]),a("p",ka,' "'+y(d.selectedText)+'" ',1)])])])):T("",!0)]),_:1}),t(ie,{name:"slide-down",appear:""},{default:l(()=>[h.value?(n(),f("div",Ca,[t(ls,{"project-slug":d.projectSlug,"chapter-number":d.chapterNumber,"session-id":d.sessionId,disabled:d.isTyping,onFileUploaded:s,onFileDeleted:i,onFilesLoaded:z},null,8,["project-slug","chapter-number","session-id","disabled"])])):T("",!0)]),_:1}),t(e(we),{ref_key:"scrollContainer",ref:u,class:"min-h-0 flex-1"},{default:l(()=>[a("div",$a,[t(ht,{name:"message-list",tag:"div",class:"space-y-4"},{default:l(()=>[(n(!0),f(fe,null,ve(d.messages,m=>(n(),f("div",{key:m.id,class:N(["flex gap-4 group",m.type==="user"?"justify-end":"justify-start"])},[m.type!=="user"?(n(),f("div",Sa,[a("div",{class:N(["mt-1 flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full shadow-sm border border-border/50",m.type==="ai"?"bg-gradient-to-br from-indigo-500 to-violet-600":"bg-orange-500"])},[m.type==="ai"?(n(),D(e(Pe),{key:0,class:"h-4 w-4 text-white"})):(n(),D(e(Me),{key:1,class:"h-4 w-4 text-white"}))],2),a("div",Ta,[a("div",{class:N(["rounded-2xl rounded-tl-none px-6 py-4 shadow-sm transition-all duration-200",m.type==="ai"?"bg-card border border-border/50 text-card-foreground":"border border-orange-200 bg-orange-50/50 dark:border-orange-900/50 dark:bg-orange-950/20"])},[m.content?(n(),D(ge,{key:0,content:m.content,class:"prose dark:prose-invert max-w-none chat-message-ai leading-relaxed text-lg"},null,8,["content"])):m.isStreaming?(n(),f("div",Ma,[...o[30]||(o[30]=[a("div",{class:"flex gap-1.5"},[a("div",{class:"h-2 w-2 animate-bounce rounded-full bg-primary/40"}),a("div",{class:"h-2 w-2 animate-bounce rounded-full bg-primary/40",style:{"animation-delay":"0.1s"}}),a("div",{class:"h-2 w-2 animate-bounce rounded-full bg-primary/40",style:{"animation-delay":"0.2s"}})],-1),a("span",{class:"text-xs text-muted-foreground font-medium"},"Thinking...",-1)])])):T("",!0),m.type==="ai"?(n(),f("div",za,[a("div",ja,[m.failed?(n(),D(e(v),{key:0,onClick:se=>H(m),size:"sm",variant:"ghost",class:"h-6 px-2 text-xs text-orange-600 hover:text-orange-700 hover:bg-orange-50 dark:hover:bg-orange-950/30"},{default:l(()=>[t(e(We),{class:"mr-1 h-3 w-3"}),o[31]||(o[31]=g(" Try Again ",-1))]),_:2},1032,["onClick"])):T("",!0),t(e(v),{onClick:se=>K(m),size:"sm",variant:"ghost",class:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground",disabled:I.value===m.id||I.value===-1},{default:l(()=>[I.value!==m.id&&I.value!==-1?(n(),D(e(xt),{key:0,class:"mr-1 h-3 w-3"})):I.value===m.id?(n(),D(e(Oe),{key:1,class:"mr-1 h-3 w-3 text-green-600"})):(n(),D(e(Me),{key:2,class:"mr-1 h-3 w-3 text-red-600"})),I.value===m.id?(n(),f("span",Da,"Copied!")):I.value===-1?(n(),f("span",Fa,"Failed")):(n(),f("span",Pa,"Copy"))]),_:2},1032,["onClick","disabled"]),t(e(v),{onClick:se=>_("rate-message",m.id,1),size:"sm",variant:"ghost",class:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground"},{default:l(()=>[t(e(yt),{class:"h-3 w-3"})]),_:2},1032,["onClick"]),t(e(v),{onClick:se=>_("rate-message",m.id,-1),size:"sm",variant:"ghost",class:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground"},{default:l(()=>[t(e(bt),{class:"h-3 w-3"})]),_:2},1032,["onClick"])]),o[32]||(o[32]=a("span",{class:"text-[10px] uppercase font-semibold text-muted-foreground/60 tracking-wider"}," AI Assistant ",-1))])):T("",!0)],2),a("p",Ea,y(V(m.timestamp)),1)])])):(n(),f("div",Ia,[a("div",Aa,[t(e(wt),{class:"h-4 w-4 text-primary-foreground"})]),a("div",Na,[a("div",Ra,[t(ge,{content:m.content,class:"prose max-w-none chat-message-user leading-relaxed text-lg break-words text-primary-foreground grayscale-0"},null,8,["content"])]),a("p",La,y(V(m.timestamp)),1)])]))],2))),128))]),_:1})])]),_:1},512),t(ie,{name:"fade"},{default:l(()=>[d.isTyping?(n(),f("div",Ua,[a("div",Ha,[t(e(Pe),{class:"h-4 w-4 text-white"})]),o[33]||(o[33]=a("div",{class:"max-w-[85%] rounded-lg border bg-muted p-3"},[a("div",{class:"flex items-center gap-1"},[a("div",{class:"flex gap-1"},[a("div",{class:"h-2 w-2 animate-bounce rounded-full bg-muted-foreground"}),a("div",{class:"h-2 w-2 animate-bounce rounded-full bg-muted-foreground",style:{"animation-delay":"0.1s"}}),a("div",{class:"h-2 w-2 animate-bounce rounded-full bg-muted-foreground",style:{"animation-delay":"0.2s"}})]),a("span",{class:"ml-2 text-xs text-muted-foreground"},"AI is thinking...")])],-1))])):T("",!0)]),_:1}),a("div",Ba,[a("div",Va,[t(Rt,{ref_key:"inputRef",ref:p,"model-value":d.input,"onUpdate:modelValue":o[14]||(o[14]=m=>_("update:input",m)),onSubmit:R,onKeydown:B,disabled:d.isTyping,"show-toolbar":!1,placeholder:"Ask anything about your chapter...",class:"pr-12 min-h-[50px] max-h-[150px] py-1"},null,8,["model-value","disabled"]),a("div",Qa,[d.isTyping?(n(),D(e(v),{key:1,onClick:te,size:"icon",variant:"destructive",class:"h-8 w-8 rounded-lg shadow-sm animate-pulse"},{default:l(()=>[t(e(_t),{class:"h-4 w-4"})]),_:1})):(n(),D(e(v),{key:0,onClick:R,size:"icon",class:"h-8 w-8 rounded-lg bg-primary text-primary-foreground hover:bg-primary/90 transition-all shadow-sm",disabled:!d.input.trim()},{default:l(()=>[t(e(Ue),{class:"h-4 w-4"})]),_:1},8,["disabled"]))])]),a("div",Wa,[a("div",Oa,[d.isTyping?(n(),f("span",Xa,[...o[35]||(o[35]=[a("span",{class:"relative flex h-2 w-2"},[a("span",{class:"animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"}),a("span",{class:"relative inline-flex rounded-full h-2 w-2 bg-primary"})],-1),g(" AI is writing... ",-1)])])):(n(),f("span",Ka,[...o[34]||(o[34]=[a("span",{class:"font-medium text-foreground/80"},"Tip:",-1),g(" Press ",-1),a("kbd",{class:"px-1 py-0.5 rounded bg-muted font-mono text-[9px]"},"Enter",-1),g(" to send ",-1)])]))]),a("div",Ga,[t(e(v),{onClick:c,variant:"ghost",size:"sm",class:"h-6 px-2 text-[10px] gap-1 text-muted-foreground hover:text-foreground",disabled:d.isTyping},{default:l(()=>[t(e(Fe),{class:"h-3 w-3"}),o[36]||(o[36]=g(" Clear Chat ",-1))]),_:1},8,["disabled"])])])])])):T("",!0)]),_:1})]))],2))}}),Le=he(qa,[["__scopeId","data-v-e137d10e"]]),Ya={class:"flex h-screen flex-col overflow-hidden bg-background"},Za={class:"flex flex-shrink-0 items-center justify-between border-b bg-background/95 p-2 backdrop-blur supports-[backdrop-filter]:bg-background/60"},Ja={class:"flex items-center gap-2"},eo={class:"flex items-center gap-2"},to={class:"flex-shrink-0 bg-muted/30 px-3 py-2"},so={class:"mb-1 flex items-center justify-between"},ao={class:"text-xs text-muted-foreground"},oo={class:"flex flex-1 overflow-hidden"},lo={key:0,class:"absolute inset-0 z-50 bg-background md:hidden"},no={class:"flex min-h-0 flex-1 flex-col border-r"},ro={class:"flex min-h-0 flex-1 flex-col space-y-2"},io={class:"flex items-center justify-end"},uo={key:0,class:"flex flex-shrink-0 items-center gap-2 rounded-lg bg-muted/30 p-2"},co={class:"text-xs"},po={class:"flex flex-shrink-0 gap-2 pt-2"},Ho=ce({__name:"ChatModeLayout",props:{project:{},chapter:{},chapterTitle:{},chapterContent:{},currentWordCount:{},targetWordCount:{},progressPercentage:{},writingQualityScore:{},isValid:{type:Boolean},isSaving:{type:Boolean},showPreview:{type:Boolean},isGenerating:{type:Boolean},generationProgress:{},historyIndex:{},contentHistoryLength:{},selectedText:{}},emits:["update:chapterTitle","update:chapterContent","update:selectedText","update:showPreview","save","undo","redo","exitChatMode"],setup(Q,{emit:W}){const w=Q,_=W,u=b([]),p=b(""),h=b(!1),x=b(null),k=b(!1),M=b(null),C=b(!1),P=b(!1),E=b("review"),S=b(!1),j=b(0),U=()=>{j.value=window.innerWidth,S.value=window.innerWidth<768,S.value&&P.value},R=()=>{U()},B=async()=>{k.value=!0;try{const c=await pe.get(ue("chapters.chat-history",{project:w.project.slug,chapter:w.chapter.chapter_number})),{messages:$,current_session_id:A}=c.data;$&&$.length>0?(u.value=$.map(H=>({id:H.id,type:H.type,content:H.content,timestamp:new Date(H.timestamp)})),x.value=A):u.value=[]}catch(c){console.warn("Failed to load chat history:",c),u.value=[]}finally{k.value=!1}};De(()=>{B(),U(),window.addEventListener("resize",R)}),kt(()=>{window.removeEventListener("resize",R)});const F=async c=>{if(!p.value.trim()&&!c)return;const $=c?"":p.value,A=p.value;p.value="",c||u.value.push({id:Date.now(),type:"user",content:$,timestamp:new Date}),h.value=!0;const H=Date.now()+1;try{const te=await fetch(ue("chapters.chat-stream",{project:w.project.slug,chapter:w.chapter.chapter_number}),{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({message:$,chapter_content:w.chapterContent||"",selected_text:w.selectedText||"",session_id:x.value,task_type:E.value,quick_action:c||null})});if(!te.ok)throw new Error(`HTTP error! status: ${te.status}`);const d=te.body?.getReader();if(!d)throw new Error("No response body reader available");M.value=d;const o=new TextDecoder;let m="";const se=async()=>{try{for(;;){const{done:L,value:J}=await d.read();if(L)break;m+=o.decode(J,{stream:!0});const ee=m.split(`
`);m=ee.pop()||"";for(const ne of ee)if(ne.startsWith("data: "))try{const Y=JSON.parse(ne.slice(6));xe(Y)}catch(Y){console.error("Failed to parse streaming data:",Y)}}}catch(L){console.error("Stream reading error:",L),le(L)}},xe=L=>{switch(L.type){case"start":h.value=!0,L.session_id&&(x.value=L.session_id);break;case"content":h.value&&(h.value=!1);const J=u.value.findIndex(Y=>Y.id===H);J===-1?u.value.push({id:H,type:"ai",content:L.content,timestamp:new Date,isStreaming:!0}):u.value[J].content+=L.content;break;case"complete":h.value=!1,L.session_id&&(x.value=L.session_id);const ee=u.value.findIndex(Y=>Y.id===H);ee!==-1&&(u.value[ee].isStreaming=!1,L.ai_message_id&&(u.value[ee].id=L.ai_message_id));break;case"error":h.value=!1;const ne=u.value.findIndex(Y=>Y.id===H);ne!==-1?u.value[ne]={id:u.value[ne].id,type:"ai",content:L.message||"⚠️ Sorry, I encountered an error processing your message.",timestamp:new Date,failed:!0,lastPrompt:A,lastQuickAction:c}:u.value.push({id:Date.now(),type:"ai",content:L.message||"⚠️ Sorry, I encountered an error processing your message.",timestamp:new Date,failed:!0,lastPrompt:A,lastQuickAction:c});break;case"heartbeat":break}},le=L=>{h.value=!1;const J=u.value.findIndex(ee=>ee.id===H);J!==-1?u.value[J]={id:u.value[J].id,type:"ai",content:"⚠️ Connection error. Please check your internet and try again.",timestamp:new Date,failed:!0,lastPrompt:A,lastQuickAction:c}:u.value.push({id:Date.now(),type:"ai",content:"⚠️ Connection error. Please check your internet and try again.",timestamp:new Date,failed:!0,lastPrompt:A,lastQuickAction:c})};try{await se()}finally{M.value=null}}catch(te){console.error("Chat streaming error:",te),h.value=!1;const d=u.value.findIndex(o=>o.id===H);d!==-1?u.value[d]={id:u.value[d].id,type:"ai",content:"⚠️ Failed to start conversation. Please try again.",timestamp:new Date,failed:!0,lastPrompt:A,lastQuickAction:c}:u.value.push({id:Date.now(),type:"ai",content:"⚠️ Failed to start conversation. Please try again.",timestamp:new Date,failed:!0,lastPrompt:A,lastQuickAction:c})}},V=c=>{F(c)},I=c=>{E.value=c,console.log("Chat mode changed to:",c)},K=c=>{console.log("Message copied:",c)},X=(c,$)=>{console.log("Message rated:",c,$)},G=()=>{console.log("Starting new chat session..."),u.value=[],x.value=null,p.value="",console.log("New chat session started")},q=()=>{console.log("Chat deleted - refreshing main chat"),B()},r=()=>{console.log("Chat cleared - refreshing main chat"),u.value=[],x.value=null,B()},s=c=>{console.log("Retrying failed message:",c);const $=u.value.findIndex(A=>A.id===c.id);$!==-1&&u.value.splice($,1),c.lastQuickAction?F(c.lastQuickAction):c.lastPrompt&&(p.value=c.lastPrompt,F())},i=()=>{if(console.log("Stopping generation..."),M.value){try{M.value.cancel()}catch($){console.warn("Error cancelling stream:",$)}M.value=null}h.value=!1;const c=u.value[u.value.length-1];c&&c.type==="ai"&&c.isStreaming&&(c.isStreaming=!1,c.content+=`

*[Generation stopped by user]*`)},z=()=>{P.value=!P.value},Z=()=>{C.value=!C.value};return(c,$)=>(n(),f("div",Ya,[a("div",Za,[a("div",Ja,[t(e(v),{onClick:$[0]||($[0]=A=>_("exitChatMode")),variant:"ghost",size:"sm",class:"gap-1"},{default:l(()=>[t(e(be),{class:"h-4 w-4"}),$[6]||($[6]=g(" Exit Chat ",-1))]),_:1})]),a("div",eo,[t(e(de),{variant:"outline",class:"text-xs"},{default:l(()=>[g(y(c.writingQualityScore)+"% Quality ",1)]),_:1})])]),a("div",to,[a("div",so,[$[7]||($[7]=a("span",{class:"text-xs font-medium"},"Writing Progress",-1)),a("span",ao,y(Math.round(c.progressPercentage))+"% ("+y(c.currentWordCount)+" / "+y(c.targetWordCount)+" words)",1)]),t(e(Ke),{"model-value":c.progressPercentage,class:"h-1"},null,8,["model-value"])]),a("div",oo,[S.value&&!P.value?(n(),f("div",lo,[t(Le,{"is-minimized":!1,messages:u.value,"is-typing":h.value,"selected-text":c.selectedText,"chapter-content":c.chapterContent,"chapter-number":c.chapter.chapter_number,"current-mode":E.value,"project-slug":c.project.slug,"session-id":x.value||"temp-session","is-mobile":!0,onSendMessage:F,onQuickAction:V,onRetryMessage:s,onStopGeneration:i,onToggleMinimize:z,onChangeMode:I,onCopyMessage:K,onRateMessage:X,onNewSession:G,onChatDeleted:q,onChatCleared:r,input:p.value,"onUpdate:input":$[1]||($[1]=A=>p.value=A),class:"mobile-chat-overlay"},null,8,["messages","is-typing","selected-text","chapter-content","chapter-number","current-mode","project-slug","session-id","input"])])):T("",!0),a("div",no,[t(e(Tt),{class:"flex min-h-0 flex-1 flex-col rounded-none border-0 bg-transparent shadow-none"},{default:l(()=>[t(e(St),{class:"flex min-h-0 flex-1 flex-col space-y-4 p-6"},{default:l(()=>[a("div",ro,[a("div",io,[t(e(v),{onClick:Z,variant:C.value?"default":"ghost",size:"sm",class:"h-7 text-xs"},{default:l(()=>[C.value?(n(),D(e(ze),{key:0,class:"mr-1.5 h-3 w-3"})):(n(),D(e(Ct),{key:1,class:"mr-1.5 h-3 w-3"})),g(" "+y(C.value?"Edit":"Preview"),1)]),_:1},8,["variant"])]),Ee(t(e(we),{class:"min-h-0 flex-1"},{default:l(()=>[t(Ft,{"model-value":c.chapterContent,"onUpdate:modelValue":$[2]||($[2]=A=>_("update:chapterContent",A)),placeholder:"Start writing your chapter...","min-height":"400px",class:"text-lg leading-relaxed"},null,8,["model-value"])]),_:1},512),[[Ie,!C.value]]),Ee(t(e(we),{class:"min-h-0 flex-1"},{default:l(()=>[t(ge,{content:c.chapterContent,class:"p-4 text-lg",style:{"font-family":"'Times New Roman', serif","line-height":"1.6"}},null,8,["content"])]),_:1},512),[[Ie,C.value]])]),c.isGenerating?(n(),f("div",uo,[$[8]||($[8]=a("div",{class:"h-3 w-3 animate-spin rounded-full border-2 border-primary border-t-transparent"},null,-1)),a("span",co,y(c.generationProgress),1)])):T("",!0),a("div",po,[t(e(v),{onClick:$[3]||($[3]=A=>_("save",!1)),disabled:!c.isValid||c.isSaving,size:"sm"},{default:l(()=>[t(e($t),{class:"mr-1 h-3 w-3"}),g(" "+y(c.isSaving?"Saving...":"Save"),1)]),_:1},8,["disabled"]),t(e(v),{onClick:$[4]||($[4]=A=>_("save",!1)),disabled:!c.isValid||c.currentWordCount<c.targetWordCount*.8,size:"sm"},{default:l(()=>[t(e(Oe),{class:"mr-1 h-3 w-3"}),$[9]||($[9]=g(" Complete ",-1))]),_:1},8,["disabled"])])]),_:1})]),_:1})]),S.value?T("",!0):(n(),f("div",{key:1,class:N(["flex min-h-0 flex-col bg-muted/20 border-l transition-all duration-300 ease-in-out",P.value?"w-[60px]":"w-[600px] xl:w-[800px]"])},[t(Le,{"is-minimized":P.value,messages:u.value,"is-typing":h.value,"selected-text":c.selectedText,"chapter-content":c.chapterContent,"chapter-number":c.chapter.chapter_number,"current-mode":E.value,"project-slug":c.project.slug,"session-id":x.value||"temp-session",onSendMessage:F,onQuickAction:V,onRetryMessage:s,onStopGeneration:i,onToggleMinimize:z,onChangeMode:I,onCopyMessage:K,onRateMessage:X,onNewSession:G,onChatDeleted:q,onChatCleared:r,input:p.value,"onUpdate:input":$[5]||($[5]=A=>p.value=A)},null,8,["is-minimized","messages","is-typing","selected-text","chapter-content","chapter-number","current-mode","project-slug","session-id","input"])],2))])]))}});export{Ho as default};
