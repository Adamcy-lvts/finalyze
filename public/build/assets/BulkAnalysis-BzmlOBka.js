import{_ as ce}from"./AppLayout.vue_vue_type_script_setup_true_lang-Dq1JQEDv.js";import{_ as ue}from"./index-CFG1xxFQ.js";import{c as D,_ as k}from"./index-B8MfLIKH.js";import{_ as A,a as j}from"./CardContent.vue_vue_type_script_setup_true_lang-CvS13D9K.js";import{_ as M,a as $}from"./CardTitle.vue_vue_type_script_setup_true_lang-Dtj1h7eV.js";import{_ as de}from"./Checkbox.vue_vue_type_script_setup_true_lang-DU3A86Ze.js";import{_ as V}from"./Progress.vue_vue_type_script_setup_true_lang-CaOGjHp0.js";import{_ as me}from"./ScrollArea.vue_vue_type_script_setup_true_lang-DP_1lNp_.js";import{_ as pe}from"./WordBalanceDisplay.vue_vue_type_script_setup_true_lang-e7WZt-Tl.js";import{t as h}from"./index-CfcoRdXz.js";import{d as fe,y as f,a as R,q as _e,F as ve,C as y,o as c,E as r,H as l,u as s,K as o,O as I,R as he,J as C,P as _,M as u,c as m,Q as U,S as W,ad as P}from"./app-C0iaHDzA.js";import{_ as z}from"./SafeHtmlText.vue_vue_type_script_setup_true_lang-CXJM9EVf.js";import{_ as ye}from"./PurchaseModal.vue_vue_type_script_setup_true_lang-iMX0WhxZ.js";import{u as ge,r as xe}from"./useWordBalance-V6Hrq96D.js";import{A as be}from"./arrow-left-ddu-HSWc.js";import{B as we}from"./brain-h0cpawdQ.js";import{L as ke}from"./loader-circle-Ckfjc31V.js";import{P as Ce}from"./play-CeSspVxy.js";import{C as Be}from"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-DouIdNch.js";import"./UserInfo.vue_vue_type_script_setup_true_lang-XM7CyggX.js";import"./Presence-CRc-3ouu.js";import"./useForwardExpose-CSM5MnWw.js";import"./index-QcnTpKuz.js";import"./DialogTitle-BWlFjS2U.js";import"./x-D8_aAgCu.js";import"./TooltipTrigger.vue_vue_type_script_setup_true_lang-BKMm_IJw.js";import"./VisuallyHidden-DD6JSlZR.js";import"./coins-_qPwwdBp.js";import"./log-out-CMOHZ4dv.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-DRuKPbfW.js";import"./library-egeaEK78.js";import"./plus-ByuKSV2l.js";import"./chevron-right-CJecl17p.js";import"./sun-N1NK2akf.js";import"./nullish-CHIgUVhi.js";import"./isValueEqualOrExist-DSClXoPv.js";import"./ohash.D__AXeF1-C-E83dC9.js";import"./useFormControl-DfaHNq9n.js";import"./RovingFocusItem-DukNPlSL.js";import"./VisuallyHiddenInput-D_bYS2YG.js";import"./minus-Cyw4nabl.js";import"./check--aeEQYMB.js";import"./useNonce-5-lI7OtF.js";import"./purify.es-DxJI3Wx7.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-CIW5gWx4.js";import"./DialogDescription.vue_vue_type_script_setup_true_lang-CjUrEdle.js";import"./DialogFooter.vue_vue_type_script_setup_true_lang-DVMF9PkQ.js";import"./sparkles-DjpFunwX.js";import"./arrow-right-CvzGkgbN.js";/**
 * @license lucide-vue-next v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=D("RefreshCcwIcon",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]);/**
 * @license lucide-vue-next v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=D("ShieldAlertIcon",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]),Ae={class:"max-w-6xl mx-auto py-6 px-4 space-y-6"},je={class:"flex items-center justify-between"},Me={class:"flex items-center gap-3"},$e={class:"flex flex-wrap items-center gap-2"},Ie={class:"divide-y divide-border"},Pe={class:"flex-1"},ze={class:"flex items-center gap-2 text-sm font-medium"},Le={class:"text-muted-foreground"},Fe={class:"text-xs text-muted-foreground flex items-center gap-3"},qe={key:0},Ve={key:1,class:"text-amber-500 flex items-center gap-1"},Re={class:"flex items-center justify-between text-sm"},Ue={class:"font-medium"},We={class:"text-xs text-muted-foreground"},De={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},Je={class:"flex items-center justify-between text-sm font-medium mb-1"},Oe={key:0},Ee={class:"text-xs text-muted-foreground line-clamp-2"},Te={key:0,class:"mt-2"},He={class:"text-[11px] text-muted-foreground mt-1"},Ke={key:1,class:"text-xs text-muted-foreground mt-2"},Ot=fe({__name:"BulkAnalysis",props:{project:{}},setup(J){const p=J,B=t=>{const a=t.latest_analysis||t.latestAnalysis||null;return{id:Number(t.id),chapter_number:Number(t.chapter_number),title:t.title,word_count:Number(t.word_count||0),latest_analysis:a?{...a,total_score:Number(a.total_score??0),completion_percentage:Number(a.completion_percentage??0)}:null}},i=f(p.project.chapters?.map(B)||[]),n=f(i.value.map(t=>t.id)),g=f(!1),N=f(!1),x=f(null),d=f(null),b=f(null),{showPurchaseModal:O,requiredWordsForModal:E,actionDescriptionForModal:T,checkAndPrompt:H,closePurchaseModal:K,estimates:Q,balance:G,refreshBalance:X}=ge(),Y=()=>{if(typeof window>"u")return[];try{return JSON.parse(localStorage.getItem("chargedAnalysisBatches")||"[]")}catch{return[]}},S=f(new Set(Y())),Z=()=>{typeof window>"u"||localStorage.setItem("chargedAnalysisBatches",JSON.stringify([...S.value]))},ee=t=>{S.value.add(t),Z()},te=t=>t?S.value.has(Number(t)):!1,L=R(()=>n.value.length),ae=R(()=>{if(!d.value?.batch?.total_chapters)return 0;const t=d.value.batch.completed_chapters||0,a=d.value.batch.failed_chapters||0;return Math.round((t+a)/d.value.batch.total_chapters*100)}),F=async()=>{try{const{data:t}=await P.get(C("api.projects.analysis.results",p.project.slug));if(t.success&&t.chapters){i.value=t.chapters.map(B);const a=new Set(i.value.map(e=>e.id));n.value=n.value.filter(e=>a.has(e)),n.value.length===0&&(n.value=i.value.map(e=>e.id))}}catch(t){console.error("Failed to load analysis results",t),h.error("Could not load analysis results"),!i.value.length&&p.project.chapters?.length&&(i.value=p.project.chapters.map(B),n.value=i.value.map(a=>a.id))}},q=async()=>{if(!(!x.value||N.value)){N.value=!0;try{const{data:t}=await P.get(C("api.projects.analysis.batch",{project:p.project.slug,batch:x.value}));t.success&&(d.value=t,["completed","failed","cancelled"].includes(t.batch.status)&&(w(),h.success("Analysis finished"),t.batch.status==="completed"&&await le(t.batch),await F()))}catch(t){console.error("Polling failed",t),h.error("Failed to poll analysis status"),w()}finally{N.value=!1}}},se=()=>{w(),q(),b.value=window.setInterval(q,3e3)},w=()=>{b.value&&(clearInterval(b.value),b.value=null)};_e(()=>w());const le=async t=>{const a=Number(t?.id);if(!a||te(a))return;const e=Number(t?.consumed_words??t?.required_words??0);if(!(!e||Number.isNaN(e)))try{await xe(e,"Bulk chapter analysis","analysis_batch",a),ee(a),await X()}catch(v){console.error("Failed to record bulk analysis usage",v)}},oe=async()=>{if(n.value.length===0){h.error("Select at least one chapter to analyze");return}const t=i.value.length?Math.round(i.value.reduce((e,v)=>e+Math.max(500,v.word_count||0),0)/i.value.length):1500,a=Q.chapter(t)*n.value.length;if(H(a,"run bulk analysis")){g.value=!0;try{const{data:e}=await P.post(C("api.projects.analysis.start",p.project.slug),{chapter_ids:n.value});e.success?(x.value=e.batch_id,d.value=null,se(),h.success("Analysis started")):h.error(e.error||"Unable to start analysis")}catch(e){console.error("Failed to start analysis",e),h.error(e.response?.data?.error||"Failed to start analysis")}finally{g.value=!1}}},re=(t,a)=>{const e=Number(t);if(a===!0){n.value.includes(e)||(n.value=[...n.value,e]);return}n.value=n.value.filter(v=>v!==e)},ne=()=>{n.value=i.value.map(t=>t.id)},ie=()=>{n.value=[]};return ve(async()=>{await F()}),(t,a)=>(c(),y(ce,{title:"Bulk Analysis"},{default:r(()=>[l(s(pe),null,{default:r(()=>[o("div",Ae,[o("div",je,[o("div",Me,[l(s(k),{variant:"ghost",size:"icon",onClick:a[0]||(a[0]=e=>s(he).visit(s(C)("projects.show",p.project.slug)))},{default:r(()=>[l(s(be),{class:"h-4 w-4"})]),_:1}),o("div",null,[l(z,{as:"h1",class:"text-xl font-semibold text-foreground",content:p.project.title},null,8,["content"]),a[1]||(a[1]=o("p",{class:"text-sm text-muted-foreground"},"Run quality analysis across selected chapters",-1))])]),l(s(ue),{variant:"outline",class:"gap-2"},{default:r(()=>[l(s(we),{class:"h-4 w-4"}),a[2]||(a[2]=_(" Bulk Analysis ",-1))]),_:1})]),l(s(A),null,{default:r(()=>[l(s(M),{class:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between"},{default:r(()=>[l(s($),{class:"text-lg"},{default:r(()=>[...a[3]||(a[3]=[_("Chapters",-1)])]),_:1}),o("div",$e,[l(s(k),{size:"sm",variant:"outline",onClick:ne},{default:r(()=>[...a[4]||(a[4]=[_("Select All",-1)])]),_:1}),l(s(k),{size:"sm",variant:"ghost",onClick:ie},{default:r(()=>[...a[5]||(a[5]=[_("Clear",-1)])]),_:1}),l(s(k),{disabled:g.value,size:"sm",class:"gap-2",onClick:oe},{default:r(()=>[g.value?(c(),y(s(ke),{key:0,class:"h-4 w-4 animate-spin"})):(c(),y(s(Ce),{key:1,class:"h-4 w-4"})),_(" Start Analysis ("+u(L.value)+") ",1)]),_:1},8,["disabled"])])]),_:1}),l(s(j),null,{default:r(()=>[l(s(me),{class:"max-h-[480px]"},{default:r(()=>[o("div",Ie,[(c(!0),m(U,null,W(i.value,e=>(c(),m("div",{key:e.id,class:"flex items-center gap-3 py-3"},[l(s(de),{"model-value":n.value.includes(e.id),"onUpdate:modelValue":v=>re(e.id,v)},null,8,["model-value","onUpdate:modelValue"]),o("div",Pe,[o("div",ze,[o("span",Le,"Chapter "+u(e.chapter_number),1),l(z,{as:"span",content:e.title},null,8,["content"])]),o("div",Fe,[o("span",null,u(e.word_count||0)+" words",1),e.latest_analysis?(c(),m("span",qe," Last score: "+u(e.latest_analysis.total_score)+" ("+u(e.latest_analysis.completion_percentage)+"%) ",1)):(c(),m("span",Ve,[l(s(Se),{class:"h-3 w-3"}),a[6]||(a[6]=_(" Not analyzed yet ",-1))]))])])]))),128))])]),_:1})]),_:1})]),_:1}),x.value?(c(),y(s(A),{key:0},{default:r(()=>[l(s(M),null,{default:r(()=>[l(s($),{class:"flex items-center gap-2"},{default:r(()=>[l(s(Ne),{class:"h-4 w-4"}),a[7]||(a[7]=_(" Analysis Progress ",-1))]),_:1})]),_:1}),l(s(j),{class:"space-y-3"},{default:r(()=>[o("div",Re,[a[8]||(a[8]=o("span",null,"Status",-1)),o("span",Ue,u(d.value?.batch?.status||"running"),1)]),l(s(V),{"model-value":ae.value},null,8,["model-value"]),o("div",We," Completed: "+u(d.value?.batch?.completed_chapters||0)+" / "+u(d.value?.batch?.total_chapters||L.value),1)]),_:1})]),_:1})):I("",!0),i.value.some(e=>e.latest_analysis)?(c(),y(s(A),{key:1},{default:r(()=>[l(s(M),null,{default:r(()=>[l(s($),{class:"flex items-center gap-2"},{default:r(()=>[l(s(Be),{class:"h-4 w-4 text-green-500"}),a[9]||(a[9]=_(" Latest Results ",-1))]),_:1})]),_:1}),l(s(j),{class:"space-y-2"},{default:r(()=>[o("div",De,[(c(!0),m(U,null,W(i.value,e=>(c(),m("div",{key:`result-${e.id}`,class:"p-3 border rounded-lg"},[o("div",Je,[o("span",null,"Chapter "+u(e.chapter_number),1),e.latest_analysis?(c(),m("span",Oe,u(e.latest_analysis.total_score)+" pts ",1)):I("",!0)]),o("p",Ee,[l(z,{as:"span",content:e.title},null,8,["content"])]),e.latest_analysis?(c(),m("div",Te,[l(s(V),{"model-value":e.latest_analysis.completion_percentage},null,8,["model-value"]),o("div",He," Analyzed at "+u(new Date(e.latest_analysis.analyzed_at).toLocaleString()),1)])):(c(),m("div",Ke,"No analysis yet"))]))),128))])]),_:1})]),_:1})):I("",!0)]),l(ye,{open:s(O),"current-balance":s(G),"required-words":s(E),action:s(T),onClose:s(K)},null,8,["open","current-balance","required-words","action","onClose"])]),_:1})]),_:1}))}});export{Ot as default};
